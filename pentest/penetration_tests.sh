#!/bin/bash

# ========================================
# PENETRATION TEST SUITE
# The Glitch Dungeon Leaderboard API
# ========================================
# 
# USAGE:
#   1. Ersetze YOUR_NETLIFY_URL mit deiner echten URL
#   2. chmod +x penetration_tests.sh
#   3. ./penetration_tests.sh
#
# REQUIREMENTS:
#   - curl
#   - jq (optional, fÃ¼r schÃ¶nere JSON-Ausgabe)
# ========================================

API_URL="https://YOUR_NETLIFY_URL/.netlify/functions/leaderboard"

echo "=================================="
echo "ðŸ”´ PENETRATION TEST SUITE"
echo "=================================="
echo ""
echo "Target: $API_URL"
echo ""

# Farben fÃ¼r Output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

pass() {
  echo -e "${GREEN}âœ“ PASS${NC} - $1"
}

fail() {
  echo -e "${RED}âœ— FAIL${NC} - $1"
}

warn() {
  echo -e "${YELLOW}âš  WARN${NC} - $1"
}


# ========================================
# TEST 1: SQL/NoSQL Injection via Class Index
# ========================================
echo "----------------------------------------"
echo "TEST 1: NoSQL Injection (Class Index)"
echo "----------------------------------------"

# Test 1a: Negative Index
echo "Testing negative index..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Hacker","-1",10,100,50,1,0,0,"uid123"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Negative index rejected (HTTP $HTTP_CODE)"
else
  fail "Negative index accepted! (HTTP $HTTP_CODE)"
  echo "Response: $BODY"
fi

# Test 1b: Out of bounds
echo "Testing out-of-bounds index..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Hacker","999",10,100,50,1,0,0,"uid123"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Out-of-bounds index rejected (HTTP $HTTP_CODE)"
else
  fail "Out-of-bounds index accepted!"
fi

# Test 1c: String injection
echo "Testing string injection in class..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Hacker","constructor",10,100,50,1,0,0,"uid123"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "String injection in class rejected (HTTP $HTTP_CODE)"
else
  fail "String injection in class accepted!"
fi

echo ""


# ========================================
# TEST 2: XSS via Name Field
# ========================================
echo "----------------------------------------"
echo "TEST 2: XSS Injection (Name Field)"
echo "----------------------------------------"

# Test 2a: Script tag
echo "Testing <script> tag in name..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["<script>alert(1)</script>",0,10,100,50,1,0,0,"uid123"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if echo "$BODY" | grep -q "<script>"; then
  fail "XSS not sanitized! Script tag passed through"
  echo "Body: $BODY"
else
  pass "Script tag sanitized"
fi

# Test 2b: Event handler
echo "Testing event handler in name..."
RESPONSE=$(curl -s -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["<img src=x onerror=alert(1)>",0,10,100,50,1,0,0,"uid456"]}')

if echo "$RESPONSE" | grep -q "onerror"; then
  fail "Event handler not sanitized!"
else
  pass "Event handler sanitized"
fi

echo ""


# ========================================
# TEST 3: Rate Limiting / DoS
# ========================================
echo "----------------------------------------"
echo "TEST 3: Rate Limiting"
echo "----------------------------------------"

echo "Sending 15 rapid requests..."
BLOCKED=0
for i in {1..15}; do
  RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
    -H "Content-Type: application/json" \
    -d '{"data":["Spammer",0,10,100,50,1,0,0,"spam'$i'"]}')
  
  HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
  
  if [ "$HTTP_CODE" = "429" ]; then
    BLOCKED=$((BLOCKED + 1))
  fi
  
  # Kurze Pause um Server nicht zu Ã¼berlasten
  sleep 0.1
done

if [ $BLOCKED -gt 0 ]; then
  pass "Rate limiting active ($BLOCKED/15 requests blocked)"
else
  warn "No rate limiting detected - DoS vulnerability!"
fi

echo ""


# ========================================
# TEST 4: Input Validation
# ========================================
echo "----------------------------------------"
echo "TEST 4: Input Validation"
echo "----------------------------------------"

# Test 4a: Missing data
echo "Testing missing data field..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Missing data rejected (HTTP $HTTP_CODE)"
else
  fail "Missing data accepted!"
fi

# Test 4b: Wrong array length
echo "Testing wrong array length..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Name",0,10]}')  # Nur 3 statt 9 Elemente

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Wrong array length rejected (HTTP $HTTP_CODE)"
else
  fail "Wrong array length accepted!"
fi

# Test 4c: Negative values
echo "Testing negative depth..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Cheater",0,-999,100,50,1,0,0,"uid789"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Negative depth rejected (HTTP $HTTP_CODE)"
else
  fail "Negative depth accepted - cheating possible!"
fi

# Test 4d: Extreme values
echo "Testing extreme depth value..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{"data":["Cheater",0,999999,100,50,1,0,0,"uid999"]}')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "500" ]; then
  pass "Extreme depth rejected (HTTP $HTTP_CODE)"
else
  fail "Extreme depth accepted!"
fi

echo ""


# ========================================
# TEST 5: Memory DoS
# ========================================
echo "----------------------------------------"
echo "TEST 5: Memory Exhaustion"
echo "----------------------------------------"

# Test 5a: Huge payload
echo "Testing huge payload (10MB)..."
BIG_NAME=$(python3 -c "print('A' * 10000000)")
RESPONSE=$(curl -s -w "\n%{http_code}" -m 5 -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d "{\"data\":[\"$BIG_NAME\",0,10,100,50,1,0,0,\"uid\"]}" 2>/dev/null)

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
if [ "$HTTP_CODE" = "413" ] || [ "$HTTP_CODE" = "400" ]; then
  pass "Huge payload rejected (HTTP $HTTP_CODE)"
else
  warn "Huge payload might be accepted - check server logs"
fi

echo ""


# ========================================
# TEST 6: CORS / Origin Validation
# ========================================
echo "----------------------------------------"
echo "TEST 6: CORS Security"
echo "----------------------------------------"

# Test from malicious origin
echo "Testing with malicious origin..."
RESPONSE=$(curl -s -X POST "$API_URL" \
  -H "Origin: https://evil.com" \
  -H "Content-Type: application/json" \
  -d '{"data":["Evil",0,10,100,50,1,0,0,"uid"]}')

if echo "$RESPONSE" | grep -q "evil.com"; then
  fail "Malicious origin accepted in CORS!"
else
  pass "CORS properly restricted"
fi

echo ""


# ========================================
# TEST 7: HTTP Method Confusion
# ========================================
echo "----------------------------------------"
echo "TEST 7: HTTP Method Validation"
echo "----------------------------------------"

# Test PUT method
echo "Testing PUT method..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$API_URL")
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" = "405" ]; then
  pass "PUT method rejected (HTTP $HTTP_CODE)"
else
  warn "PUT method might be accepted (HTTP $HTTP_CODE)"
fi

# Test DELETE method
echo "Testing DELETE method..."
RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE "$API_URL")
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" = "405" ]; then
  pass "DELETE method rejected (HTTP $HTTP_CODE)"
else
  warn "DELETE method might be accepted (HTTP $HTTP_CODE)"
fi

echo ""


# ========================================
# TEST 8: GET Parameter Injection
# ========================================
echo "----------------------------------------"
echo "TEST 8: GET Parameter Validation"
echo "----------------------------------------"

# Test invalid class parameter
echo "Testing invalid class parameter..."
RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL?class=999")
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" = "400" ]; then
  pass "Invalid GET parameter rejected (HTTP $HTTP_CODE)"
else
  warn "Invalid GET parameter might be accepted"
fi

# Test SQL injection in GET
echo "Testing SQL injection in GET..."
RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL?class=0'+OR+'1'='1")
HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

if [ "$HTTP_CODE" = "400" ]; then
  pass "SQL injection in GET rejected (HTTP $HTTP_CODE)"
else
  warn "Check for SQL injection vulnerability"
fi

echo ""


# ========================================
# SUMMARY
# ========================================
echo "========================================"
echo "ðŸ“Š TEST SUMMARY"
echo "========================================"
echo ""
echo "Review the results above. All tests marked"
echo "with âœ— FAIL or âš  WARN need immediate attention!"
echo ""
echo "Recommended actions:"
echo "1. Fix all FAIL tests before going live"
echo "2. Investigate all WARN tests"
echo "3. Test again after fixes"
echo "4. Consider professional penetration testing"
echo ""
