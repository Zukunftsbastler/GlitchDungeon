<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Glitch Dungeon: Dark Descent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        :root {
            --bg-color: #050505;
            --text-color: #c5a059;
            --accent-color: #8a0b0b;
            --stone-color: #1a1a1a;
            --bits-color: #ffd700;
            --shadow-glow: 0 0 15px rgba(138, 11, 11, 0.4);
            --font-serif: 'Cormorant Garamond', serif;
            --font-display: 'Cinzel', serif;
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-serif); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0; padding: 10px; height: 100vh; overflow: hidden; user-select: none; }
        #start-screen { max-width: 800px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 2rem; animation: fadeIn 2s ease-in; position: absolute; z-index: 10; background: var(--bg-color); height: 100vh; justify-content: center; }
        h1 { font-family: var(--font-display); font-size: 4rem; margin: 0; color: var(--accent-color); text-shadow: 2px 2px 0px #000, 0 0 20px var(--accent-color); animation: pulse 4s infinite ease-in-out, unstable 0.15s infinite; }
        @media(max-width:480px){h1{font-size:2.5rem}}
        .narrative-box { background: var(--stone-color); padding: 2rem; border: 1px solid #333; border-radius: 4px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8), var(--shadow-glow); max-width: 600px; font-size: 1.3rem; line-height: 1.6; color: #ccc; position: relative; text-align: center; }
        .narrative-box::before, .narrative-box::after { content: "‚Ä†"; font-size: 2rem; color: var(--accent-color); display: block; margin: 0 auto; opacity: 0.7; }
        .narrative-box::before { margin-bottom: 0.5rem; }
        .narrative-box::after { margin-top: 0.5rem; transform: rotate(180deg); }
        .class-select { display: flex; gap: 20px; margin-top: 1rem; flex-wrap: wrap; justify-content: center; }
        .btn-class { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #888; padding: 15px; width: 140px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; gap: 5px; }
        .btn-class:hover { border-color: var(--accent-color); color: var(--text-color); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .c-name { font-family: var(--font-display); font-size: 1.2rem; color: var(--accent-color); }
        .c-desc { font-size: 0.8rem; line-height: 1.2; }
        footer { margin-top: auto; opacity: 0.5; font-size: 0.9rem; margin-bottom: 2rem; }
        a { color: var(--text-color); text-decoration: none; border-bottom: 1px dotted var(--text-color); }
        #game-wrapper { display: none; flex-direction: column; align-items: center; opacity: 0; transition: opacity 2s ease-in; }
        #ui-bar { width: 100%; max-width: 640px; display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 10px; font-family: var(--font-display); font-size: 18px; color: var(--text-color); border-bottom: 1px solid #333; padding-bottom: 5px; }
        .stat-row { width: 100%; display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8em; }
        canvas { border: 4px solid #1f1f1f; background: #000; image-rendering: pixelated; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); width: 100%; max-width: 100%; height: auto; }
        #ui-target { width: 100%; max-width: 640px; text-align: center; font-family: var(--font-display); font-size: 16px; margin-bottom: 5px; min-height: 20px; }
        #btn-reincarnate { display: block; background: #000; color: #8a0b0b; border: 1px solid #8a0b0b; padding: 8px 16px; font-family: var(--font-display); font-size: 1.1rem; cursor: pointer; box-shadow: 0 0 10px #8a0b0b; margin-top: 5px; pointer-events: auto; }
        #btn-reincarnate:hover { background: #8a0b0b; color: #000; }
        @keyframes pulse { 0%, 100% { text-shadow: 2px 2px 0px #000, 0 0 20px var(--accent-color); } 50% { text-shadow: 2px 2px 0px #000, 0 0 10px var(--accent-color); opacity: 0.9; } }
        @keyframes unstable { 0% { transform: translate(0,0); } 20% { transform: translate(-1px, 1px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, 0); } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0,0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #inv-screen { display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:95vw; max-width:540px; background:#0a0a0a; border:2px solid var(--accent-color); padding:20px; color:var(--text-color); font-family:var(--font-serif); z-index:100; box-shadow: 0 0 30px #000; box-sizing: border-box; }
        .inv-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-top:15px; }
        .inv-slot { height:70px; border:1px solid #333; background:#111; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; font-size:11px; text-align:center; position:relative; padding:2px; transition:border-color 0.2s; }
        .inv-slot:hover { border-color:#fff; background:#1a1a1a; }
        .inv-slot.equipped { border-color:var(--bits-color); box-shadow:0 0 5px var(--bits-color); }
        .inv-tooltip { position:absolute; bottom:105%; left:50%; transform:translateX(-50%); background:#050505; border:1px solid #555; padding:8px; width:180px; display:none; pointer-events:none; z-index:101; text-align:left; box-shadow:0 5px 15px rgba(0,0,0,0.8); }
        .inv-slot:hover .inv-tooltip { display:block; }
        .equip-slots { display:flex; gap:15px; justify-content:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px; }
        .equip-slot-label { font-size:10px; color:#666; text-transform:uppercase; margin-bottom:2px;}
        .btn-mode { background: #111; border: 1px solid #555; color: #ccc; padding: 10px; margin-bottom: 10px; text-align: center; cursor: pointer; font-family: var(--font-display); font-size: 1.2rem; transition: all 0.2s; user-select: none; }
        .btn-mode:hover { background: #222; border-color: #fff; }
        .mode-trash .inv-slot { border-color: #f00 !important; background: #211; }
        .mode-trash .inv-slot:hover { background: #411; cursor: not-allowed; }
        .mode-sell .inv-slot { border-color: #ffd700 !important; background: #221; }
        .mode-sell .inv-slot:hover { background: #442; cursor: alias; }
        #hud { width: 100%; max-width: 640px; background: #050505; border-top: 1px solid #333; display: grid; grid-template-columns: 120px 1fr; gap: 10px; padding: 10px; box-sizing: border-box; margin-top: 5px; font-family: var(--font-display); }
        #dpad { display: grid; grid-template-areas: ". u ." "l d r"; gap: 4px; }
        #dpad button { background: #111; border: 1px solid #444; color: #888; cursor: pointer; font-size: 1.2rem; padding:0; min-height: 48px; min-width: 48px; }
        #actions { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
        #actions button { background: #111; border: 1px solid #555; color: #ccc; font-size: 1.5rem; cursor: pointer; padding:0; display: flex; align-items: center; justify-content: center; min-height: 48px; }
        .stam-low { color: #f00 !important; text-shadow: 0 0 5px #f00; animation: pulse 0.5s infinite; }
        #actions button:active, #dpad button:active { border-color: var(--accent-color); color: var(--accent-color); }
        .disabled { filter: grayscale(1) brightness(0.3); pointer-events: none; border-color: #222 !important; }
        #tt { position:fixed; background:rgba(0,0,0,0.9); border:1px solid #888; padding:5px; pointer-events:none; display:none; z-index:100; font-size:12px; white-space:pre; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #8a0b0b; cursor: pointer; margin-top: -7px; border: 1px solid #c5a059; box-shadow: 0 0 8px #f00; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px; border: 1px solid #555; }
        input[type=range]:focus { outline: none; }
        #level-announcement { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; pointer-events: none; z-index: 50; opacity: 0; transition: opacity 1s; }
        .lvl-title { font-family: var(--font-display); font-size: 3rem; color: var(--accent-color); text-shadow: 0 0 20px #000; animation: pulse 2s infinite; }
        .lvl-hint { font-family: var(--font-serif); font-size: 1.4rem; color: #eee; text-shadow: 0 0 10px #000; margin-top: 5px; background: rgba(0,0,0,0.5); padding: 5px; display: inline-block; border-radius: 5px; }
    </style>
</head>
<body>
<div id="inv-screen">
    <div style="text-align:center;font-family:var(--font-display);font-size:1.5rem;color:var(--accent-color)">AUSR√úSTUNG</div>
    <div class="equip-slots" id="equip-display"></div>
    <div id="inv-mode-btn" onclick="cycleInvMode()" class="btn-mode">MODUS: AUSR√úSTEN</div>
    <div style="text-align:center;font-size:0.9rem;opacity:0.7">RUCKSACK</div>
    <div class="inv-grid" id="inv-display"></div>
</div>
<div id="start-screen">
    <h1>The Glitch Dungeon</h1>
    <div class="narrative-box">Die alten Mauern halten der Realit√§t nicht mehr stand. Die Zeit springt, R√§ume verschieben sich. Wirst du den Kern erreichen?</div>
    <div class="class-select" id="class-btns"></div>
    <footer>
        <span onclick="delSave()" style="cursor:pointer;border-bottom:1px dotted #8a0b0b;color:#8a0b0b;margin-right:15px">RESET</span>
        <a href="impressum.html" style="font-size:0.8rem; border-bottom:1px dotted #888; color:#888">Impressum</a>
    </footer>
</div>
<div id="game-wrapper">
    <div id="ui-bar">
        <div style="width:100%; display:flex; justify-content:space-between;">
            <div data-t="Dungeon-Tiefe">TIEFE: <span id="ui-lvl">1</span></div>
            <div data-t="Gesundheit">HP: <span id="ui-hp">10</span> <span id="ui-key"></span></div>
            <div style="color:#8a0b0b" data-t="Z√ºge bis zum Realit√§tsbruch">REALIT√ÑT: <span id="ui-glitch">20</span></div>
            <div style="color:var(--bits-color)" data-t="Gesammeltes Gold">GOLD: <span id="ui-bits">0</span></div>
            <div style="color:#f60" data-t="Ritual-Rollen (F)">BANNKREIS: <span id="ui-scrolls">0</span></div>
        </div>
        <div class="stat-row">
            <div style="color:#0af" data-t="Magische Energie">MANA: <span id="ui-mana">0/0</span></div>
            <div style="color:#dd0" data-t="Physische Ausdauer (Sinkt im Stealth!)">AUSDAUER: <span id="ui-stam">0/0</span></div>
            <div style="color:#aaa" data-t="Gew√§hlte Klasse">KLASSE: <span id="ui-class">-</span></div>
        </div>
    </div>
    <div id="ui-target">ZIEL: [Keines]</div>
    <div style="position:relative; width:100%; max-width:640px; aspect-ratio:1; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);">
        <canvas id="cvs" width="640" height="640" style="display:block;"></canvas>
        <div id="shop-ui" style="display:none; position:absolute; inset:0; flex-direction:column; justify-content:flex-end; padding-bottom:10px; pointer-events:none; z-index:20;">
            <div id="shop-footer" style="display:flex; flex-direction:column; align-items:center; background:rgba(0,0,0,0.95); padding:10px; border-top:1px solid #8a0b0b; pointer-events:auto; width:100%; box-sizing:border-box;">
                <div id="lvl-select" style="display:none; text-align:center; width:100%; margin-bottom:2px;">
                    <label style="color:#c5a059; font-family:var(--font-display); text-shadow:0 0 5px #000; font-size:0.9rem;">START: TIEFE <span id="lvl-val">1</span></label><br>
                    <input type="range" id="lvl-slider" min="1" max="1" value="1" oninput="document.getElementById('lvl-val').innerText=this.value" style="margin:5px 0;">
                </div>
                <button id="btn-reincarnate" onclick="respawn()">Reinkarnation</button>
            </div>
        </div>
    </div>
    <div id="hud">
        <div id="dpad">
            <button style="grid-area:u" onclick="act('U')" data-t="Hoch">‚ñ≤</button>
            <button style="grid-area:l" onclick="act('L')" data-t="Links">‚óÄ</button>
            <button style="grid-area:d" onclick="act('D')" data-t="Runter">‚ñº</button>
            <button style="grid-area:r" onclick="act('R')" data-t="Rechts">‚ñ∂</button>
        </div>
        <div id="actions">
            <button onclick="act('ATK')" data-t="Angriff (Richtung)">‚öîÔ∏è</button>
            <button id="btn-skill" onclick="act('SKILL')" data-t="Spezialf√§higkeit (B)">‚ö°</button>
            <button id="btn-item" onclick="act('ITEM')" data-t="Bannkreis (F)">üìú</button>
            <button onclick="act('WAIT')" data-t="Warten (Space)">‚è≥</button>
            <button onclick="act('INV')" data-t="Inventar (I)">üéí</button>
            <button onclick="act('HELP')" data-t="Hilfe">?</button>
        </div>
    </div>
    <div id="level-announcement"></div>
    <div id="tt"></div>
</div>

<script>
const $=id=>document.getElementById(id);
const esc=s=>(s+'').replace(/[<>"'&]/g,c=>({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c]));
const TILE=32,GRID=20,UI={lvl:$('ui-lvl'),hp:$('ui-hp'),key:$('ui-key'),glitch:$('ui-glitch'),bits:$('ui-bits'),scrolls:$('ui-scrolls'),mana:$('ui-mana'),stam:$('ui-stam'),cls:$('ui-class'),target:$('ui-target')};
let actx; function au(){if(!actx){actx=new(window.AudioContext||window.webkitAudioContext)();actx.resume()}}
const CVS=$('cvs'),CTX=CVS.getContext('2d'),L_CVS=document.createElement('canvas');L_CVS.width=640;L_CVS.height=640;const L_CTX=L_CVS.getContext('2d');
const C={BG:'#050505',WALL:'#2a2a2a',FLOOR:'#111111',PL:'#e3d5b8',BITS:'#ffd700'};

// --- BIOME CONFIG ---
// Tile-Typen: 0=Boden, 1=Wand, 2=Eis, 3=Morast(langsam), 4=Lava, 5=Astral, 6=T√ºmpel(Gift), 7=Kristall, 8=Leere, 9=Labyrinth, 10=Chaos
const BIOMES=[
 {n:"KATAKOMBEN",hint:"Massive W√§nde.",c:['#444','#222','#000','#888'],f:(x,y)=>Math.random()<0.2?1:0,hp:10,mobs:['SKEL','RAT','SPIDER']},
 {n:"EISH√ñHLE",hint:"Rutschig!",c:['#8ff','#004','#002','#aff'],f:(x,y)=>Math.sin(x/2)*Math.cos(y/2)>0.2?1:(Math.random()<0.6?2:0),hp:12,mobs:['GOLEM','WRAITH','ELEMENTAL']},
 {n:"SUMPF",hint:"Z√§her Morast.",c:['#462','#230','#120','#682'],f:(x,y)=>Math.sin(x/3)*Math.cos(y/3)>0.6?1:(Math.random()<0.35?3:(Math.random()<0.15?6:0)),hp:10,mobs:['SLIME','SNAKE','BAT']},
 {n:"VULKAN",hint:"Meide die Lava!",c:['#611','#300','#200','#f40'],f:(x,y)=>Math.sin(x/2)+Math.cos(y/2)>1.2?1:(Math.random()<0.2?4:0),hp:15,mobs:['GOLEM','ELEMENTAL','EYE']},
 {n:"ASTRAL",hint:"Instabil.",c:['#f0f','#000','#0f0','#f0f'],f:(x,y)=>Math.random()<0.3?1:(Math.random()<0.4?5:0),hp:8,mobs:['MIMIC','EYE','GHOST']},
 {n:"NEKRO",hint:"Der Tod lauert.",c:['#2f2','#111','#020','#0f0'],f:(x,y)=>Math.abs(Math.sin(x/4)*Math.cos(y/4))>0.5?1:0,hp:12,mobs:['SKEL','WRAITH','GHOST'],fx:'NEKRO'},
 {n:"KRISTALL",hint:"Harte Schale.",c:['#c0f','#203','#102','#e0f'],f:(x,y)=>(x%2===0&&y%2===0)?1:(Math.random()<0.3?7:0),hp:20,mobs:['ELEMENTAL','GOLEM']},
 {n:"LEERE",hint:"Nicht fallen!",c:['#333','#000','#000','#fff'],f:(x,y)=>Math.random()<0.15?8:(Math.random()<0.3?1:0),hp:10,mobs:['WRAITH','EYE']},
 {n:"LABYRINTH",hint:"Verwirrend.",c:['#555','#333','#111','#aaa'],f:(x,y)=>(Math.sin(x)>0)^(Math.cos(y)>0)?1:(Math.random()<0.2?9:0),hp:15,mobs:['RAT','SPIDER','MIMIC']},
 {n:"CHAOS",hint:"?!?",c:['#f0f','#0f0','#00f','#ff0'],f:(x,y)=>Math.random()<0.25?1:(Math.random()<0.5?(2+Math.floor(Math.random()*9)):0),hp:10,mobs:['MIMIC','GHOST','SNAKE'],fx:'CHAOS'}
];
const BESTIARY={
 SKEL:{n:'Skelett',ai:'SLEEP',st:[1,1,1,1]},SLIME:{n:'Schleim',ai:'PATROL',st:[0.8,0.8,0.8,0.8]},
 BAT:{n:'Fledermaus',ai:'PATROL',st:[0.5,0.5,1.5,0.5]},GOLEM:{n:'Golem',ai:'SLEEP',st:[2.5,1.5,0.5,2]},
 GHOST:{n:'Geist',ai:'PATROL',st:[0.8,1.2,0.8,1.2]},SPIDER:{n:'Spinne',ai:'PATROL',st:[0.6,1.2,1.2,0.8]},
 RAT:{n:'Ratte',ai:'PATROL',st:[0.5,0.5,1.5,0.5]},SNAKE:{n:'Schlange',ai:'PATROL',st:[0.8,1.5,1.0,1]},
 EYE:{n:'Auge',ai:'PATROL',st:[1.2,1.5,0.8,1.5]},MIMIC:{n:'Mimic',ai:'SLEEP',st:[1.5,2,0.8,2]},
 WRAITH:{n:'Schatten',ai:'PATROL',st:[1.2,1.5,1.2,1.5]},ELEMENTAL:{n:'Elementar',ai:'PATROL',st:[2,1.5,0.8,1.8]}
};
const ADJ_DATA={
 "Winzig":{hp:0.7,col:'#8b4513'},"Uralt":{hp:1.3,dmg:0.8,col:'#888'},"Verflucht":{hp:0.8,dmg:1.2,col:'#800080',fx:'CURSE'},
 "Giftig":{col:'#0f0',fx:'POISON'},"Brennend":{dmg:1.5,col:'#f40',fx:'BURN'},"Eisig":{hp:1.2,col:'#0ff',fx:'FREEZE'},
 "Dunkel":{sight:12,col:'#333'},"Riesig":{hp:2.0,spd:0.8,col:'#555'},"Flink":{spd:1.5,hp:0.6,col:'#ff0'},
 "Wild":{spd:1.2,dmg:1.2,col:'#f00'},"Hungrig":{fx:'LIFESTEAL',col:'#a00'},"Goldener":{hp:1.5,col:'#ffd700',fx:'RICH'}
};
const ADJ=Object.keys(ADJ_DATA);

const TILE_FX={
 // 2: Eis - Gleiten (Eish√∂hle)
 2:(p,dx,dy)=>{p.slide=true;p.slideDir={x:dx,y:dy};addParticle(p.x,p.y,'~','#aff',0.3);},
 // 3: Morast - Verlangsamt (kostet extra Energy, nicht Ausdauer!)
 3:(p)=>{game.p.energy-=30;addParticle(p.x,p.y,'Z√ÑHER BODEN','#5c4033',0.5);},
 // 4: Lava - Brennender Boden (Vulkan) - garantierter aber niedriger Schaden
 4:(p)=>{if(!p.lavaCD){hurt(game.p,1,true,'HEISS!','#f40');p.lavaCD=3;addParticle(p.x,p.y,'üî•','#f60',0.5);}},
 // 5: Astral - Instabiler Boden (zuf√§lliger Mini-Teleport 1-2 Felder)
 5:(p)=>{if(Math.random()<0.25){let ox=p.x,oy=p.y,tries=10;do{p.x=Math.max(1,Math.min(GRID-2,ox+rnd(-2,2)));p.y=Math.max(1,Math.min(GRID-2,oy+rnd(-2,2)));tries--;}while((game.map[p.y][p.x]===1||game.enemies.some(e=>e.x===p.x&&e.y===p.y))&&tries>0);if(tries<=0){p.x=ox;p.y=oy;}else{sfx('glitch');addParticle(ox,oy,'SHIFT','#f0f');addParticle(p.x,p.y,'!','#f0f');}}},
 // 6: T√ºmpel (Sumpf) - 30% Chance auf Gift
 6:(p)=>{if(Math.random()<0.3&&game.timers.poison<=0){game.timers.poison=15;sfx('hit');addParticle(p.x,p.y,'VERGIFTET!','#0f0');}else if(game.timers.poison<=0){addParticle(p.x,p.y,'GLIBBER','#4a2',0.3);}},
 // 7: Kristall - Reflektion (Gegner sehen dich fr√ºher)
 7:(p)=>{game.crystalVision=3;addParticle(p.x,p.y,'*','#e0f',0.2);},
 // 8: Leere - Langsamer Fall (kostet extra Zug, kein Schaden)
 8:(p)=>{if(!p.falling){p.falling=true;addParticle(p.x,p.y,'SCHWEBEN...','#fff');game.p.energy-=50;}else{p.falling=false;addParticle(p.x,p.y,'LANDUNG','#888');}},
 // 9: Labyrinth - Verwirrung (Richtung wird manchmal gedreht)
 9:(p)=>{if(Math.random()<0.2){game.confused=2;addParticle(p.x,p.y,'???','#ff0');}},
 // 10: Chaos - Random Effekt (nur positiv oder neutral, nie t√∂dlich)
 10:(p)=>{let r=rnd(1,6);if(r===1){meta.hp=Math.min(meta.hp+1,game.stats.maxHp);addParticle(p.x,p.y,'+1HP','#0f0');}else if(r===2){meta.mana=Math.min(meta.mana+3,game.stats.maxMana);addParticle(p.x,p.y,'+MANA','#0af');}else if(r===3){meta.stam=Math.min(meta.stam+2,game.stats.maxStam);addParticle(p.x,p.y,'+STAM','#ff0');}else if(r===4){game.timers.glitch+=2;addParticle(p.x,p.y,'+ZEIT','#f0f');}else if(r===5){sfx('glitch');addParticle(p.x,p.y,'CHAOS!','#f0f');}else{addParticle(p.x,p.y,'...','#888');}}
};

// --- DATA ---
const CLASSES={
 WARRIOR:{n:'Krieger',hp:20,mana:0,stam:10,mine:10,noise:10,spd:8,item:'Schwert',desc:'Robust, Laut'},
 ROGUE:{n:'Schurke',hp:12,mana:0,stam:15,mine:3,noise:2,spd:15,item:'Dolch',desc:'Schnell, Leise'},
 MAGE:{n:'Magier',hp:8,mana:20,stam:8,mine:1,noise:5,spd:10,item:'Stab',desc:'Weise, Fragil'}
};
const I_MATS=[{n:"Holz",m:0.5,c:'#a65',b:{stamCost:-1}},{n:"Eisen",m:1.0,c:'#ccc'},{n:"Stahl",m:1.5,c:'#fff'},{n:"Obsidian",m:2.0,c:'#404',b:{critChance:0.05}},{n:"Mithril",m:3.0,c:'#0ff',b:{stamCost:-2}},{n:"Adamant",m:5.0,c:'#0f0'},{n:"Licht",m:8.0,c:'#ff0',b:{torchRadius:50}},{n:"Arkan",m:15.0,c:'#f0f',b:{manaRegen:1}},{n:"Gold",m:1.2,c:'#ffd700',b:{lootMul:0.2}},{n:"Vampirisch",m:2.0,c:'#800',b:{lifesteal:0.1}}];
const I_TYPES=[{n:["Dolch","Kris"],target:'ROGUE',s:"WEAPON",baseCost:20,mods:{dmg:2,speed:2,stealthCost:-1}},{n:["Schwert","Langschwert"],target:'WARRIOR',s:"WEAPON",baseCost:40,mods:{dmg:4,maxStam:4}},{n:["Axt","Beil"],target:'WARRIOR',s:"WEAPON",baseCost:60,mods:{dmg:6,speed:-2,maxStam:4}},{n:["Hammer","Keule"],target:'WARRIOR',s:"WEAPON",baseCost:70,mods:{dmg:8,speed:-4,maxStam:4}},{n:["Stab","Zepter"],target:'MAGE',s:"WEAPON",baseCost:30,mods:{dmg:2,maxMana:10,spellDmg:2}},{n:["Hacke","Pickel"],target:'ALL',s:"WEAPON",baseCost:30,mods:{dmg:1,mine:4,speed:-1}},{n:["Robe"],target:'MAGE',s:"ARMOR",baseCost:40,mods:{def:0,maxMana:10,manaRegen:0.2}},{n:["Leder"],target:'ROGUE',s:"ARMOR",baseCost:60,mods:{def:1,dodgeChance:0.05}},{n:["Platte"],target:'WARRIOR',s:"ARMOR",baseCost:100,mods:{def:3,speed:-4,noise:5}},{n:["Ring"],target:'ALL',s:"RELIC",baseCost:50,mods:{shopLuck:5}},{n:["Amulett"],target:'ALL',s:"RELIC",baseCost:80,mods:{critChance:0.02}}];
const I_SUFFIX=[{n:"des Blutes",stat:"lifesteal",v:0.05},{n:"des Windes",stat:"dodgeChance",v:0.05},{n:"des Zorns",stat:"critChance",v:0.05},{n:"der Gier",stat:"lootMul",v:0.2},{n:"des Lichts",stat:"torchRadius",v:30},{n:"der Zeit",stat:"glitchMod",v:5}];
const R_NAMES=["Abgenutzt","Alt","Solide","Raffiniert","Edel","Meisterhaft","K√∂niglich","Mystisch","Legend√§r","G√∂ttlich","EWIG"];
const RARITIES=R_NAMES.map((n,i)=>({name:n,mul:1+i*0.8,chance:Math.max(0.1,50/Math.pow(2,i)),col:i===R_NAMES.length-1?'RAINBOW':`hsl(${40},${20+(i/10)*80}%,${50+i*2}%)`}));
const R_MAP=RARITIES.reduce((a,c)=>{a[c.name]=c;return a},{});
const ITEM_POOL=[
 {name:'Heiltrank',vis:'POTION',baseCost:10,unit:'HP',calc:t=>(5*t.mul)|0,run:(m,v)=>m.hp=Math.min(m.hp+v,game.stats.maxHp)},
 {name:'Manatrank',vis:'POTION',baseCost:15,unit:'MANA',calc:t=>(10*t.mul)|0,run:(m,v)=>m.mana=Math.min(m.mana+v,game.stats.maxMana)},
 {name:'Vitalit√§t',vis:'POTION',baseCost:40,unit:'MAXHP',calc:t=>(2*t.mul)|0,run:(m,v)=>{m.maxHp+=v;m.hp+=v;calcStats()}},
 {name:'Sch√§rfe',vis:'WEAPON',baseCost:60,unit:'DMG',calc:t=>(1*t.mul)|0,run:(m,v)=>{m.dmg+=v;calcStats()}},
 {name:'Gl√ºck',vis:'RELIC',baseCost:100,unit:'LUCK',calc:t=>(1*t.mul)|0,run:(m,v)=>{m.shopLuck+=v;calcStats()}},
 {name:'Rucksack',vis:'CHEST',baseCost:150,unit:'SLOT',calc:t=>Math.max(1,t.mul|0),run:(m,v)=>{m.shopSlots=Math.min(9,m.shopSlots+v);calcStats()}},
 {name:'Ritual',vis:'KEY',baseCost:30,unit:'TIME',calc:t=>(3*t.mul)|0,run:(m,v)=>{m.glitchMod+=v;calcStats()}},
 {name:'Pr√§zision',vis:'WEAPON',baseCost:80,unit:'%',calc:t=>parseFloat((0.02*t.mul).toFixed(2)),run:(m,v)=>{m.critChance+=v;calcStats()}},
 {name:'Reflexe',vis:'ARMOR',baseCost:80,unit:'%',calc:t=>parseFloat((0.02*t.mul).toFixed(2)),run:(m,v)=>{m.dodgeChance+=v;calcStats()}},
 {name:'Gier',vis:'CHEST',baseCost:70,unit:'%',calc:t=>parseFloat((0.1*t.mul).toFixed(1)),run:(m,v)=>{m.lootMul+=v;calcStats()}},
 {name:'Bannkreis',vis:'RELIC',baseCost:50,unit:'ROLLE',calc:t=>Math.max(1,1*t.mul|0),run:(m,v)=>m.scrolls=(m.scrolls||0)+v},
 {name:'Fackelschein',vis:'RELIC',baseCost:40,unit:'LUMEN',calc:t=>(30*t.mul)|0,run:(m,v)=>{m.torchRadius=(m.torchRadius||150)+v;calcStats()}},
 {name:'Lichtbringer',vis:'RELIC',baseCost:80,unit:'FACKEL',calc:t=>Math.max(1,1*t.mul|0),run:(m,v)=>{m.torchCount=(m.torchCount||2)+v;calcStats()}},
 {name:'Abh√§rtung',vis:'BOOK',baseCost:120,unit:'DEF',calc:t=>parseFloat((t.mul*0.2).toFixed(1)),run:(m,v)=>{m.def=(m.def||0)+v;calcStats()}},
 {name:'Stille',vis:'BOOK',baseCost:100,unit:'NOISE',calc:t=>Math.ceil(t.mul*0.5),run:(m,v)=>{m.noise=Math.max(0,m.noise-v);calcStats()}},
 {name:'Kondition',vis:'BOOK',baseCost:90,unit:'REG',calc:t=>parseFloat((t.mul*0.1).toFixed(2)),run:(m,v)=>{m.stamRegen=(m.stamRegen||1)+v;calcStats()}},
 {name:'Meditation',vis:'BOOK',baseCost:90,unit:'REG',calc:t=>parseFloat((t.mul*0.1).toFixed(2)),run:(m,v)=>{m.manaRegen=(m.manaRegen||0)+v;calcStats()}},
 {name:'Bergbau',vis:'BOOK',baseCost:80,unit:'PWR',calc:t=>Math.floor(t.mul*0.5),run:(m,v)=>{m.mine+=v;calcStats()}},
 {name:'Chronos-Anker',vis:'RELIC',baseCost:60,unit:'RUNDEN',calc:t=>Math.ceil(t.mul*2),run:(m,v)=>{let it={id:Math.random(),name:'Chronos-Anker',slot:'RELIC',col:'#0ff',mods:{glitchMod:v}};if(game.inventory.length<10){game.inventory.push(it);addParticle(game.p.x,game.p.y,"ANKER!",'#0ff');}else{game.items.push({x:game.p.x,y:game.p.y,type:'EQUIP',val:it});addParticle(game.p.x,game.p.y,"BODEN!",'#fff');}}},
 {name:'Fokus',vis:'BOOK',baseCost:80,unit:'RUNDEN',calc:t=>Math.ceil(t.mul*1.5),run:(m,v)=>{m.glitchMod=(m.glitchMod||0)+v;calcStats()}},
 {name:'Arkane Macht',vis:'BOOK',baseCost:100,unit:'PWR',calc:t=>(1*t.mul)|0,run:(m,v)=>{m.spellDmg=(m.spellDmg||0)+v;calcStats()}},
 {name:'Schattenkunst',vis:'BOOK',baseCost:90,unit:'EFF',calc:t=>Math.ceil(t.mul*0.5),run:(m,v)=>{m.stealthDrain=Math.max(1,m.stealthDrain-v);calcStats()}}
];

// --- STATE ---
let meta={bits:0,hp:10,maxHp:10,mana:10,maxMana:10,stam:10,maxStam:10,dmg:1,mine:1,noise:5,speed:10,def:0,manaRegen:0,stamRegen:1,class:'WARRIOR',critChance:0.05,dodgeChance:0.05,lootMul:1.0,glitchMod:0,scrolls:0,torchCount:2,torchRadius:150,maxLvl:1,shopSlots:3,shopLuck:0,lockedItems:[],spellDmg:0,stealthCost:5,stealthDrain:3};
if(localStorage.getItem('GD4_Dark_Save')){try{let s=JSON.parse(localStorage.getItem('GD4_Dark_Save'));meta.bits=s.bits;meta.maxLvl=s.maxLvl;meta.shopSlots=s.shopSlots;meta.shopLuck=s.shopLuck;}catch(e){localStorage.removeItem('GD4_Dark_Save');}}
let game={invMode:0,mode:'GAME',map:[],walls:new Uint8Array(GRID*GRID),level:1,biome:0,p:{x:1,y:1,en:0,dir:{x:0,y:1},hidden:false,lavaCD:0,falling:false,slide:false,slideDir:null},enemies:[],items:[],particles:[],shopItems:[],torches:[],inventory:[],equipment:{WEAPON:null,ARMOR:null,RELIC:null},stats:{},key:{x:0,y:0},exit:{x:0,y:0},timers:{glitch:25,stun:0,shake:0,poison:0,burn:0},lockMode:false,rerollCost:10,lockInput:false,aiming:false,mouse:{x:0,y:0},confused:0,crystalVision:0};

// --- LOGIC ---
const cb=$('class-btns');
Object.keys(CLASSES).forEach(k=>{let c=CLASSES[k];cb.innerHTML+=`<div class="btn-class" onclick="enterDungeon('${k}')"><span class="c-name">${esc(c.n)}</span><span class="c-desc">${esc(c.desc)}</span></div>`;});

function enterDungeon(k){
 let c=CLASSES[k];Object.assign(meta,{class:k,hp:c.hp,maxHp:c.hp,mana:c.mana,maxMana:c.mana,stam:c.stam,maxStam:c.stam,mine:c.mine,noise:c.noise,speed:c.spd,dmg:1});
 let startItem={id:Math.random(),name:'Start '+c.item,target:k,slot:'WEAPON',col:'#aaa',mods:{dmg:2}};
 if(k==='MAGE')startItem.mods={dmg:1,maxMana:5};if(k==='ROGUE')startItem.mods={dmg:2,speed:2};
 $('start-screen').style.opacity=0;
 setTimeout(()=>{$('start-screen').style.display='none';let gw=$('game-wrapper');gw.style.display='flex';void gw.offsetWidth;gw.style.opacity='1';initGame(startItem);},800);
}
function initGame(s){game.inventory=[];game.equipment={WEAPON:s||null,ARMOR:null,RELIC:null};calcStats();startLevel(1);requestAnimationFrame(loop);}
function startLevel(lvl){
 $('shop-ui').style.display='none';
 if(lvl>game.level){meta.mana=Math.min(game.stats.maxMana,meta.mana+(game.stats.maxMana/3)|0);addParticle(game.p.x,game.p.y,"MANA +",'#0af');}
 game.level=lvl;if(lvl>meta.maxLvl){meta.maxLvl=lvl;save();}
 game.biome=(Math.floor((lvl-1)/5))%BIOMES.length;let B=BIOMES[game.biome];
 document.documentElement.style.setProperty('--accent-color',B.c[3]);
 let el=$('level-announcement');el.innerHTML=`<div class="lvl-title">${B.n}</div><div class="lvl-hint">${B.hint||""}</div>`;el.style.opacity=1;setTimeout(()=>el.style.opacity=0,4000);
 C.WALL=B.c[0];C.FLOOR=B.c[1];C.MUD=B.c[2];C.PL=B.c[3];
 game.p.hasKey=false;game.p.hidden=false;game.p.lavaCD=0;game.p.falling=false;game.p.slide=false;game.p.slideDir=null;game.confused=0;game.crystalVision=0;game.nekroTimer=0;game.timers={glitch:15+(game.stats.glitchMod||0),stun:0,shake:0,poison:0,burn:0,curse:0};game.glitchCount=0;
 game.enemies=[];game.items=[];game.particles=[];game.torches=[];game.walls.fill(0);
 meta.hp=Math.min(meta.hp,game.stats.maxHp);if(meta.hp<=0)meta.hp=game.stats.maxHp;
 game.map=[];
 for(let y=0;y<GRID;y++){let r=[];for(let x=0;x<GRID;x++){if(x===0||x===GRID-1||y===0||y===GRID-1){r.push(1);game.walls[y*GRID+x]=99;}else{let t=B.f(x,y);if(x===1&&y===1)t=0;if(t===1)game.walls[y*GRID+x]=Math.min(20,B.hp+lvl);r.push(t);}}game.map.push(r);}
 
 let getRndPos=()=>{let x,y;do{x=rnd(1,GRID-2);y=rnd(1,GRID-2);}while(x===1&&y===1);return {x,y}};
 game.key=getRndPos();game.exit=getRndPos();
 
 function carvePath(x1,y1,x2,y2){
  let x=x1,y=y1,dx=Math.sign(x2-x1),dy=Math.sign(y2-y1);
  let steps=0;
  while((x!==x2||y!==y2)&&steps<100){
   if(x!==x2)x+=dx;else if(y!==y2)y+=dy;
   if(game.map[y][x]===1)game.walls[y*GRID+x]=5;
   else if(game.map[y][x]!==1)game.map[y][x]=0;
   steps++;
  }
 }
 game.map[game.key.y][game.key.x]=0;game.walls[game.key.y*GRID+game.key.x]=0;
 game.map[game.exit.y][game.exit.x]=0;game.walls[game.exit.y*GRID+game.exit.x]=0;
 carvePath(1,1,game.key.x,game.key.y);carvePath(game.key.x,game.key.y,game.exit.x,game.exit.y);
 spawnActors();updateUI();
}
function spawnActors(){
 let getFree=()=>{let x,y,t=0;do{x=rnd(1,GRID-2);y=rnd(1,GRID-2);t++}while(((game.map[y][x]===1&&game.walls[y*GRID+x]>5)||(x==1&&y==1))&&t<200);return {x,y}};
 game.p.energy=100;game.p.actNoise=0;meta.mana=game.stats.maxMana;game.lockInput=false;
 let B=BIOMES[game.biome],cnt=2+(game.level/2|0);
 for(let i=0;i<cnt;i++){
  let pos=getFree(),pow=rnd(game.level*0.8,game.level*1.3),key=B.mobs[rnd(0,B.mobs.length-1)],type=BESTIARY[key];
  let hp=(Math.max(1,(2+pow*1.2+Math.sqrt(pow)*2)*type.st[0])|0),dmg=(Math.max(1,(1+pow*0.25)*type.st[1])|0),spd=(Math.max(1,10*type.st[2])|0);
  let hue=rnd(0,360),adj=ADJ[rnd(0,ADJ.length-1)],ad=ADJ_DATA[adj];
  if(B.n==="EISH√ñHLE")hue=200;if(B.n==="VULKAN")hue=0;if(B.n==="SUMPF")hue=100;if(B.n==="NEKRO")hue=120;
  game.enemies.push({x:pos.x,y:pos.y,hp:(hp*(ad.hp||1))|0,max:(hp*(ad.hp||1))|0,dmg:(dmg*(ad.dmg||1))|0,bits:((15+pow*10)*type.st[3]*game.stats.lootMul)|0,hue,type:key,col:ad.col,fx:ad.fx,sight:ad.sight||6,name:`${adj} ${type.n}`,energy:rnd(0,50),speed:(spd*(ad.spd||1))|0,state:type.ai});
 }
 for(let i=0;i<3;i++){let p=getFree();game.items.push(Math.random()<0.3?{x:p.x,y:p.y,type:'EQUIP',val:genItem(game.level)}:{x:p.x,y:p.y,type:rnd(0,3)});}
 for(let i=0;i<(game.stats.torchCount||2);i++)game.torches.push(getFree());
}
function hurt(e,dmg,isP,txt,col){
 if(isP)meta.hp-=dmg;else e.hp-=dmg;
 sfx('hit');addParticle(e.x,e.y,txt||`-${dmg}`,col||(isP?'#f00':'#fff'));
 if(isP){game.timers.shake=5;updateUI();if(meta.hp<=0)triggerGameOver();}
 else{e.state='HUNT';if(e.hp<=0){game.enemies=game.enemies.filter(x=>x!==e);meta.bits+=e.bits;addParticle(e.x,e.y,`+${e.bits}`,C.BITS);sfx('kill');if(e.fx==='RICH'){game.items.push({x:e.x,y:e.y,type:'EQUIP',val:genItem(game.level+2)});addParticle(e.x,e.y,"JACKPOT!",'#ffd700');}}}
}
function movePlayer(dx,dy){
 // Labyrinth-Verwirrung: Richtung kann sich drehen
 if(game.confused>0){let r=rnd(1,4);if(r===1)[dx,dy]=[-dx,-dy];else if(r===2)[dx,dy]=[dy,-dx];else if(r===3)[dx,dy]=[-dy,dx];game.confused--;if(game.confused===0)addParticle(game.p.x,game.p.y,'KLAR!','#fff');}
 game.p.actNoise=1;let nx=game.p.x+dx,ny=game.p.y+dy;game.p.dir={x:dx||game.p.dir.x,y:dy||game.p.dir.y};
 // Lava-Cooldown reduzieren
 if(game.p.lavaCD>0)game.p.lavaCD--;
 if(game.map[ny][nx]===1){
  let wid=ny*GRID+nx;
  if(game.walls[wid]>0){
   if(game.p.hidden){addParticle(game.p.x,game.p.y,"Psst...",'#555');return false;}
   let cost=Math.max(0,2+(game.stats.stamCost||0));if(meta.stam<cost){addParticle(game.p.x,game.p.y,"M√úDE!",'#555');return false;}
   meta.stam-=cost;game.exert=1;game.p.actNoise=3;
   let dmg=(game.stats.mine||meta.mine);
   if(game.walls[wid]<=dmg){game.walls[wid]=0;sfx('step');game.map[ny][nx]=0;addParticle(nx,ny,"ZERST√ñRT",'#fff');}
   else{game.walls[wid]-=dmg;game.timers.shake=2;sfx('hit');addParticle(nx,ny,"RISS",'#777');}
  }return true;
 }
 let t=game.enemies.find(e=>e.x===nx&&e.y===ny);
 if(t){
  if(game.timers.curse>0&&Math.random()<0.25){sfx('hit');addParticle(nx,ny,"VERFEHLT",'#888');game.p.actNoise=3;return true;}
  if(game.p.hidden){addParticle(game.p.x,game.p.y,"Psst...",'#555');return false;}
  let cost=Math.max(1,3+(game.stats.stamCost||0));if(meta.stam<cost){addParticle(game.p.x,game.p.y,"M√úDE!",'#555');return false;}
  meta.stam-=cost;game.exert=1;game.p.actNoise=3;sfx('attack');
  let isCrit=Math.random()<game.stats.critChance,dmg=game.stats.dmg*(isCrit?2:1);
  if(game.stats.lifesteal&&Math.random()<0.3)meta.hp=Math.min(meta.hp+(dmg*game.stats.lifesteal),game.stats.maxHp);
  hurt(t,dmg,false,isCrit?`KRIT ${dmg}!`:null,isCrit?'#ff0':null);
  game.timers.shake=2;return true;
 }
 // Sumpf/Morast wird jetzt √ºber TILE_FX behandelt (verlangsamt durch Energy-Abzug)
 game.p.x=nx;game.p.y=ny;sfx('step');
 // Tile-Effekte ausl√∂sen
 let tile=game.map[ny][nx];if(TILE_FX[tile])TILE_FX[tile](game.p,dx,dy);
 // Eis-Gleiten (Tile 2) - verbesserte Logik
 if(game.p.slide&&game.p.slideDir){
  let sd=game.p.slideDir,snx=nx+sd.x,sny=ny+sd.y;
  if(snx>0&&snx<GRID-1&&sny>0&&sny<GRID-1&&game.map[sny][snx]!==1&&!game.enemies.some(e=>e.x===snx&&e.y===sny)){
   setTimeout(()=>{if(game.mode==='GAME')movePlayer(sd.x,sd.y);},80);
  }
  game.p.slide=false;game.p.slideDir=null;
 }
 checkPickups();return true;
}
function processTurns(){
 game.lockInput=true;let safe=0;
 function tick(){
  safe++;if(safe>1000){game.p.energy=100;game.lockInput=false;return;}
  if(game.p.energy>=100){
   game.lockInput=false;
   if(game.p.hidden){meta.stam-=(game.stats.stealthDrain||3);if(meta.stam<=0){meta.stam=0;game.p.hidden=false;addParticle(game.p.x,game.p.y,"AUFGEDECKT!",'#f00');sfx('hit');}}
   else{if(!game.exert)meta.stam=Math.min(game.stats.maxStam,meta.stam+(game.stats.stamRegen||1));game.exert=0;}
   if(game.stats.manaRegen>0)meta.mana=Math.min(game.stats.maxMana,meta.mana+game.stats.manaRegen);
   turnLogic();return;
  }
  game.p.energy+=meta.speed;game.enemies.forEach(e=>e.energy+=e.speed);
  game.enemies.forEach(e=>{if(e.energy>=100){e.energy-=100;enemyAct(e);}});
  if(game.p.energy<100)setTimeout(tick,0);else tick();
 }tick();
}
function checkAggro(e){
 if(game.p.hidden)return false;if(e.state==='HUNT')return true;
 let d=Math.hypot(game.p.x-e.x,game.p.y-e.y),steps=Math.ceil(d),wd=0;
 for(let i=1;i<steps;i++){let tx=game.p.x+(e.x-game.p.x)*(i/steps)|0,ty=game.p.y+(e.y-game.p.y)*(i/steps)|0;if(game.walls[ty*GRID+tx]>0)wd+=2.5;}
 // Kristall-Vision: erh√∂hte Sichtweite f√ºr beide Seiten
 let sightMod=game.crystalVision>0?3:0;
 if((d+wd)<(e.sight+sightMod+(game.stats.noise*(game.p.actNoise||0)*0.7))){if(Math.random()<0.6){e.state='HUNT';addParticle(e.x,e.y,"!",'#f00');sfx('hit');return true;}}return false;
}
function enemyAct(e){
 if(e.stun>0){e.stun--;return;}
 if(!checkAggro(e)){if(e.state!=='SLEEP'&&Math.random()<0.2){let dx=rnd(-1,1),dy=rnd(-1,1);if(!isBlocked(e.x+dx,e.y+dy)){e.x+=dx;e.y+=dy;}}return;}
 let dx=Math.sign(game.p.x-e.x),dy=Math.sign(game.p.y-e.y),nx=e.x+dx,ny=e.y+dy;
 if(isBlocked(nx,ny)){if(!isBlocked(e.x+dx,e.y))nx=e.x+dx;else if(!isBlocked(e.x,e.y+dy)){nx=e.x;ny=e.y+dy;}else return;}
 if(nx===game.p.x&&ny===game.p.y){
  if(Math.random()<game.stats.dodgeChance)addParticle(game.p.x,game.p.y,"AUSGEWICHEN",'#aaa');
  else{
   let dmg=Math.max(1,e.dmg-(game.stats.def||0));hurt(game.p,dmg,true);
   if(e.fx==='POISON'){game.timers.poison=20;addParticle(game.p.x,game.p.y,"VERGIFTET!",'#0f0');}
   if(e.fx==='BURN'&&Math.random()<0.3){game.timers.burn=10;addParticle(game.p.x,game.p.y,"BRENNT!",'#f60');}
   if(e.fx==='CURSE'&&Math.random()<0.4){game.timers.curse=10;addParticle(game.p.x,game.p.y,"FLUCH",'#80f');}
   if(e.fx==='FREEZE'){meta.stam=Math.max(0,meta.stam-5);addParticle(game.p.x,game.p.y,"EISIG!",'#0ff');}
   if(e.fx==='LIFESTEAL'){e.hp=Math.min(e.max,e.hp+e.dmg);addParticle(e.x,e.y,"LEBENSDIEB",'#a00');}
  }
 }else{e.x=nx;e.y=ny;}
}
function turnLogic(){
 if(!game.p.hasKey&&game.p.x===game.key.x&&game.p.y===game.key.y){game.p.hasKey=true;game.key={x:-1,y:-1};sfx('shop');addParticle(game.p.x,game.p.y,"SCHL√úSSEL",C.BITS);}
 if(game.p.hasKey&&game.p.x===game.exit.x&&game.p.y===game.exit.y){startLevel(game.level+1);return;}
 if(game.timers.curse>0)game.timers.curse--;
 if(game.timers.burn>0){game.timers.burn--;if(game.timers.burn%2===0){meta.hp-=1;addParticle(game.p.x,game.p.y,"FEUER",'#f40');}}
 if(game.timers.poison>0){game.timers.poison--;if(game.timers.poison%5===0){meta.hp-=1;addParticle(game.p.x,game.p.y,"GIFT",'#0f0');}}
 // Nekro-Biom: Alle 20 Ticks spawnt ein Skelett
 let B=BIOMES[game.biome];
 if(B.fx==='NEKRO'){
  game.nekroTimer=(game.nekroTimer||0)+1;
  if(game.nekroTimer>=20){
   game.nekroTimer=0;
   let pos,tries=20;do{pos={x:rnd(1,GRID-2),y:rnd(1,GRID-2)};tries--;}while((game.map[pos.y][pos.x]===1||game.enemies.some(e=>e.x===pos.x&&e.y===pos.y)||(pos.x===game.p.x&&pos.y===game.p.y))&&tries>0);
   if(tries>0){
    let t=BESTIARY.SKEL,hp=((t.st[0]*10)+game.level*1.5)|0;
    game.enemies.push({x:pos.x,y:pos.y,hp,max:hp,dmg:(t.st[1]*1.5+game.level*0.3)|0,bits:(5+game.level*3)|0,name:"Erwecktes Skelett",col:'#0f0',hue:120,state:'HUNT',type:'SKEL',speed:8,energy:0,stun:0,fx:'NONE'});
    addParticle(pos.x,pos.y,'ERWACHT!','#0f0');sfx('glitch');
   }
  }
 }
 game.timers.glitch--;
 if(game.timers.glitch<=0){
  game.glitchCount++;game.timers.glitch=15+game.stats.glitchMod;game.timers.shake=5;sfx('glitch');addParticle(game.p.x,game.p.y,`REALIT√ÑTSBRUCH (${game.glitchCount})`,'#f0f');
  if(game.glitchCount>5){sfx('kill');setTimeout(()=>sfx('kill'),150);}
  // Nekro-Glitch: 50% Mana-Drain
  if(B.fx==='NEKRO'&&meta.mana>0){meta.mana=Math.floor(meta.mana*0.5);addParticle(game.p.x,game.p.y,'MANA ENTZOGEN!','#0f0');}
  // Chaos-Glitch: UI durcheinander
  if(B.fx==='CHAOS')shuffleUI();
  for(let i=0;i<5+game.glitchCount*2;i++){let rx=rnd(1,GRID-2),ry=rnd(1,GRID-2);if([game.p,game.key,game.exit].every(e=>e.x!==rx||e.y!==ry)){game.map[ry][rx]=(Math.random()<0.5)?B.f(rx,ry):(game.map[ry][rx]?0:1);if(game.map[ry][rx]===1)game.walls[ry*GRID+rx]=B.hp;}}
  if(game.glitchCount>3){
   let pool=(game.glitchCount>6)?Object.keys(BESTIARY):B.mobs,key=pool[rnd(0,pool.length-1)],t=BESTIARY[key],diff=game.level*((game.glitchCount>6)?(game.glitchCount/2):1);
   let hp=((t.st[0]*15)+diff*2)*(1+game.glitchCount*0.2);
   game.enemies.push({x:rnd(1,GRID-2),y:rnd(1,GRID-2),hp,max:hp,dmg:(t.st[1]*2+diff/2)|0,bits:0,name:"GLITCH "+t.n,col:'#f0f',hue:300,state:'HUNT',type:key,speed:10,energy:50,stun:0,fx:'NONE'});
  }
 }
 if(meta.hp<=0)triggerGameOver();updateUI();
}
function loop(){
 if(game.timers.shake>0)game.timers.shake--;game.particles.forEach(p=>{p.y-=p.speed;p.life--;});game.particles=game.particles.filter(p=>p.life>0);
 CTX.save();CTX.fillStyle=C.BG;CTX.fillRect(0,0,CVS.width,CVS.height);
 if(game.timers.shake>0)CTX.translate((Math.random()-.5)*10,(Math.random()-.5)*10);
 if(game.mode==='SHOP')drawShop();else drawGame();
 let grd=CTX.createRadialGradient(320,320,200,320,320,450);grd.addColorStop(0,"rgba(0,0,0,0)");grd.addColorStop(1,"rgba(0,0,0,0.6)");CTX.fillStyle=grd;CTX.fillRect(0,0,640,640);
 CTX.restore();requestAnimationFrame(loop);
}
function drawGame(){
 // Kristall-Vision zur√ºcksetzen
 if(game.crystalVision>0)game.crystalVision--;
 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  let px=x*TILE,py=y*TILE,t=game.map[y][x];
  if(t===1)drawSprite(CTX,px,py,x+y*GRID,'WALL',C.WALL);
  else if(t===2){drawSprite(CTX,px,py,x*y+x,'FLOOR','#006');CTX.fillStyle='rgba(150,220,255,0.3)';CTX.fillRect(px,py,TILE,TILE);if(Math.random()<0.02){CTX.fillStyle='#fff';CTX.fillRect(px+rnd(0,28),py+rnd(0,28),2,2);}}
  else if(t===3)drawSprite(CTX,px,py,x*y+x,'FLOOR',C.MUD);
  else if(t===4){drawSprite(CTX,px,py,x*y+x,'FLOOR','#300');CTX.fillStyle=`rgba(255,${100+Math.sin(Date.now()/200+x)*50},0,${0.4+Math.sin(Date.now()/300+y)*0.2})`;CTX.fillRect(px,py,TILE,TILE);}
  else if(t===5){drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);if(Math.random()<0.05){CTX.fillStyle=`hsl(${Date.now()/10%360},100%,50%)`;CTX.fillRect(px+rnd(0,28),py+rnd(0,28),4,4);}}
  else if(t===6){drawSprite(CTX,px,py,x*y+x,'FLOOR','#130');CTX.fillStyle=`rgba(0,${80+Math.sin(Date.now()/400+x)*30},${40+Math.sin(Date.now()/300+y)*20},0.6)`;CTX.beginPath();CTX.arc(px+16,py+16+Math.sin(Date.now()/500+x+y)*2,12,0,Math.PI*2);CTX.fill();if(Math.random()<0.04){CTX.fillStyle='#4f4';CTX.beginPath();CTX.arc(px+rnd(8,24),py+rnd(8,24),rnd(2,4),0,Math.PI*2);CTX.fill();}}
  else if(t===7){drawSprite(CTX,px,py,x*y+x,'FLOOR','#203');CTX.fillStyle=`rgba(200,100,255,${0.2+Math.sin(Date.now()/500+x+y)*0.15})`;CTX.fillRect(px,py,TILE,TILE);CTX.strokeStyle='#e0f';CTX.lineWidth=1;CTX.strokeRect(px+4,py+4,24,24);}
  else if(t===8){CTX.fillStyle='#000';CTX.fillRect(px,py,TILE,TILE);if(Math.random()<0.02){CTX.fillStyle='#333';CTX.fillRect(px+rnd(0,28),py+rnd(0,28),3,3);}}
  else if(t===9){drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);CTX.strokeStyle='#555';CTX.lineWidth=1;CTX.beginPath();CTX.moveTo(px,py);CTX.lineTo(px+TILE,py+TILE);CTX.moveTo(px+TILE,py);CTX.lineTo(px,py+TILE);CTX.stroke();}
  else if(t===10){drawSprite(CTX,px,py,x*y+x,'FLOOR',`hsl(${(Date.now()/20+x*10+y*10)%360},60%,20%)`);if(Math.random()<0.1){CTX.fillStyle=`hsl(${rnd(0,360)},100%,50%)`;CTX.fillRect(px+rnd(0,28),py+rnd(0,28),rnd(2,6),rnd(2,6));}}
  else drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);
 }
 drawSprite(CTX,game.key.x*TILE,game.key.y*TILE,999,'KEY','#ffd700');drawSprite(CTX,game.exit.x*TILE,game.exit.y*TILE,888,'CHEST',game.p.hasKey?'#333':'#f0f');
 game.items.forEach((i,idx)=>{
  if(i.type==='EQUIP')drawSprite(CTX,i.x*TILE,i.y*TILE,i.val.id*100,i.val.slot,i.val.col);
  else drawSprite(CTX,i.x*TILE,i.y*TILE,i.x*i.y+idx,i.type===3?'RELIC':(i.type<2?'POTION':'CHEST'),['#f00','#00f','#ff0','#f60'][i.type]);
 });
 game.enemies.forEach((e,idx)=>{
  if(e.fx==='BURN'&&Math.random()<0.1)addParticle(e.x,e.y,'~','#f40',0.5);if(e.fx==='POISON'&&Math.random()<0.05)addParticle(e.x,e.y,'o','#0f0',0.3);
  drawSprite(CTX,e.x*TILE,e.y*TILE,(e.x+e.y+idx)*10,e.type,e.col||`hsl(${e.hue},60%,50%)`);
  CTX.fillStyle='red';CTX.fillRect(e.x*TILE,e.y*TILE-8,32,2);CTX.fillStyle='#0f0';CTX.fillRect(e.x*TILE,e.y*TILE-8,32*(e.hp/e.max),2);
  if(e.stun>0){CTX.fillStyle='#fff';CTX.fillText('üí´',e.x*TILE+8,e.y*TILE-10);}
 });
 if(game.p.hidden){CTX.save();CTX.globalAlpha=0.5;}drawSprite(CTX,game.p.x*TILE,game.p.y*TILE,1337,'HERO',C.PL);
 if(game.p.hidden){CTX.restore();if(Math.random()<0.3)addParticle(game.p.x,game.p.y,"...","#888");}
 if(game.timers.poison>0){CTX.fillStyle='#0f0';CTX.fillText('‚ò†Ô∏è',game.p.x*TILE+20,game.p.y*TILE);}
 if(game.timers.burn>0){CTX.fillStyle='#f60';CTX.fillText('üî•',game.p.x*TILE-5,game.p.y*TILE);}
 if(game.confused>0){CTX.fillStyle='#ff0';CTX.font='12px serif';CTX.fillText('‚ùì',game.p.x*TILE+10,game.p.y*TILE-5);}
 if(game.p.falling){CTX.globalAlpha=0.5;CTX.fillStyle='#fff';CTX.fillText('~',game.p.x*TILE+16,game.p.y*TILE+40);CTX.globalAlpha=1;}
 if(game.aiming&&meta.class==='MAGE'){
  let v=hasLOS(game.p.x,game.p.y,game.mouse.x,game.mouse.y);CTX.strokeStyle=v?'#0f0':'#f00';CTX.lineWidth=2;CTX.strokeRect(game.mouse.x*TILE,game.mouse.y*TILE,TILE,TILE);CTX.beginPath();CTX.moveTo(game.p.x*TILE+16,game.p.y*TILE+16);CTX.lineTo(game.mouse.x*TILE+16,game.mouse.y*TILE+16);CTX.stroke();
 }
 game.particles.forEach(p=>{CTX.globalAlpha=p.life/40;CTX.fillStyle=p.col;CTX.font="bold 12px serif";CTX.fillText(p.txt,p.x,p.y);});CTX.globalAlpha=1;
 L_CTX.globalCompositeOperation='source-over';L_CTX.fillStyle='rgba(0,0,0,0.95)';L_CTX.fillRect(0,0,640,640);L_CTX.globalCompositeOperation='destination-out';
 const drawLight=(x,y,r)=>{let g=L_CTX.createRadialGradient(x,y,r*0.2,x,y,r);g.addColorStop(0,'rgba(0,0,0,1)');g.addColorStop(1,'rgba(0,0,0,0)');L_CTX.fillStyle=g;L_CTX.beginPath();L_CTX.arc(x,y,r,0,Math.PI*2);L_CTX.fill();};
 drawLight(game.p.x*TILE+16,game.p.y*TILE+16,250);game.torches.forEach(t=>drawLight(t.x*TILE+16,t.y*TILE+16,(game.stats.torchRadius||150)+Math.random()*10-5));CTX.drawImage(L_CVS,0,0);
}
function drawSprite(ctx,x,y,seed,type,col){
 ctx.save();ctx.translate(x,y);let px=4,t=Date.now()/200;
 if(type==='HERO'){
  ctx.fillStyle='#dcb';ctx.fillRect(12,4,8,8);ctx.fillRect(8,12,16,12);ctx.fillRect(8,24,4,8);ctx.fillRect(20,24,4,8);
  if(game.equipment.ARMOR){ctx.fillStyle=game.equipment.ARMOR.col;ctx.fillRect(8,12,16,8);ctx.fillRect(4,12,4,4);ctx.fillRect(24,12,4,4);}
  if(game.equipment.WEAPON){ctx.fillStyle=game.equipment.WEAPON.col;ctx.fillRect(28,12,4,16);ctx.fillStyle='#543';ctx.fillRect(28,28,4,4);}
 }else{
  ctx.fillStyle=col;
  if(type==='SKEL'){ctx.fillStyle='#eee';ctx.fillRect(12,4,8,8);ctx.fillRect(12,16,8,4);ctx.fillRect(12,24,8,4);ctx.fillRect(4,12,4,16);ctx.fillRect(24,12,4,16);}
  else if(type==='SLIME'){let s=1+Math.sin(t*2)*0.1;ctx.globalAlpha=0.8;ctx.beginPath();ctx.arc(16,16+Math.sin(t)*2,10*s,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.fillRect(12,14,2,2);ctx.fillRect(18,14,2,2);}
  else if(type==='BAT'){let w=Math.abs(Math.sin(t*10))*8;ctx.fillRect(14,14,4,4);ctx.beginPath();ctx.moveTo(14,16);ctx.lineTo(14-w,10);ctx.lineTo(14-w,20);ctx.fill();ctx.beginPath();ctx.moveTo(18,16);ctx.lineTo(18+w,10);ctx.lineTo(18+w,20);ctx.fill();}
  else if(type==='GOLEM'){ctx.fillRect(8,8+Math.sin(t)*2,16,16);ctx.fillStyle='#000';ctx.fillRect(12,12,2,2);ctx.fillRect(18,12,2,2);}
  else if(type==='GHOST'){ctx.globalAlpha=0.6;ctx.beginPath();ctx.arc(16,12+Math.sin(t)*3,8,Math.PI,0);ctx.lineTo(24,28);ctx.lineTo(16,24);ctx.lineTo(8,28);ctx.fill();ctx.fillStyle='#fff';ctx.fillRect(12,12,2,2);ctx.fillRect(18,12,2,2);}
  else if(type==='SPIDER'){ctx.fillRect(12,12,8,8);let l=Math.sin(t*5)*3;for(let i=0;i<4;i++){ctx.fillRect(8-Math.abs(l),10+i*3,4,1);ctx.fillRect(20+Math.abs(l),10+i*3,4,1);}}
  else if(type==='RAT'){ctx.fillRect(8+Math.sin(t*8)*2,20,16,6);ctx.fillStyle='#pink';ctx.fillRect(24,22,6,2);}
  else if(type==='SNAKE'){for(let i=0;i<6;i++)ctx.fillRect(16+Math.sin(t*4+i)*6,8+i*4,6,4);}
  else if(type==='EYE'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,16+Math.sin(t)*2,10,0,Math.PI*2);ctx.fill();ctx.fillStyle=col;ctx.beginPath();ctx.arc(16+Math.sin(t*0.5)*4,16+Math.cos(t*0.5)*4,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(16+Math.sin(t*0.5)*4,16+Math.cos(t*0.5)*4,2,0,Math.PI*2);ctx.fill();}
  else if(type==='MIMIC'){ctx.fillStyle='#853';ctx.fillRect(8,12,16,12);ctx.fillStyle='#ffd700';ctx.fillRect(14,12,4,4);if(Math.sin(t*2)>0){ctx.fillStyle='#000';ctx.fillRect(8,16,16,4);ctx.fillStyle='#fff';ctx.fillRect(10,16,2,2);ctx.fillRect(14,16,2,2);ctx.fillRect(18,16,2,2);}}
  else if(type==='WRAITH'){ctx.beginPath();ctx.moveTo(16,4);ctx.lineTo(8,28);ctx.lineTo(24,28);ctx.fill();ctx.strokeStyle='#aaa';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(20,16);ctx.lineTo(28,6);ctx.arc(24,10,6,0,Math.PI);ctx.stroke();}
  else if(type==='ELEMENTAL'){for(let i=0;i<8;i++){let ang=t*2+i*(Math.PI/4),r=8+Math.sin(t*3)*4;ctx.fillRect(16+Math.cos(ang)*r,16+Math.sin(ang)*r,4,4);}ctx.fillRect(14,14,4,4);}
  else{
   let r=(n)=>Math.sin(seed*12.9898+n*78.233)*43758.5453;
   for(let j=0;j<8;j++)for(let i=0;i<8;i++){
    let n=Math.abs(r(i+j*8+seed)),c=col,d=false;
    if(type==='WALL'||type==='FLOOR'){
     ctx.fillStyle=col;ctx.fillRect(i*px,j*px,px,px);
     if(n>0.5){ctx.fillStyle=(n>0.75)?'#fff':'#000';ctx.globalAlpha=0.1;ctx.fillRect(i*px,j*px,px,px);ctx.globalAlpha=1.0;}
     if(type==='WALL'){
      if(game.walls[seed]<10){
        ctx.strokeStyle='#000';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(i*px,j*px);ctx.lineTo((i+1)*px,(j+1)*px);ctx.stroke();
      }
      if(n>0.8){ctx.fillStyle='#000';ctx.globalAlpha=0.2;ctx.fillRect(i*px,j*px,px,px);ctx.globalAlpha=1.0;}
     }
    }else{
     if(type==='WEAPON'){if(i===3&&j<7){d=true;c='#ddd';}if(j===5&&i>1)d=true;if(j===6&&i===3){d=true;c='#853';}if(j<5&&i===2&&n>0.4){d=true;c='#ddd';}}
     else if(type==='ARMOR'){if(j>1&&j<7&&i<4)d=true;if(j===2&&i===2)d=false;if(j>3&&i===3)c='#888';}
     else if(type==='RELIC'){let dist=Math.sqrt((i-3.5)**2+(j-3.5)**2);if(dist<3.5&&dist>1.5)d=true;if(j===1&&i===3){d=true;c='#fff';}}
     else if(type==='POTION'){if(i<3&&j>2&&j<7)d=true;if(i===1&&j<3){d=true;c='#eee';}if(j===3)c='#eee';}
     else if(type==='KEY'){if(i===3&&j>1)d=true;if(j===1&&i>1)d=true;if(j===6&&i>1)d=true;}
     else if(type==='CHEST'){if(j>2&&j<7&&i<4)d=true;if(j===2&&i<3){d=true;c='#aaa';}if(i===0&&j>2)c='#aaa';}
     if(d){ctx.fillStyle=c;ctx.fillRect(i*px,j*px,px,px);ctx.fillRect((7-i)*px,j*px,px,px);}
    }
   }
  }
 }
 ctx.restore();
}
function drawShop(){
 CTX.fillStyle='#050505';CTX.fillRect(0,0,640,640);CTX.textAlign="center";CTX.fillStyle=game.lockMode?'#555':'#8a0b0b';CTX.font="bold 30px serif";CTX.fillText("/// SCHATTENH√ÑNDLER ///",320,50);CTX.fillStyle='#c5a059';CTX.font="18px serif";CTX.fillText(`GOLD: ${meta.bits} | TIEFE: ${meta.maxLvl}`,320,80);CTX.fillText(game.lockMode?"-- SPERRE AKTIV --":"[L] AUSWAHL SPERREN",320,510);CTX.fillStyle='#888';CTX.fillText(`HP:${meta.hp}/${meta.maxHp} DMG:${meta.dmg} KRIT:${Math.round(meta.critChance*100)}% GL√úCK:${meta.shopLuck}`,320,105);CTX.textAlign="left";let y=140;
 game.shopItems.forEach(o=>{
  if(y>460)return;
  let col=o.tier.col==='RAINBOW'?`hsl(${Date.now()/5%360},100%,50%)`:o.tier.col;
  if(o.purchased){CTX.fillStyle='#333';CTX.fillText(`[${o.idx}] -- LEER --`,80,y);}else{
   drawSprite(CTX,30,y-25,o.idx*123,o.item.vis||'POTION',col);CTX.fillStyle=col;
   let pre=(meta.bits>=o.cost)?`[${o.idx}]`:` X `,v=o.item.calc(o.tier),vTxt=o.item.unit==='%'?`+${Math.round(v*100)}%`:`+${v} ${o.item.unit}`;
   if(o.locked)pre='[L]';
   CTX.font="bold 18px serif";CTX.fillText(`${pre} ${o.item.name} [${vTxt}]`,80,y);CTX.font="italic 14px serif";CTX.fillText(o.tier.name,480,y);
   let dCost=game.lockMode?(o.locked?0:Math.max(1,(o.cost*0.1)|0)):o.cost;CTX.fillStyle=(meta.bits>=dCost)?'#ffd700':'#555';CTX.textAlign="right";CTX.fillText(game.lockMode&&o.locked?"L√ñSEN":`${dCost}`,580,y);CTX.textAlign="left";
  }y+=40;
 });
 CTX.textAlign="center";CTX.fillStyle=(meta.bits>=game.rerollCost)?'#c5a059':'#555';CTX.fillText(`[SPACE] ANGEBOT TAUSCHEN (${game.rerollCost})`,320,480);
}
function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function addParticle(x,y,txt,col,spd=1){game.particles.push({x:x*TILE+16,y:y*TILE,txt,col,life:60,speed:0.5*spd});}
function genItem(lvl){
 let mat=I_MATS[Math.min(I_MATS.length-1,Math.floor(Math.random()*(lvl/2+1)))],rMax=2+lvl*0.7+(meta.maxLvl*0.2),rIdx=Math.min(RARITIES.length-1,Math.max(0,Math.floor(Math.random()*rMax+(game.stats.shopLuck||0)/20))),rar=RARITIES[rIdx],type=I_TYPES[rnd(0,I_TYPES.length-1)];
 let item={id:Math.random(),name:rar.name+" "+type.n[rnd(0,type.n.length-1)],target:type.target,slot:type.s,col:mat.c,rarityCol:rar.col,mods:{},val:(type.baseCost*mat.m*rar.mul*0.5)|0};
 Object.keys(type.mods).forEach(k=>{let v=type.mods[k]*mat.m*rar.mul;item.mods[k]=['critChance','dodgeChance','lootMul','manaRegen'].includes(k)?parseFloat(v.toFixed(2)):Math.round(v);});
 if(mat.b)Object.assign(item.mods,mat.b);
 if(Math.random()<0.3+(lvl*0.05)){let s=I_SUFFIX[rnd(0,I_SUFFIX.length-1)];item.name+=" "+s.n;item.mods[s.stat]=(item.mods[s.stat]||0)+s.v;if(s.stat.includes('Chance')||s.stat==='lootMul')item.mods[s.stat]=parseFloat(item.mods[s.stat].toFixed(2));}
 return item;
}
function calcStats(){
 game.stats={...meta};game.stats.maxStam+=(meta.maxLvl-1);Object.values(game.equipment).forEach(it=>{if(it)Object.keys(it.mods).forEach(k=>game.stats[k]=(game.stats[k]||0)+it.mods[k]);});
 let w=game.equipment.WEAPON;game.stats.spellDmg=(game.stats.spellDmg||0)+(w&&meta.class===w.target?2:0);if(w&&meta.class===w.target){if(meta.class==='WARRIOR'){game.stats.def=(game.stats.def||0)+1;game.stats.dmg=(game.stats.dmg||0)+1;}else if(meta.class==='ROGUE'){game.stats.critChance=(game.stats.critChance||0)+0.05;game.stats.speed=(game.stats.speed||0)+2;}else if(meta.class==='MAGE')game.stats.manaRegen=(game.stats.manaRegen||0)+0.5;}
 game.stats.critChance=Math.min(1.0,game.stats.critChance);game.stats.dodgeChance=Math.min(0.75,game.stats.dodgeChance);game.stats.speed=Math.max(2,game.stats.speed);game.stats.noise=Math.max(0,game.stats.noise);
}
function save(){localStorage.setItem('GD4_Dark_Save',JSON.stringify(meta));}
function delSave(){if(confirm('Alles l√∂schen?')){localStorage.removeItem('GD4_Dark_Save');location.reload();}}
function triggerGameOver(){game.mode='SHOP';game.rerollCost=10;generateShop();$('shop-ui').style.display='flex';if(meta.maxLvl>1){$('lvl-select').style.display='block';$('lvl-slider').max=meta.maxLvl;$('lvl-slider').value=1;$('lvl-val').innerText=1;}save();}
function generateShop(){game.shopItems=[];let slots=meta.shopSlots;if(meta.lockedItems&&meta.lockedItems.length>0){meta.lockedItems.forEach(li=>{if(game.shopItems.length<slots){let base=ITEM_POOL.find(i=>i.name===li.itemName),tier=R_MAP[li.tierName];if(base&&tier)game.shopItems.push({idx:game.shopItems.length+1,item:base,tier,cost:li.cost,purchased:false,locked:true});}});meta.lockedItems=[];}while(game.shopItems.length<slots){let base=ITEM_POOL[rnd(0,ITEM_POOL.length-1)],roll=Math.random()*100-meta.shopLuck-(meta.maxLvl*3),rIndex=0;for(let i=RARITIES.length-1;i>=0;i--)if(roll<RARITIES[i].chance){rIndex=i;break;}let tier=RARITIES[rIndex],cost=Math.floor(base.baseCost*tier.mul);game.shopItems.push({idx:game.shopItems.length+1,item:base,tier,cost,purchased:false,locked:false});}}
function respawn(){meta.hp=meta.maxHp;meta.stam=meta.maxStam;meta.mana=meta.maxMana;meta.lockedItems=game.shopItems.filter(i=>i.locked&&!i.purchased).map(i=>({itemName:i.item.name,tierName:i.tier.name,cost:i.cost}));game.mode='GAME';let sl=parseInt($('lvl-slider').value)||1;$('lvl-select').style.display='none';startLevel(sl);}
function isBlocked(x,y){if(game.map[y][x]===1)return true;if(game.enemies.some(e=>e.x===x&&e.y===y))return true;return false;}
function checkPickups(){let idx=game.items.findIndex(i=>i.x===game.p.x&&i.y===game.p.y);if(idx>=0){sfx('shop');let item=game.items[idx];game.items.splice(idx,1);if(item.type==='EQUIP'){if(game.inventory.length<10){game.inventory.push(item.val);addParticle(game.p.x,game.p.y,item.val.name,item.val.rarityCol||item.val.col);}else{addParticle(game.p.x,game.p.y,"VOLL!",'#f00');game.items.push(item);return;}}else{if(item.type===0){if(game.timers.poison>0)addParticle(game.p.x,game.p.y,"GIFT BLOCKT!",'#0f0');else{meta.hp=Math.min(meta.hp+5,game.stats.maxHp);addParticle(game.p.x,game.p.y,"HEILUNG",'#0f0');}}if(item.type===1){meta.mana=Math.min(meta.mana+10,game.stats.maxMana);addParticle(game.p.x,game.p.y,"MANA",'#0af');}if(item.type===2){let b=Math.floor((10+game.level*8+Math.pow(game.level,2)*0.5)*game.stats.lootMul);meta.bits+=b;addParticle(game.p.x,game.p.y,`+${b}`,C.BITS);}if(item.type===3&&meta.scrolls<5){meta.scrolls++;addParticle(game.p.x,game.p.y,"RITUAL",'#f60');}}}}
// Chaos-Biom: UI-Elemente durcheinander w√ºrfeln
function shuffleUI(){
 let bar=$('ui-bar'),hud=$('hud'),actions=$('actions');
 // Stat-Reihenfolge mischen
 let stats=bar.querySelectorAll('div > div');
 stats.forEach(s=>{s.style.order=rnd(0,10);s.style.transform=`rotate(${rnd(-5,5)}deg)`;});
 // Button-Reihenfolge mischen
 let btns=actions.querySelectorAll('button');
 btns.forEach(b=>{b.style.order=rnd(0,10);});
 // D-Pad drehen
 let dpad=$('dpad');
 dpad.style.transform=`rotate(${[0,90,180,270][rnd(0,3)]}deg)`;
 // Farben chaotisch
 document.documentElement.style.setProperty('--accent-color',`hsl(${rnd(0,360)},100%,50%)`);
 document.documentElement.style.setProperty('--text-color',`hsl(${rnd(30,60)},${rnd(50,100)}%,${rnd(40,70)}%)`);
 // Nach kurzer Zeit zur√ºcksetzen
 setTimeout(()=>{
  stats.forEach(s=>{s.style.order='';s.style.transform='';});
  btns.forEach(b=>{b.style.order='';});
  dpad.style.transform='';
  let B=BIOMES[game.biome];
  document.documentElement.style.setProperty('--accent-color',B.c[3]);
  document.documentElement.style.setProperty('--text-color','#c5a059');
 },3000);
 addParticle(game.p.x,game.p.y,'UI CHAOS!','#ff0');
}
function updateUI(){
 UI.lvl.innerText=game.level;
 let hpTxt=Math.round(meta.hp)+"/"+game.stats.maxHp;if(game.timers.poison>0)hpTxt+=" [GIFT]";if(game.timers.burn>0)hpTxt+=" [FEUER]";if(game.timers.curse>0)hpTxt+=" [FLUCH]";UI.hp.innerText=hpTxt;
 UI.glitch.innerText=game.timers.glitch;UI.bits.innerText=meta.bits;UI.scrolls.innerText=meta.scrolls||0;UI.key.innerText=game.p.hasKey?"[KEY]":"";
 UI.mana.innerText=Math.floor(meta.mana)+"/"+game.stats.maxMana;UI.stam.innerText=Math.floor(meta.stam)+"/"+game.stats.maxStam;
 if(meta.stam<3||(game.p.hidden&&meta.stam<5))UI.stam.classList.add('stam-low');else UI.stam.classList.remove('stam-low');
 UI.cls.innerText=CLASSES[meta.class].n;
 let t=null,dist=999;game.enemies.forEach(e=>{let d=Math.abs(e.x-game.p.x)+Math.abs(e.y-game.p.y);if(d<=1.5&&d<dist){dist=d;t=e;}});
 if(t){UI.target.innerText=`ZIEL: ${t.name} (${t.hp}/${t.max} HP)`;UI.target.style.color=`hsl(${t.hue}, 60%, 50%)`;}else{UI.target.innerText="ZIEL: [Keines]";UI.target.style.color="#666";}
 let sBtn=$('btn-skill'),c=meta.class,cost=5,res=(c==='MAGE')?meta.mana:meta.stam;
 sBtn.setAttribute('data-t',`${(c==='WARRIOR')?"Wirbelwind":(c==='ROGUE')?"Unsichtbarkeit":"Feuerball"} (B)`);
 if(c==='ROGUE'){sBtn.style.borderColor=game.p.hidden?"#0f0":"#555";if(!game.p.hidden&&res<5)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 else if(c==='MAGE'){sBtn.style.borderColor=game.aiming?"#f0f":"#555";if(!game.aiming&&res<5)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 else{sBtn.style.borderColor="#555";if(res<cost)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 let iBtn=$('btn-item');if(meta.scrolls>0)iBtn.classList.remove('disabled');else iBtn.classList.add('disabled');
}
function useConsumable(){
 if((meta.scrolls||0)<=0){sfx('hit');addParticle(game.p.x,game.p.y,"KEINE ROLLEN!",'#f00');return;}
 meta.scrolls--;sfx('glitch');addParticle(game.p.x,game.p.y,"BANNKREIS!",'#f60');let cnt=0;
 game.enemies.forEach(e=>{let d=Math.hypot(e.x-game.p.x,e.y-game.p.y);if(d<6){hurt(e,5,false,"GEBANNT",'#fff');e.stun=3;cnt++;}});
 if(cnt===0)addParticle(game.p.x,game.p.y,"NIEMAND DA...",'#777');game.p.energy-=100;updateUI();processTurns();
}
function useSkill(){
 let c=meta.class,cost=5,res=(c==='MAGE')?'mana':'stam';
 if(c==='ROGUE'){if(game.p.hidden){game.p.hidden=false;addParticle(game.p.x,game.p.y,"SICHTBAR",'#fff');}else{let cost=(game.stats.stealthCost||5);if(meta.stam<cost){addParticle(game.p.x,game.p.y,"ZU ERSCH√ñPFT!",'#555');return;}meta.stam-=cost;game.p.hidden=true;addParticle(game.p.x,game.p.y,"VERBORGEN",'#333');game.enemies.forEach(e=>{if(e.state==='HUNT')e.state='PATROL';});sfx('step');}updateUI();return;}
 if(meta[res]<cost){addParticle(game.p.x,game.p.y,"ZU ERSCH√ñPFT!",'#555');return;}
 let acted=false;
 if(c==='WARRIOR'){
  meta[res]-=cost;if(res==='stam')game.exert=1;sfx('attack');addParticle(game.p.x,game.p.y,"WIRBELWIND!",'#fff');
  for(let iy=-1;iy<=1;iy++)for(let ix=-1;ix<=1;ix++){if(ix===0&&iy===0)continue;let tx=game.p.x+ix,ty=game.p.y+iy,t=game.enemies.find(e=>e.x===tx&&e.y===ty);if(t){hurt(t,game.stats.dmg,false);let kx=t.x+ix,ky=t.y+iy;if(!isBlocked(kx,ky)&&!game.walls[ky*GRID+kx]){t.x=kx;t.y=ky;}}}acted=true;
 }else if(c==='MAGE'){game.aiming=!game.aiming;addParticle(game.p.x,game.p.y,game.aiming?"ZIELEN...":"ABBRUCH",'#f0f');updateUI();return;}
 if(acted){game.p.energy-=100;updateUI();processTurns();}
}
function inv_toggle(){let el=$('inv-screen');if(el.style.display==='block'){el.style.display='none';game.invMode=0;}else{game.invMode=0;updateInvModeUI();renderInv();el.style.display='block';}}
function cycleInvMode(){game.invMode=(game.mode==='SHOP')?((game.invMode===0)?2:0):((game.invMode===0)?1:0);updateInvModeUI();}
function updateInvModeUI(){let btn=$('inv-mode-btn'),grid=$('inv-display');grid.className='inv-grid';if(game.invMode===0){btn.innerText="MODUS: AUSR√úSTEN";btn.style.color="#ccc";btn.style.borderColor="#555";}else if(game.invMode===1){btn.innerText="MODUS: M√úLL (L√ñSCHEN!)";btn.style.color="#f00";btn.style.borderColor="#f00";grid.classList.add('mode-trash');}else if(game.invMode===2){btn.innerText="MODUS: VERKAUFEN";btn.style.color="#ffd700";btn.style.borderColor="#ffd700";grid.classList.add('mode-sell');}}
function renderInv(){
 let h='';['WEAPON','ARMOR','RELIC'].forEach(s=>{let it=game.equipment[s],st=it?`border-color:${it.rarityCol||'#333'};box-shadow:0 0 8px ${it.rarityCol||'#000'};`:'';h+=`<div class="inv-slot ${it?'equipped':''}" style="${st}" onclick="inv_unequip('${s}')"><div class="equip-slot-label">${s}</div>${it?`<div style="color:${it.col}">${esc(it.name)}</div>${renderMods(it)}`:'<span style="color:#333">LEER</span>'}</div>`;});$('equip-display').innerHTML=h;h='';
 game.inventory.forEach((it,i)=>{
  let st=`border-color:${it.rarityCol||'#333'};box-shadow:0 0 5px ${it.rarityCol||'#000'};`;
  let cnt=it.count>1?`<div style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.8);color:#fff;font-size:10px;padding:1px 3px;">x${it.count}</div>`:'';
  h+=`<div class="inv-slot" style="${st}" onclick="inv_action(${i})">${cnt}<div style="color:${it.col}">${esc(it.name)}</div>${renderMods(it)}</div>`;
 });$('inv-display').innerHTML=h;
 document.querySelectorAll('.inv-slot').forEach(s=>{let tt=s.querySelector('.inv-tooltip');if(!tt)return;s.ontouchstart=e=>{s.th=setTimeout(()=>{tt.style.display='block'},500)};s.ontouchend=e=>{clearTimeout(s.th);tt.style.display=''};});
}
function renderMods(it){
 let bonus='',m=meta.class;if(m===it.target)bonus=`<br><span style="color:#0f0">KLASSEN-BONUS!</span>`;
 let useMsg=(it.vis==='POTION')?`<br><span style="color:#0af">[Klick zum Trinken]</span>`:'';
 let modsHtml=Object.entries(it.mods).map(([k,v])=>`<span style="color:${(v>=0^(k==='noise'||k==='stamCost'))?'#0f0':'#f00'}">${k}: ${v}</span>`).join('<br>');
 return `<div class="inv-tooltip">WERT: ${it.val||0}<br>${modsHtml}${bonus}${useMsg}</div>`;
}
function inv_action(i){let it=game.inventory[i];if(!it)return;if(game.invMode===0){
 if(it.vis==='POTION'){
  let poolIt=ITEM_POOL.find(x=>x.name===it.name);
  if(poolIt){
   poolIt.run(meta,poolIt.calc(it.tier||{mul:1}));
   sfx('gulp');addParticle(game.p.x,game.p.y,"BENUTZT",'#0f0');
   if(it.count>1)it.count--; else game.inventory.splice(i,1);
   calcStats();updateUI();renderInv();return;
  }
 }
 let old=game.equipment[it.slot];if(old)game.inventory[i]=old;else game.inventory.splice(i,1);game.equipment[it.slot]=it;sfx('shop');calcStats();renderInv();}else if(game.invMode===1){game.inventory.splice(i,1);sfx('hit');addParticle(game.p.x,game.p.y,"M√úLL",'#888');renderInv();}else if(game.invMode===2){game.inventory.splice(i,1);meta.bits+=(it.val||0);sfx('shop');addParticle(game.p.x,game.p.y,`+${it.val||0} GOLD`,'#ffd700');updateUI();renderInv();}}
function inv_unequip(s){let it=game.equipment[s];if(!it)return;if(game.inventory.length<10){game.equipment[s]=null;game.inventory.push(it);sfx('shop');calcStats();renderInv();}else sfx('hit');}
function sfx(id){if(!actx)return;const t=actx.currentTime,o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);if(id==='step'){o.type='triangle';o.frequency.setValueAtTime(50,t);o.frequency.exponentialRampToValueAtTime(10,t+0.1);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}else if(id==='attack'){o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.linearRampToValueAtTime(50,t+0.1);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}else if(id==='hit'){o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(10,t+0.3);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);o.start(t);o.stop(t+0.3);}else if(id==='kill'){o.type='sine';o.frequency.setValueAtTime(440,t);o.frequency.exponentialRampToValueAtTime(880,t+0.2);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}else if(id==='shop'){o.type='triangle';o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+1.0);o.start(t);o.stop(t+1.0);}else if(id==='glitch'){o.type='sawtooth';o.frequency.setValueAtTime(Math.random()*200+50,t);o.frequency.linearRampToValueAtTime(Math.random()*200+50,t+0.2);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);}else if(id==='gulp'){o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(150,t+0.15);g.gain.setValueAtTime(0.2,t);g.gain.linearRampToValueAtTime(0,t+0.15);o.start(t);o.stop(t+0.15);}}
window.addEventListener('keydown',e=>{au();if(game.timers.shake>0)return;if(game.mode==='GAME')inputGame(e);else if(game.mode==='SHOP')inputShop(e);});
function inputShop(e){if(e.key==='i'){inv_toggle();return;}if(e.key==='r'){respawn();return;}if(e.key==='l'){game.lockMode=!game.lockMode;return;}if(e.key===' ')shopReroll();let k=parseInt(e.key);if(k>0&&k<=game.shopItems.length)shopAction(k-1);}
function shopReroll(){if(meta.bits>=game.rerollCost){sfx('shop');meta.bits-=game.rerollCost;game.rerollCost*=3;meta.lockedItems=game.shopItems.filter(i=>i.locked&&!i.purchased).map(i=>({itemName:i.item.name,tierName:i.tier.name,cost:i.cost}));generateShop();save();updateUI();}else game.timers.shake=5;}
function shopAction(i){let o=game.shopItems[i];if(game.lockMode){if(o.purchased)return;if(o.locked)o.locked=false;else{let c=Math.max(1,(o.cost*0.1)|0);if(meta.bits>=c){sfx('step');meta.bits-=c;o.locked=true;addParticle(320,320,"GESPERRT",'#fff');}else game.timers.shake=5;}}else if(!o.purchased){if(meta.bits>=o.cost){sfx('shop');meta.bits-=o.cost;o.purchased=true;o.locked=false;let v=o.item.calc(o.tier);o.item.run(meta,v);addParticle(320,320,o.item.unit==='%'?`+${Math.round(v*100)}%`:`+${v} ${o.item.unit}`,o.tier.col==='RAINBOW'?'#fff':o.tier.col);game.timers.shake=3;save();}else game.timers.shake=5;}updateUI();}
function inputGame(e){if(meta.hp<=0||game.lockInput)return;let dx=0,dy=0,acted=false;if(e.key==='i'){inv_toggle();return;}if(e.key.match(/w|ArrowUp/))dy=-1;else if(e.key.match(/s|ArrowDown/))dy=1;else if(e.key.match(/a|ArrowLeft/))dx=-1;else if(e.key.match(/d|ArrowRight/))dx=1;else if(e.key===' '){game.p.actNoise=0;acted=true;}else if(e.key.toLowerCase()==='b'){useSkill();return;}else if(e.key.toLowerCase()==='f'){useConsumable();return;}else return;if(dx!==0||dy!==0)acted=movePlayer(dx,dy);if(acted)endTurn();}
function act(c){au();if(game.aiming&&c!=='SKILL'){game.aiming=false;updateUI();}if(c==='U')movePlayer(0,-1)&&endTurn();if(c==='D')movePlayer(0,1)&&endTurn();if(c==='L')movePlayer(-1,0)&&endTurn();if(c==='R')movePlayer(1,0)&&endTurn();if(c==='WAIT'){game.p.actNoise=0;endTurn();}if(c==='SKILL')useSkill();if(c==='ITEM')useConsumable();if(c==='INV')inv_toggle();if(c==='HELP')alert('WASD/Pfeile: Move\nSPACE: Wait\nB: Skill\nF: Item\nI: Inv');if(c==='ATK'){let d=game.p.dir;movePlayer(d.x,d.y)&&endTurn();}}
function endTurn(){game.p.energy-=100;processTurns();return true;}
CVS.onclick=e=>{au();let rect=CVS.getBoundingClientRect();if(game.mode==='SHOP'){let s=640/rect.height,y=(e.clientY-rect.top)*s;if(y>465&&y<495)shopReroll();else if(y>=495&&y<525)game.lockMode=!game.lockMode;else{let i=Math.floor((y-120)/40);if(i>=0&&i<game.shopItems.length)shopAction(i);}return;}let tx=((e.clientX-rect.left)/(rect.width/GRID))|0,ty=((e.clientY-rect.top)/(rect.height/GRID))|0;if(game.aiming&&meta.class==='MAGE'){castFireball(tx,ty);return;}let t=game.enemies.find(en=>en.x===tx&&en.y===ty);if(t){let dx=tx-game.p.x,dy=ty-game.p.y;if(Math.abs(dx)+Math.abs(dy)===1){movePlayer(dx,dy)&&endTurn();}else stepTowards(tx,ty);}else stepTowards(tx,ty);};
function castFireball(tx,ty){if(meta.mana<5){addParticle(game.p.x,game.p.y,"KEIN MANA",'#0af');game.aiming=false;updateUI();return;}if(!hasLOS(game.p.x,game.p.y,tx,ty)){addParticle(tx,ty,"BLOCKIERT",'#f00');return;}meta.mana-=5;sfx('glitch');game.aiming=false;updateUI();let t=game.enemies.find(e=>e.x===tx&&e.y===ty);if(t){hurt(t,game.stats.dmg*1.5+(game.stats.spellDmg||0)*3,false);if(t.hp>0)t.state='HUNT';}else addParticle(tx,ty,"BOOM!",'#f60');for(let sy=-1;sy<=1;sy++)for(let sx=-1;sx<=1;sx++){if(sx===0&&sy===0)continue;let st=game.enemies.find(e=>e.x===tx+sx&&e.y===ty+sy);if(st){hurt(st,Math.floor(game.stats.dmg),false,`SPLASH -${Math.floor(game.stats.dmg)}`,'#f60');}}game.p.energy-=100;processTurns();}
function hasLOS(x0,y0,x1,y1){let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=(x0<x1)?1:-1,sy=(y0<y1)?1:-1,err=dx-dy;while(true){if(x0===x1&&y0===y1)return true;if(game.map[y0][x0]===1)return false;let e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}}
function stepTowards(tx,ty){let dx=Math.sign(tx-game.p.x),dy=Math.sign(ty-game.p.y);if(dx!==0&&dy!==0){if(Math.abs(tx-game.p.x)>Math.abs(ty-game.p.y))dy=0;else dx=0;}movePlayer(dx,dy)&&endTurn();}
document.onmousemove=e=>{let txt=e.target.dataset.t||'';if(e.target.id==='cvs'){let r=CVS.getBoundingClientRect(),s=640/r.height,mx=(e.clientX-r.left)*s,my=(e.clientY-r.top)*s;if(game.mode==='SHOP'){let i=Math.floor((my-115)/40),o=game.shopItems[i];if(o){if(o.purchased)txt="Bereits erworben";else{let v=o.item.calc(o.tier),eff=o.item.unit==='%'?`+${Math.round(v*100)}%`:`+${v} ${o.item.unit}`;txt=`${o.item.name}\n${o.tier.name} | ${eff}`;}}}else{let x=(mx/TILE)|0,y=(my/TILE)|0;game.mouse={x,y};let t=game.enemies.find(e=>e.x===x&&e.y===y),i=game.items.find(e=>e.x===x&&e.y===y),w=(x>=0&&x<GRID&&y>=0&&y<GRID)?game.walls[y*GRID+x]:0;if(t)txt=`${t.name}\nHP:${t.hp}/${t.max} ATK:${t.dmg}`;else if(i)txt=i.val?`${i.val.name}\n${Object.keys(i.val.mods).join(',')}`:['HP+','MANA+','GOLD','ROLLE'][i.type];else if(w>0)txt=`Mauer (${(w|0)})`;else if(x===game.key.x&&y===game.key.y)txt='Schl√ºssel';else if(x===game.exit.x&&y===game.exit.y)txt=`Ausgang ${game.p.hasKey?'(Offen)':'(Zu)'}`;}}let el=$('tt');if(txt){el.style.display='block';el.style.left=(e.clientX+15)+'px';el.style.top=(e.clientY+15)+'px';el.innerText=txt;}else el.style.display='none';};
let ts;CVS.ontouchstart=e=>{ts={x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.cancelable)e.preventDefault();};
CVS.ontouchend=e=>{let d=40,dx=e.changedTouches[0].clientX-ts.x,dy=e.changedTouches[0].clientY-ts.y;if(Math.abs(dx)>d||Math.abs(dy)>d)act(Math.abs(dx)>Math.abs(dy)?(dx>0?'R':'L'):(dy>0?'D':'U'));else CVS.onclick({clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY})};
</script>
</body>
</html>
