<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Glitch Dungeon: Dark Descent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap');
        :root {
            --bg-color: #050505;
            --text-color: #d4b06a;
            --text-bright: #e8d4a8;
            --accent-color: #8a0b0b;
            --stone-color: #1a1a1a;
            --bits-color: #ffd700;
            --shadow-glow: 0 0 15px rgba(138, 11, 11, 0.4);
            --font-serif: 'Cormorant Garamond', serif;
            --font-display: 'Cinzel', serif;
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-serif); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0; padding: 10px; height: 100vh; overflow: hidden; user-select: none; }
        #start-screen { max-width: 800px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 2rem; animation: fadeIn 2s ease-in; position: absolute; z-index: 10; background: var(--bg-color); height: 100vh; justify-content: center; }
        h1 { font-family: var(--font-display); font-size: 4rem; margin: 0; text-align: center; color: var(--accent-color); text-shadow: 2px 2px 0px #000, 0 0 20px var(--accent-color); animation: pulse 4s infinite ease-in-out, unstable 0.15s infinite; }
        @media(max-width:480px){h1{font-size:2.5rem}}
        .narrative-box { background: var(--stone-color); padding: 2rem; border: 1px solid #333; border-radius: 4px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8), var(--shadow-glow); max-width: 600px; font-size: 1.3rem; line-height: 1.6; color: #ddd; position: relative; text-align: center; }
        .narrative-box::before, .narrative-box::after { content: "‚Ä†"; font-size: 2rem; color: var(--accent-color); display: block; margin: 0 auto; opacity: 0.7; }
        .narrative-box::before { margin-bottom: 0.5rem; }
        .narrative-box::after { margin-top: 0.5rem; transform: rotate(180deg); }
        .class-select { display: flex; gap: 20px; margin-top: 1rem; flex-wrap: wrap; justify-content: center; }
        .btn-class { background: rgba(0,0,0,0.8); border: 1px solid #555; color: #aaa; padding: 15px; width: 140px; cursor: pointer; text-align: center; transition: all 0.3s; display: flex; flex-direction: column; gap: 5px; }
        .btn-class:hover { border-color: var(--accent-color); color: var(--text-bright); transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .c-name { font-family: var(--font-display); font-size: 1.2rem; color: var(--accent-color); }
        .c-desc { font-size: 0.8rem; line-height: 1.2; }
        footer { margin-top: auto; opacity: 0.6; font-size: 0.9rem; margin-bottom: 2rem; }
        a { color: var(--text-color); text-decoration: none; border-bottom: 1px dotted var(--text-color); }
        #game-wrapper { display: none; flex-direction: column; align-items: center; opacity: 0; transition: opacity 2s ease-in; }
        #ui-bar { width: 100%; max-width: 640px; display: flex; flex-wrap: wrap; justify-content: space-between; margin-bottom: 10px; font-family: var(--font-display); font-size: 18px; color: var(--text-bright); border-bottom: 1px solid #444; padding-bottom: 5px; text-shadow: 1px 1px 2px #000; }
        .stat-row { width: 100%; display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8em; }
        canvas { border: 4px solid #1f1f1f; background: #000; image-rendering: pixelated; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); width: 100%; max-width: 100%; height: auto; }
        #ui-target { width: 100%; max-width: 640px; text-align: center; font-family: var(--font-display); font-size: 16px; margin-bottom: 5px; min-height: 20px; color: var(--text-bright); }
        #btn-reincarnate { display: block; background: #000; color: #c44; border: 2px solid #8a0b0b; padding: 10px 20px; font-family: var(--font-display); font-size: 1.1rem; cursor: pointer; box-shadow: 0 0 10px #8a0b0b; margin-top: 5px; pointer-events: auto; border-radius: 4px; transition: all 0.2s; }
        #btn-reincarnate:hover { background: #8a0b0b; color: #fff; }
        @keyframes pulse { 0%, 100% { text-shadow: 2px 2px 0px #000, 0 0 20px var(--accent-color); } 50% { text-shadow: 2px 2px 0px #000, 0 0 10px var(--accent-color); opacity: 0.9; } }
        @keyframes unstable { 0% { transform: translate(0,0); } 20% { transform: translate(-1px, 1px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-1px, 0); } 80% { transform: translate(1px, 1px); } 100% { transform: translate(0,0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #inv-screen { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#0a0a0a; border:2px solid var(--accent-color); padding:15px; color:var(--text-color); font-family:var(--font-serif); z-index:100; box-shadow: 0 0 30px #000; box-sizing:border-box; overflow-y:auto; -webkit-overflow-scrolling:touch; }
        .inv-grid { display:grid; grid-template-columns:repeat(5, 1fr); gap:8px; margin-top:15px; }
        .inv-slot { height:70px; border:1px solid #333; background:#111; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; font-size:11px; text-align:center; position:relative; padding:2px; transition:border-color 0.2s; }
        .inv-slot:hover { border-color:#fff; background:#1a1a1a; }
        .inv-slot.inv-empty { cursor:default; }
        .inv-slot.inv-empty:hover { border-color:#2a2a2a; background:#080808; }
        .inv-slot.equipped { border-color:var(--bits-color); box-shadow:0 0 5px var(--bits-color); }
        .inv-tooltip { position:absolute; bottom:105%; left:50%; transform:translateX(-50%); background:#050505; border:1px solid #555; padding:8px; width:180px; display:none; pointer-events:none; z-index:101; text-align:left; box-shadow:0 5px 15px rgba(0,0,0,0.8); }
        .inv-slot:hover .inv-tooltip { display:block; }
        .equip-slots { display:flex; gap:15px; justify-content:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px; }
        .equip-slot-label { font-size:10px; color:#666; text-transform:uppercase; margin-bottom:2px;}
        .btn-mode { background: #111; border: 1px solid #555; color: #ccc; padding: 10px; margin-bottom: 10px; text-align: center; cursor: pointer; font-family: var(--font-display); font-size: 1.2rem; transition: all 0.2s; user-select: none; }
        .btn-mode:hover { background: #222; border-color: #fff; }
        .mode-trash .inv-slot { border-color: #f00 !important; background: #211; }
        .mode-trash .inv-slot:hover { background: #411; cursor: not-allowed; }
        .mode-sell .inv-slot { border-color: #ffd700 !important; background: #221; }
        .mode-sell .inv-slot:hover { background: #442; cursor: alias; }
        #hud { width: 100%; max-width: 640px; background: #050505; border-top: 1px solid #333; display: flex; justify-content: center; padding: 10px; box-sizing: border-box; margin-top: 5px; font-family: var(--font-display); }
        #actions { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; width: 100%; max-width: 400px; }
        #actions button { background: #111; border: 1px solid #555; color: #ccc; font-size: 1.5rem; cursor: pointer; padding:0; display: flex; align-items: center; justify-content: center; min-height: 52px; border-radius: 4px; transition: all 0.15s; }
        #actions button:hover { background: #1a1a1a; border-color: #888; }
        .stam-low { color: #f00 !important; text-shadow: 0 0 5px #f00; animation: pulse 0.5s infinite; }
        #actions button:active { border-color: var(--accent-color); color: var(--accent-color); transform: scale(0.95); }
        .disabled { filter: grayscale(1) brightness(0.3); pointer-events: none; border-color: #222 !important; }
        #tt { position:fixed; background:rgba(0,0,0,0.95); border:1px solid #888; padding:8px 10px; pointer-events:none; display:none; z-index:100; font-size:13px; white-space:pre; max-width:280px; line-height:1.4; color:#ddd; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: linear-gradient(145deg, #a00, #600); cursor: pointer; margin-top: -10px; border: 2px solid #c5a059; box-shadow: 0 0 12px #f00, inset 0 0 4px rgba(255,255,255,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: linear-gradient(90deg, #222, #444); border-radius: 3px; border: 1px solid #555; }
        input[type=range]::-moz-range-thumb { height: 24px; width: 24px; border-radius: 50%; background: linear-gradient(145deg, #a00, #600); cursor: pointer; border: 2px solid #c5a059; box-shadow: 0 0 12px #f00; }
        input[type=range]::-moz-range-track { width: 100%; height: 6px; cursor: pointer; background: linear-gradient(90deg, #222, #444); border-radius: 3px; border: 1px solid #555; }
        input[type=range]:focus { outline: none; }
        #level-announcement { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); text-align: center; width: 100%; pointer-events: none; z-index: 50; opacity: 0; transition: opacity 1s; }
        .lvl-title { font-family: var(--font-display); font-size: 3rem; color: var(--accent-color); text-shadow: 0 0 20px #000; animation: pulse 2s infinite; }
        .lvl-hint { font-family: var(--font-serif); font-size: 1.4rem; color: #eee; text-shadow: 0 0 10px #000; margin-top: 5px; background: rgba(0,0,0,0.5); padding: 5px; display: inline-block; border-radius: 5px; }
        .inv-tabs { display:flex; gap:5px; margin-bottom:12px; }
        .inv-tab { flex:1; background:#111; border:1px solid #444; color:#888; padding:8px 4px; text-align:center; cursor:pointer; font-family:var(--font-display); font-size:0.8rem; transition:all 0.2s; }
        .inv-tab:hover { border-color:#888; color:#ccc; }
        .inv-tab.active { border-color:var(--accent-color); color:var(--accent-color); background:#1a0a0a; }
        .inv-close { position:sticky; top:0; right:0; float:right; background:#300; border:2px solid #a00; color:#f66; width:44px; height:44px; font-size:1.8rem; cursor:pointer; z-index:101; display:flex; align-items:center; justify-content:center; margin:-5px -5px 10px 10px; }
        .inv-close:hover { background:#500; color:#fff; }
        .inv-inner { max-width:700px; margin:0 auto; }
        .grim-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; max-height:55vh; overflow-y:auto; }
        .grim-entry { border:1px solid #222; background:#0a0a0a; padding:6px; font-size:10px; text-align:center; min-height:50px; display:flex; flex-direction:column; justify-content:center; }
        .grim-entry.found { border-color:#4a4; background:#0a1a0a; }
        .grim-entry.unseen { color:#333; }
        .ach-list { max-height:55vh; overflow-y:auto; }
        .ach-item { display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid #222; }
        .ach-item.locked { opacity:0.4; }
        .ach-icon { font-size:1.5rem; width:30px; text-align:center; }
        .ach-info { flex:1; }
        .ach-name { font-family:var(--font-display); font-size:0.9rem; color:var(--accent-color); }
        .ach-desc { font-size:0.75rem; color:#888; }
        .ach-prog { font-size:0.7rem; color:#666; margin-top:2px; }
        .grim-count, .ach-count { text-align:center; font-size:0.85rem; color:#888; margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:8px; }
        .inv-main { display:flex; gap:15px; }
        .inv-left { flex:1; }
        .inv-right { width:140px; border-left:1px solid #333; padding-left:15px; }
        @media(max-width:600px){ .inv-main{flex-direction:column;} .inv-right{width:100%;border-left:none;border-top:1px solid #333;padding:15px 0 0 0;} .inv-grid{grid-template-columns:repeat(4,1fr);} }
        .passive-slots { display:flex; flex-direction:column; gap:6px; }
        .passive-slot { height:50px; border:1px solid #444; background:#0a0a0a; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; font-size:9px; text-align:center; position:relative; transition:all 0.2s; }
        .passive-slot:hover { border-color:#0af; background:#0a1a1a; }
        .passive-slot.p-empty { border-style:dashed; color:#333; }
        .passive-slot.p-locked { border-color:#222; background:#050505; cursor:not-allowed; }
        .passive-slot.p-locked:hover { border-color:#222; background:#050505; }
        .passive-header { font-family:var(--font-display); font-size:0.7rem; color:#0af; margin-bottom:8px; text-align:center; }
        .upgrade-pool { margin-top:10px; border-top:1px solid #333; padding-top:10px; }
        .upgrade-pool-header { font-size:0.65rem; color:#666; margin-bottom:5px; }
        .upgrade-item { font-size:9px; padding:4px; background:#111; border:1px solid #333; margin-bottom:3px; cursor:pointer; display:flex; justify-content:space-between; }
        .upgrade-item:hover { border-color:#0af; background:#0a1a1a; }
    </style>
</head>
<body>
<div id="inv-screen" ontouchstart="event.stopPropagation()" ontouchmove="event.stopPropagation()" ontouchend="event.stopPropagation()">
    <button class="inv-close" onclick="inv_toggle()">‚úï</button>
    <div class="inv-inner">
    <div class="inv-tabs">
        <div class="inv-tab active" onclick="invTab(0)">AUSR√úSTUNG</div>
        <div class="inv-tab" onclick="invTab(1)">GRIMOIRE</div>
        <div class="inv-tab" onclick="invTab(2)">ERFOLGE</div>
        <div class="inv-tab" onclick="invTab(3)">BESTENLISTE</div>
    </div>
    <div id="inv-content-0">
        <div class="equip-slots" id="equip-display"></div>
        <div id="inv-mode-btn" onclick="cycleInvMode()" class="btn-mode">‚öîÔ∏è AUSR√úSTEN</div>
        <div class="inv-main">
            <div class="inv-left">
                <div id="inv-slots-info" style="text-align:center;font-size:0.9rem;opacity:0.7;margin:8px 0">RUCKSACK</div>
                <div class="inv-grid" id="inv-display"></div>
            </div>
            <div class="inv-right">
                <div class="passive-header">‚ö° PASSIV-SLOTS</div>
                <div class="passive-slots" id="passive-display"></div>
                <div class="upgrade-pool">
                    <div class="upgrade-pool-header">UPGRADES (KLICK = AUSR√úSTEN)</div>
                    <div id="upgrade-pool-display"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="inv-content-1" style="display:none"></div>
    <div id="inv-content-2" style="display:none"></div>
    </div>
</div>
<div id="start-screen">
    <h1>The Glitch Dungeon</h1>
    <div class="narrative-box">Die alten Mauern halten der Realit√§t nicht mehr stand. Die Zeit springt, R√§ume verschieben sich. Wirst du den Kern erreichen?</div>
    <div class="class-select" id="class-btns"></div>
    <footer>
        <span onclick="delSave()" style="cursor:pointer;border-bottom:1px dotted #8a0b0b;color:#8a0b0b;margin-right:15px">RESET</span>
        <a href="impressum.html" style="font-size:0.8rem; border-bottom:1px dotted #888; color:#888">Impressum</a>
    </footer>
</div>
<div id="game-wrapper">
    <div id="ui-bar">
        <div style="width:100%; display:flex; justify-content:space-between;">
            <div data-t="Dungeon-Tiefe">TIEFE: <span id="ui-lvl">1</span></div>
            <div data-t="Gesundheit">HP: <span id="ui-hp">10</span> <span id="ui-key"></span></div>
            <div style="color:#8a0b0b" data-t="Z√ºge bis zum Realit√§tsbruch">REALIT√ÑT: <span id="ui-glitch">20</span></div>
            <div style="color:var(--bits-color)" data-t="Gesammeltes Gold">GOLD: <span id="ui-bits">0</span></div>
            <div style="color:#f60" data-t="Ritual-Rollen (F)">BANNKREIS: <span id="ui-scrolls">0</span></div>
        </div>
        <div class="stat-row">
            <div style="color:#0af" data-t="Magische Energie">MANA: <span id="ui-mana">0/0</span></div>
            <div style="color:#dd0" data-t="Physische Ausdauer (Sinkt im Stealth!)">AUSDAUER: <span id="ui-stam">0/0</span></div>
            <div style="color:#aaa" data-t="Gew√§hlte Klasse">KLASSE: <span id="ui-class">-</span></div>
        </div>
    </div>
    <div id="ui-target">ZIEL: [Keines]</div>
    <div style="position:relative; width:100%; max-width:640px; aspect-ratio:1; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);">
        <canvas id="cvs" width="640" height="640" style="display:block;"></canvas>
        <div id="shop-ui" style="display:none; position:absolute; inset:0; flex-direction:column; justify-content:flex-end; padding-bottom:10px; pointer-events:none; z-index:20;">
            <div id="shop-footer" style="display:flex; flex-direction:column; align-items:center; background:rgba(0,0,0,0.95); padding:10px; border-top:1px solid #8a0b0b; pointer-events:auto; width:100%; box-sizing:border-box;">
                <div id="lvl-select" style="display:none; text-align:center; width:100%; margin-bottom:2px;">
                    <label style="color:#c5a059; font-family:var(--font-display); text-shadow:0 0 5px #000; font-size:0.9rem;" data-t="Starte auf einer bereits erreichten Tiefe">START: TIEFE <span id="lvl-val">1</span></label><br>
                    <input type="range" id="lvl-slider" min="1" max="1" value="1" oninput="document.getElementById('lvl-val').innerText=this.value" style="margin:5px 0;" data-t="H√∂chste erreichte Tiefe als Maximum">
                </div>
                <button id="btn-reincarnate" onclick="respawn()">Reinkarnation</button>
            </div>
        </div>
    </div>
    <div id="hud">
        <div id="actions">
            <button id="btn-skill" onclick="act('SKILL')" data-t="Spezialf√§higkeit (B)">‚ö°</button>
            <button id="btn-item" onclick="act('ITEM')" data-t="Bannkreis (F)">üìú</button>
            <button onclick="act('WAIT')" data-t="Warten (Space)">‚è≥</button>
            <button onclick="act('INV')" data-t="Inventar (I)">üéí</button>
            <button onclick="act('HELP')" data-t="Hilfe">‚ùì</button>
        </div>
    </div>
    <div id="level-announcement"></div>
    <div id="tt"></div>
</div>

<script>
const $=id=>document.getElementById(id);
const esc=s=>(s+'').replace(/[<>"'&]/g,c=>({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c]));
const TILE=32,GRID=20,UI={lvl:$('ui-lvl'),hp:$('ui-hp'),key:$('ui-key'),glitch:$('ui-glitch'),bits:$('ui-bits'),scrolls:$('ui-scrolls'),mana:$('ui-mana'),stam:$('ui-stam'),cls:$('ui-class'),target:$('ui-target')};
let actx; function au(){if(!actx){actx=new(window.AudioContext||window.webkitAudioContext)();actx.resume()}}
const CVS=$('cvs'),CTX=CVS.getContext('2d'),L_CVS=document.createElement('canvas');L_CVS.width=640;L_CVS.height=640;const L_CTX=L_CVS.getContext('2d');
const C={BG:'#050505',WALL:'#2a2a2a',FLOOR:'#111111',PL:'#e3d5b8',BITS:'#ffd700'};
const generateUID=()=>'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{let r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});

// --- BIOME CONFIG ---
// Tile-Typen: 0=Boden, 1=Wand, 2=Eis, 3=Morast(langsam), 4=Lava, 5=Astral, 6=T√ºmpel(Gift), 7=Kristall, 8=Leere, 9=Labyrinth, 10=Chaos
const BIOMES=[
 {n:"KATAKOMBEN",hint:"Massive W√§nde.",c:['#444','#222','#000','#888'],f:(x,y)=>Math.random()<0.2?1:0,hp:10,mobs:['SKEL','RAT','SPIDER','GARGOYLE']},
 {n:"EISH√ñHLE",hint:"Rutschig!",c:['#8ff','#004','#002','#aff'],f:(x,y)=>Math.sin(x/2)*Math.cos(y/2)>0.2?1:(Math.random()<0.6?2:0),hp:12,mobs:['GOLEM','WRAITH','ELEMENTAL','GARGOYLE']},
 {n:"SUMPF",hint:"Z√§her Morast.",c:['#462','#230','#120','#682'],f:(x,y)=>Math.sin(x/3)*Math.cos(y/3)>0.6?1:(Math.random()<0.35?3:(Math.random()<0.15?6:0)),hp:10,mobs:['SLIME','SNAKE','BAT','OOZE','BASILISK']},
 {n:"VULKAN",hint:"Meide die Lava!",c:['#611','#300','#200','#f40'],f:(x,y)=>Math.sin(x/2)+Math.cos(y/2)>1.2?1:(Math.random()<0.2?4:0),hp:15,mobs:['GOLEM','ELEMENTAL','EYE','BASILISK','GARGOYLE']},
 {n:"ASTRAL",hint:"Instabil.",c:['#f0f','#000','#0f0','#f0f'],f:(x,y)=>Math.random()<0.3?1:(Math.random()<0.4?5:0),hp:8,mobs:['MIMIC','EYE','GHOST','GAZER']},
 {n:"NEKRO",hint:"Der Tod lauert.",c:['#2f2','#111','#020','#0f0'],f:(x,y)=>Math.abs(Math.sin(x/4)*Math.cos(y/4))>0.5?1:0,hp:12,mobs:['SKEL','WRAITH','GHOST','OOZE'],fx:'NEKRO'},
 {n:"KRISTALL",hint:"Harte Schale.",c:['#c0f','#203','#102','#e0f'],f:(x,y)=>(x%2===0&&y%2===0)?1:(Math.random()<0.3?7:0),hp:20,mobs:['ELEMENTAL','GOLEM','GAZER','GARGOYLE']},
 {n:"LEERE",hint:"Nicht fallen!",c:['#333','#000','#000','#fff'],f:(x,y)=>Math.random()<0.15?8:(Math.random()<0.3?1:0),hp:10,mobs:['WRAITH','EYE','GAZER']},
 {n:"LABYRINTH",hint:"Verwirrend.",c:['#555','#333','#111','#aaa'],f:(x,y)=>(Math.sin(x)>0)^(Math.cos(y)>0)?1:(Math.random()<0.2?9:0),hp:15,mobs:['RAT','SPIDER','MIMIC','BASILISK']},
 {n:"CHAOS",hint:"?!?",c:['#f0f','#0f0','#00f','#ff0'],f:(x,y)=>Math.random()<0.25?1:(Math.random()<0.5?(2+Math.floor(Math.random()*9)):0),hp:10,mobs:['MIMIC','GHOST','SNAKE','OOZE','GAZER'],fx:'CHAOS'}
];
const BESTIARY={
 SKEL:{n:'Skelett',ai:'SLEEP',st:[1,1,1,1]},SLIME:{n:'Schleim',ai:'PATROL',st:[0.8,0.8,0.8,0.8]},
 BAT:{n:'Fledermaus',ai:'PATROL',st:[0.5,0.5,1.5,0.5]},GOLEM:{n:'Golem',ai:'SLEEP',st:[2.5,1.5,0.5,2]},
 GHOST:{n:'Geist',ai:'PATROL',st:[0.8,1.2,0.8,1.2]},SPIDER:{n:'Spinne',ai:'PATROL',st:[0.6,1.2,1.2,0.8]},
 RAT:{n:'Ratte',ai:'PATROL',st:[0.5,0.5,1.5,0.5]},SNAKE:{n:'Schlange',ai:'PATROL',st:[0.8,1.5,1.0,1]},
 EYE:{n:'Auge',ai:'PATROL',st:[1.2,1.5,0.8,1.5]},MIMIC:{n:'Mimic',ai:'SLEEP',st:[1.5,2,0.8,2]},
 WRAITH:{n:'Schatten',ai:'PATROL',st:[1.2,1.5,1.2,1.5]},ELEMENTAL:{n:'Elementar',ai:'PATROL',st:[2,1.5,0.8,1.8]},
 // Spezial-Monster mit Boss-Mechaniken
 OOZE:{n:'Gallertklumpen',ai:'PATROL',st:[1.4,0.5,0.5,1.2],mech:'SPLIT'},
 BASILISK:{n:'Basilisk',ai:'PATROL',st:[0.8,1.0,0.8,1.3],mech:'TRAIL'},
 GAZER:{n:'Beobachter',ai:'PATROL',st:[0.7,0.6,0.6,1.6],mech:'RANGED'},
 GARGOYLE:{n:'Gargoyle',ai:'SLEEP',st:[1.6,1.3,0.9,1.4],mech:'CHARGE'}
};
const ADJ_DATA={
 "Winzig":{hp:0.7,col:'#8b4513'},"Uralt":{hp:1.3,dmg:0.8,col:'#888'},"Verflucht":{hp:0.8,dmg:1.2,col:'#800080',fx:'CURSE'},
 "Giftig":{col:'#0f0',fx:'POISON'},"Brennend":{dmg:1.5,col:'#f40',fx:'BURN'},"Eisig":{hp:1.2,col:'#0ff',fx:'FREEZE'},
 "Dunkel":{sight:12,col:'#333'},"Riesig":{hp:2.0,spd:0.8,col:'#555'},"Flink":{spd:1.5,hp:0.6,col:'#ff0'},
 "Wild":{spd:1.2,dmg:1.2,col:'#f00'},"Hungrig":{fx:'LIFESTEAL',col:'#a00'},"Goldener":{hp:1.5,col:'#ffd700',fx:'RICH'}
};
const ADJ=Object.keys(ADJ_DATA);
const MONS=Object.keys(BESTIARY),GRIM_TOTAL=MONS.length*ADJ.length;
const ACHIEVEMENTS=[
 {id:0,n:"Erstes Blut",d:"T√∂te dein erstes Monster",i:"üíÄ",k:"kills",t:1},
 {id:1,n:"J√§ger",d:"T√∂te 50 Monster",i:"‚öîÔ∏è",k:"kills",t:50},
 {id:2,n:"Schl√§chter",d:"T√∂te 300 Monster",i:"üó°Ô∏è",k:"kills",t:300},
 {id:3,n:"Tiefer Abstieg",d:"Erreiche Tiefe 10",i:"üï≥Ô∏è",k:"maxLvl",t:10},
 {id:4,n:"Abgrund",d:"Erreiche Tiefe 25",i:"üåë",k:"maxLvl",t:25},
 {id:5,n:"Kernsucher",d:"Erreiche Tiefe 50",i:"üíé",k:"maxLvl",t:50},
 {id:6,n:"Goldgier",d:"Sammle 1.000 Gold total",i:"üí∞",k:"totalGold",t:1000},
 {id:7,n:"Schatzj√§ger",d:"Sammle 10.000 Gold total",i:"üëë",k:"totalGold",t:10000},
 {id:8,n:"Bossmeister",d:"Besiege deinen ersten Boss",i:"üèÜ",k:"bossKills",t:1},
 {id:9,n:"Legendent√∂ter",d:"Besiege 10 Bosse",i:"‚≠ê",k:"bossKills",t:10},
 {id:10,n:"Sammler",d:"Entdecke 25 Grimoire-Eintr√§ge",i:"üìñ",k:"grimCount",t:25},
 {id:11,n:"Forscher",d:"Entdecke 75 Grimoire-Eintr√§ge",i:"üìö",k:"grimCount",t:75},
 {id:12,n:"Enzyklop√§dist",d:"Entdecke alle Grimoire-Eintr√§ge",i:"üèõÔ∏è",k:"grimCount",t:GRIM_TOTAL},
 {id:13,n:"Wanderer",d:"Betrete alle 10 Biome",i:"üó∫Ô∏è",k:"biomesVisited",t:10},
 {id:14,n:"√úberlebensk√ºnstler",d:"√úberlebe 100 Z√ºge in einem Run",i:"‚è≥",k:"maxTurns",t:100},
 {id:15,n:"Zeitmeister",d:"√úberlebe 500 Z√ºge in einem Run",i:"‚åõ",k:"maxTurns",t:500}
];
let stats={kills:0,totalGold:0,bossKills:0,maxTurns:0,biomesVisited:0,grimoire:[],ach:0,deaths:0};
function loadStats(){try{let s=JSON.parse(localStorage.getItem('GD4_Stats')||'{}');stats.kills=s.k||0;stats.totalGold=s.g||0;stats.bossKills=s.b||0;stats.maxTurns=s.t||0;stats.biomesVisited=s.v||0;stats.grimoire=s.m||[];stats.ach=s.a||0;stats.deaths=s.d||0;}catch(e){}}
function saveStats(){localStorage.setItem('GD4_Stats',JSON.stringify({k:stats.kills,g:stats.totalGold,b:stats.bossKills,t:stats.maxTurns,v:stats.biomesVisited,m:stats.grimoire,a:stats.ach,d:stats.deaths}));}
function grimId(mon,adj){return MONS.indexOf(mon)*ADJ.length+ADJ.indexOf(adj);}
function discoverMon(mon,adj){let id=grimId(mon,adj);if(id>=0&&!stats.grimoire.includes(id)){stats.grimoire.push(id);checkAch();saveStats();}}
function checkAch(){let changed=false;ACHIEVEMENTS.forEach(a=>{if(stats.ach&(1<<a.id))return;let v;if(a.k==='grimCount')v=stats.grimoire.length;else if(a.k==='biomesVisited'){let c=0;for(let i=0;i<10;i++)if(stats.biomesVisited&(1<<i))c++;v=c;}else if(a.k==='maxLvl')v=meta.maxLvl;else v=stats[a.k];if(v>=a.t){stats.ach|=(1<<a.id);changed=true;showAchPopup(a);}});if(changed)saveStats();}
function showAchPopup(a){let el=document.createElement('div');el.style.cssText='position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#0a0a0a;border:2px solid #ffd700;padding:15px 25px;z-index:200;text-align:center;animation:fadeIn 0.5s;box-shadow:0 0 30px #ffd700;';el.innerHTML=`<div style="font-size:2rem">${a.i}</div><div style="font-family:var(--font-display);color:#ffd700;margin:5px 0">ERFOLG!</div><div style="color:#c5a059">${esc(a.n)}</div>`;document.body.appendChild(el);setTimeout(()=>el.remove(),3000);}
loadStats();

const TILE_FX={
 // 2: Eis - Gleiten (Eish√∂hle)
 2:(p,dx,dy)=>{p.slide=true;p.slideDir={x:dx,y:dy};addParticle(p.x,p.y,'~','#aff',0.3);},
 // 3: Morast - Verlangsamt (kostet extra Energy, nicht Ausdauer!)
 3:(p)=>{game.p.energy-=30;addParticle(p.x,p.y,'Z√ÑHER BODEN','#5c4033',0.5);},
 // 4: Lava - Brennender Boden (Vulkan) - garantierter aber niedriger Schaden
 4:(p)=>{if(!p.lavaCD){hurt(game.p,1,true,'HEISS!','#f40');p.lavaCD=3;addParticle(p.x,p.y,'üî•','#f60',0.5);}},
 // 5: Astral - Instabiler Boden (zuf√§lliger Mini-Teleport 1-2 Felder)
 5:(p)=>{if(Math.random()<0.25){let ox=p.x,oy=p.y,tries=10;do{p.x=Math.max(1,Math.min(GRID-2,ox+rnd(-2,2)));p.y=Math.max(1,Math.min(GRID-2,oy+rnd(-2,2)));tries--;}while((game.map[p.y][p.x]===1||game.enemies.some(e=>e.x===p.x&&e.y===p.y))&&tries>0);if(tries<=0){p.x=ox;p.y=oy;}else{sfx('glitch');addParticle(ox,oy,'SHIFT','#f0f');addParticle(p.x,p.y,'!','#f0f');}}},
 // 6: T√ºmpel (Sumpf) - 30% Chance auf Gift
 6:(p)=>{if(Math.random()<0.3&&game.timers.poison<=0){game.timers.poison=15;sfx('hit');addParticle(p.x,p.y,'VERGIFTET!','#0f0');}else if(game.timers.poison<=0){addParticle(p.x,p.y,'GLIBBER','#4a2',0.3);}},
 // 7: Kristall - Reflektion (Gegner sehen dich fr√ºher)
 7:(p)=>{game.crystalVision=3;addParticle(p.x,p.y,'*','#e0f',0.2);},
 // 8: Leere - Sofortiger Tod (Fall ins Nichts)
 8:(p)=>{addParticle(p.x,p.y,'F√ÑLLST...','#fff');sfx('glitch');setTimeout(()=>{meta.hp=0;addParticle(p.x,p.y,'INS NICHTS!','#f00');triggerGameOver();},300);},
 // 9: Labyrinth - Verwirrung (Richtung wird manchmal gedreht)
 9:(p)=>{if(Math.random()<0.2){game.confused=2;addParticle(p.x,p.y,'???','#ff0');}},
 // 10: Chaos - Random Effekt (nur positiv oder neutral, nie t√∂dlich)
 10:(p)=>{let r=rnd(1,6);if(r===1){meta.hp=Math.min(meta.hp+1,game.stats.maxHp);addParticle(p.x,p.y,'+1HP','#0f0');}else if(r===2){meta.mana=Math.min(meta.mana+3,game.stats.maxMana);addParticle(p.x,p.y,'+MANA','#0af');}else if(r===3){meta.stam=Math.min(meta.stam+2,game.stats.maxStam);addParticle(p.x,p.y,'+STAM','#ff0');}else if(r===4){game.timers.glitch+=2;addParticle(p.x,p.y,'+ZEIT','#f0f');}else if(r===5){sfx('glitch');addParticle(p.x,p.y,'CHAOS!','#f0f');}else{addParticle(p.x,p.y,'...','#888');}}
};

// === BOSS SYSTEM ===
const BOSSES=[
 // Lvl 5: Katakomben - TITAN (hohe HP/DMG, langsam)
 {n:"Knochenf√ºrst",type:'TITAN',hp:150,dmg:10,spd:3,col:'#eee',hint:"EIN GIGANT AUS KNOCHEN.",desc:"Langsam aber t√∂dlich. Hit & Run!"},
 // Lvl 10: Eish√∂hle - AURA (K√§lte-Zyklus)
 {n:"Yeti-Matriarchin",type:'AURA',hp:180,dmg:12,spd:4,col:'#8ff',hint:"DEIN ATEM GEFRIERT.",desc:"K√§lte-Aura l√§dt auf! Fliehe wenn sie aktiv wird.",auraRadius:4,auraStamDrain:5,auraCycle:8,auraWarn:2},
 // Lvl 15: Sumpf - SPLIT (spawnt Minions)
 {n:"Hydra-Blob",type:'SPLIT',hp:160,dmg:9,spd:5,col:'#4a2',hint:"SCHNEID EINEN KOPF AB...",desc:"Spawnt Schleime bei Schaden! Fokus-Schaden!",splitChance:0.5,splitMax:8},
 // Lvl 20: Vulkan - TRAIL (tempor√§re Lava)
 {n:"Magma-Wurm",type:'TRAIL',hp:200,dmg:15,spd:6,col:'#f60',hint:"DER BODEN WIRD LAVA.",desc:"Hinterl√§sst Lava! T√∂te ihn schnell!",trailDuration:6},
 // Lvl 25: Astral - PHASE (Teleport + Mana Drain)
 {n:"Der Beobachter",type:'PHASE',hp:140,dmg:8,spd:7,col:'#f0f',hint:"ER IST √úBERALL.",desc:"Teleportiert! Mana Drain in Phase 2!",rangedDmg:5,drainRadius:5,drainAmount:4},
 // Lvl 30: Nekro - SUMMON (Skelette + Mana Steal)
 {n:"Lich-K√∂nig",type:'SUMMON',hp:180,dmg:10,spd:6,col:'#0f0',hint:"DER TOD GEHORCHT IHM.",desc:"Beschw√∂rt Skelette! Stiehlt Mana zur Heilung!",summonCD:3,maxSummons:5,manaSteal:6},
 // Lvl 35: Kristall - REFLECT
 {n:"Prisma-Golem",type:'REFLECT',hp:250,dmg:12,spd:4,col:'#e0f',hint:"DAS LICHT BRICHT SICH.",desc:"Reflektiert 30% Schaden! Zauber verst√§rkt!",reflectChance:0.35},
 // Lvl 40: Leere - VOID (Arena schrumpft)
 {n:"Nihil",type:'VOID',hp:160,dmg:11,spd:7,col:'#fff',hint:"DIE LEERE VERSCHLINGT.",desc:"Sichere Felder schrumpfen!",voidInterval:2},
 // Lvl 45: Labyrinth - CHARGE (Sturmangriff)
 {n:"Minotaurus",type:'CHARGE',hp:220,dmg:18,spd:5,col:'#a52',hint:"ER ST√úRMT AUF DICH ZU.",desc:"L√§dt auf und st√ºrmt! Ausweichen!",chargeCD:3,chargeSteps:8},
 // Lvl 50: Chaos - RANDOM (alle Mechaniken)
 {n:"Glitch-Avatar",type:'RANDOM',hp:280,dmg:14,spd:9,col:'RAINBOW',hint:"?!? DIE REALIT√ÑT BRICHT ?!?",desc:"Wechselt zuf√§llig alle Boss-Mechaniken!",mechInterval:4}
];

function getFreeNear(cx,cy){for(let i=0;i<20;i++){let x=cx+rnd(-2,2),y=cy+rnd(-2,2);if(x>0&&x<GRID-1&&y>0&&y<GRID-1&&game.map[y][x]!==1&&!game.enemies.some(e=>e.x===x&&e.y===y)&&!(x===game.p.x&&y===game.p.y))return{x,y};}return null;}
function getRandomArenaPos(){for(let i=0;i<30;i++){let x=rnd(4,GRID-5),y=rnd(4,GRID-5);if(game.map[y][x]!==1&&!game.enemies.some(e=>e.x===x&&e.y===y)&&!(x===game.p.x&&y===game.p.y))return{x,y};}return null;}

// --- DATA ---
const CLASSES={
 WARRIOR:{n:'Krieger',hp:20,mana:0,stam:10,mine:10,noise:10,spd:8,item:'Schwert',desc:'Robust, Laut'},
 ROGUE:{n:'Schurke',hp:12,mana:0,stam:15,mine:3,noise:2,spd:15,item:'Dolch',desc:'Schnell, Leise'},
 MAGE:{n:'Magier',hp:8,mana:20,stam:8,mine:1,noise:5,spd:10,item:'Stab',desc:'Weise, Fragil'}
};
const I_MATS=[{n:"Holz",m:0.5,c:'#a65',b:{stamCost:-1}},{n:"Eisen",m:1.0,c:'#ccc'},{n:"Stahl",m:1.5,c:'#fff'},{n:"Obsidian",m:2.0,c:'#404',b:{critChance:0.05}},{n:"Mithril",m:3.0,c:'#0ff',b:{stamCost:-2}},{n:"Adamant",m:5.0,c:'#0f0'},{n:"Licht",m:8.0,c:'#ff0',b:{torchRadius:50}},{n:"Arkan",m:15.0,c:'#f0f',b:{manaRegen:1}},{n:"Gold",m:1.2,c:'#ffd700',b:{lootMul:0.2}},{n:"Vampirisch",m:2.0,c:'#800',b:{lifesteal:0.1}}];
const I_TYPES=[{n:["Dolch","Kris"],target:'ROGUE',s:"WEAPON",baseCost:20,mods:{dmg:2,speed:2,stealthCost:-1,critChance:0.05}},{n:["Schwert","Langschwert"],target:'WARRIOR',s:"WEAPON",baseCost:40,mods:{dmg:3.5,maxStam:4}},{n:["Axt","Beil"],target:'WARRIOR',s:"WEAPON",baseCost:60,mods:{dmg:4,speed:-1.5,maxStam:1}},{n:["Hammer","Keule"],target:'WARRIOR',s:"WEAPON",baseCost:70,mods:{dmg:4.5,speed:-2,maxStam:1.5}},{n:["Stab","Zepter"],target:'MAGE',s:"WEAPON",baseCost:30,mods:{dmg:1.5,maxMana:10,spellDmg:2}},{n:["Hacke","Pickel"],target:'ALL',s:"WEAPON",baseCost:30,mods:{dmg:1,mine:4,speed:-1}},{n:["Robe"],target:'MAGE',s:"ARMOR",baseCost:40,mods:{def:0,maxMana:10,manaRegen:0.2}},{n:["Leder"],target:'ROGUE',s:"ARMOR",baseCost:60,mods:{def:1,dodgeChance:0.1, speed:2}},{n:["Platte"],target:'WARRIOR',s:"ARMOR",baseCost:100,mods:{def:3,speed:-4,noise:3}},{n:["Ring"],target:'ALL',s:"RELIC",baseCost:50,mods:{shopLuck:5}},{n:["Amulett"],target:'ALL',s:"RELIC",baseCost:80,mods:{critChance:0.02}}];
const I_SUFFIX=[{n:"des Blutes",stat:"lifesteal",v:0.05},{n:"des Windes",stat:"dodgeChance",v:0.1},{n:"des Zorns",stat:"critChance",v:0.1},{n:"der Gier",stat:"lootMul",v:0.2},{n:"des Lichts",stat:"torchRadius",v:30},{n:"der Zeit",stat:"glitchMod",v:5},{n:"der Stille",stat:"noise",v:-0.2}];
const R_NAMES=["Abgenutzt","Alt","Solide","Raffiniert","Edel","Meisterhaft","K√∂niglich","Mystisch","Legend√§r","G√∂ttlich","EWIG"];
const RARITIES=R_NAMES.map((n,i)=>({name:n,mul:1+i*0.8,chance:Math.max(0.1,50/Math.pow(2,i)),minLevel:Math.max(1,i*4-2),col:i===R_NAMES.length-1?'RAINBOW':`hsl(${40},${20+(i/10)*80}%,${50+i*2}%)`}));
const R_MAP=RARITIES.reduce((a,c)=>{a[c.name]=c;return a},{});
/* Kategorien: Schurke=50, Standard=70, Magier/Luxus=90, Struktur=150 */
/* Preis = Basis * 2.2^TierID, Stat = Basis * 1.5^TierID */
const ITEM_CATS={schurke:50,standard:70,magier:90,struktur:150};
const pw15=t=>Math.pow(1.5,t),pw22=t=>Math.pow(2.2,t);

const ITEM_POOL=[
 // SCHURKE (Basis 50)
 {name:'Reflexe',vis:'ARMOR',cat:'schurke',unit:'%',desc:'Ausweich-Chance',
  calc:t=>Math.min(0.4,parseFloat((0.02*pw15(t.id||0)).toFixed(2))),
  eff:(m,v)=>{m.dodgeChance=(m.dodgeChance||0)+v;}},
 {name:'Schattenkunst',vis:'BOOK',cat:'schurke',unit:'EFF',desc:'Tarnung g√ºnstiger',
  calc:t=>Math.max(1,Math.ceil(0.5*pw15(t.id||0))),
  eff:(m,v)=>{m.stealthDrain=Math.max(1,(m.stealthDrain||3)-v);}},
 {name:'Pr√§zision',vis:'WEAPON',cat:'schurke',unit:'%',desc:'Kritische-Treffer-Chance',
  calc:t=>Math.min(0.5,parseFloat((0.02*pw15(t.id||0)).toFixed(2))),
  eff:(m,v)=>{m.critChance=(m.critChance||0)+v;}},
 {name:'Stille',vis:'BOOK',cat:'schurke',unit:'HEIMLICHKEIT',desc:'Monster h√∂ren sp√§ter',
  // NEU: Logarithmische Kurve. Tier 1 = 0.5, Tier 10 = max 2.0. Kein Overkill mehr.
  calc:t=>parseFloat(Math.min(2.0, 0.5 + (t.id||0)*0.15).toFixed(1)),
  eff:(m,v)=>{m.noise=Math.max(0,(m.noise||5)-v);}},
 // STANDARD (Basis 70)
 {name:'Vitalit√§t',vis:'POTION',cat:'standard',unit:'MAX-LE',desc:'Mehr Lebensenergie',
  calc:t=>Math.max(1,(2*pw15(t.id||0))|0),
  eff:(m,v)=>{m.maxHp=(m.maxHp||0)+v;}},
 {name:'Ausdauer',vis:'POTION',cat:'standard',unit:'MAX-AU',desc:'Mehr Ausdauer',
  calc:t=>Math.max(1,(2*pw15(t.id||0))|0),
  eff:(m,v)=>{m.maxStam=(m.maxStam||0)+v;}},
 {name:'Kondition',vis:'BOOK',cat:'standard',unit:'REG',desc:'Schnellere Ausdauer-Erholung',
  calc:t=>parseFloat(Math.max(0.05,0.1*pw15(t.id||0)).toFixed(2)),
  eff:(m,v)=>{m.stamRegen=(m.stamRegen||0)+v;}},
 {name:'Sch√§rfe',vis:'WEAPON',cat:'standard',unit:'SCH',desc:'Mehr Grundschaden',
  calc:t=>Math.max(1,(1*pw15(t.id||0))|0),
  eff:(m,v)=>{m.dmg=(m.dmg||0)+v;}},
 {name:'Abh√§rtung',vis:'BOOK',cat:'standard',unit:'DEF',desc:'Weniger Schaden erleiden',
  calc:t=>parseFloat(Math.max(0.1,0.2*pw15(t.id||0)).toFixed(1)),
  eff:(m,v)=>{m.def=(m.def||0)+v;}},
 {name:'Bergbau',vis:'BOOK',cat:'standard',unit:'KRAFT',desc:'W√§nde schneller zerst√∂ren',
  calc:t=>Math.max(1,Math.ceil(0.5*pw15(t.id||0))),
  eff:(m,v)=>{m.mine=(m.mine||0)+v;}},
 {name:'Fokus',vis:'BOOK',cat:'standard',unit:'RND',desc:'Mehr Zeit bis Glitch',
  calc:t=>Math.max(1,Math.ceil(1.5*pw15(t.id||0))),
  eff:(m,v)=>{m.glitchMod=(m.glitchMod||0)+v;}},
 // MAGIER/LUXUS (Basis 90)
 {name:'Willenskraft',vis:'POTION',cat:'magier',unit:'MAX-MP',desc:'Mehr Magiekraft',
  calc:t=>Math.max(1,(3*pw15(t.id||0))|0),
  eff:(m,v)=>{m.maxMana=(m.maxMana||0)+v;}},
 {name:'Meditation',vis:'BOOK',cat:'magier',unit:'REG',desc:'Schnellere Magie-Erholung',
  calc:t=>parseFloat(Math.max(0.05,0.1*pw15(t.id||0)).toFixed(2)),
  eff:(m,v)=>{m.manaRegen=(m.manaRegen||0)+v;}},
 {name:'Arkane Macht',vis:'BOOK',cat:'magier',unit:'MAG',desc:'St√§rkere Zauber',
  calc:t=>Math.max(1,(1*pw15(t.id||0))|0),
  eff:(m,v)=>{m.spellDmg=(m.spellDmg||0)+v;}},
 {name:'Gier',vis:'CHEST',cat:'magier',unit:'%',desc:'Mehr Gold aus Beute',
  calc:t=>parseFloat((0.1*pw15(t.id||0)).toFixed(1)),
  eff:(m,v)=>{m.lootMul=(m.lootMul||1)+v;}},
 {name:'Gl√ºck',vis:'RELIC',cat:'magier',unit:'GLK',desc:'Bessere Shop-Angebote',
  calc:t=>Math.max(1,(1*pw15(t.id||0))|0),
  eff:(m,v)=>{m.shopLuck=(m.shopLuck||0)+v;}},
 // STRUKTUR (Basis 150) - Diese sind NICHT passiv, sondern sofort!
 {name:'Rucksack',vis:'CHEST',cat:'struktur',unit:'PLATZ',desc:'Mehr Inventar (max 10)',instant:true,
  calc:t=>1,max:()=>meta.invSlots<10,
  run:(m,v)=>{m.invSlots=Math.min(10,(m.invSlots||3)+v);save();}},
 {name:'Schaufenster',vis:'CHEST',cat:'struktur',unit:'SLOT',desc:'Mehr Shop-Auswahl (max 6)',instant:true,
  calc:t=>1,max:()=>meta.shopSlots<6,
  run:(m,v)=>{m.shopSlots=Math.min(6,(m.shopSlots||2)+v);save();}},
 {name:'Lichtbringer',vis:'RELIC',cat:'struktur',unit:'FACKEL',desc:'Zus√§tzliche Fackel (max 3)',instant:true,
  calc:t=>1,max:()=>meta.torchCount<3,
  run:(m,v)=>{m.torchCount=Math.min(3,(m.torchCount||0)+v);save();}},
 {name:'Passiv-Slot',vis:'RELIC',cat:'struktur',unit:'SLOT',desc:'Zus√§tzlicher Passiv-Slot (max 8)',instant:true,
  calc:t=>1,max:()=>(meta.passiveSlots||3)<8,
  run:(m,v)=>{m.passiveSlots=Math.min(8,(m.passiveSlots||3)+v);save();}}
];

// Preisberechnung: Basis * 2.2^TierID
function getItemPrice(item,tier){
 let base=ITEM_CATS[item.cat]||70,tId=tier.id||0;
 // Struktur-Items: Preisprogression basierend auf bereits gekauften
 if(item.cat==='struktur'){
  let owned=0;
  if(item.name==='Rucksack')owned=(meta.invSlots||3)-3;
  else if(item.name==='Schaufenster')owned=(meta.shopSlots||2)-2;
  else if(item.name==='Lichtbringer')owned=meta.torchCount||0;
  else if(item.name==='Passiv-Slot')owned=(meta.passiveSlots||3)-3;
  return Math.floor(base*pw22(owned)*(1-((meta.discount||0)/100)));
 }
 return Math.floor(base*pw22(tId)*(1-((meta.discount||0)/100)));
}

// --- TUTORIAL CONFIG ---
const TUT_DONE=localStorage.getItem('GD4_Tut')==='1';
const CLASS_INFO={
 WARRIOR:{full:'Der Krieger ist ein z√§her Nahk√§mpfer mit viel Lebensenergie und Ausdauer. Er ist ideal f√ºr Einsteiger.',
  skill:'WIRBELWIND: Dr√ºcke B oder tippe auf ‚ö°\nSchl√§gt ALLE Feinde um dich herum gleichzeitig und st√∂√üt sie zur√ºck. Kostet 5 Ausdauer.',
  style:'Geh direkt auf Feinde zu und vernichte sie im Nahkampf. Deine hohe HP verzeiht Fehler.',
  speed:'Du bist etwas langsamer - Feinde bewegen sich √∂fter, bevor du wieder dran bist. Aber deine Ausdauer h√§lt lange.'},
 ROGUE:{full:'Der Schurke ist schnell, leise und t√∂dlich aus dem Hinterhalt. Wenig HP erfordern taktisches Vorgehen.',
  skill:'UNSICHTBARKEIT: Dr√ºcke B oder tippe auf ‚ö°\nDu wirst unsichtbar und Feinde verlieren dich. Verbraucht kontinuierlich Ausdauer!',
  style:'Nutze Stealth strategisch. Schleiche an Feinden vorbei oder greife aus der Unsichtbarkeit an.',
  speed:'Du bist SEHR schnell - oft machst du 2 Z√ºge, bevor Feinde reagieren. Nutze diesen Vorteil!'},
 MAGE:{full:'Der Magier wirkt m√§chtige Fernkampfzauber, ist aber sehr fragil. Halte Abstand!',
  skill:'FEUERBALL: Dr√ºcke B oder tippe auf ‚ö° zum Zielen, dann KLICKE/TIPPE auf ein Zielfeld.\nTrifft das Ziel + umliegende Felder. Kostet 5 Mana.',
  style:'Halte immer Abstand! Nutze Feuerb√§lle aus der Distanz. Im Nahkampf bist du schnell tot.',
  speed:'Mittlere Geschwindigkeit. Dein Mana regeneriert sich langsam - spare es f√ºr wichtige K√§mpfe.'}
};
const TUT_HINTS={
 move:'BEWEGUNG: Nutze WASD, Pfeiltasten oder WISCHE √ºber den Bildschirm.\nAlternativ: TIPPE auf ein Feld zum Hinlaufen.\n\nJeder Schritt ist ein ZUG - das Spiel ist rundenbasiert!\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 wait:'WARTEN: Dr√ºcke LEERTASTE oder tippe auf ‚è≥\n\nFeinde bewegen sich nur, wenn DU etwas tust. Manchmal ist Warten die beste Strategie!\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 combat:'KAMPF: Laufe IN einen Feind, um anzugreifen.\n\nACHTUNG: Feinde greifen DIAGONAL an - du nicht! Daher: Warte oft, bis der Feind direkt neben dir steht.\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 item:'AUSR√úSTUNG GEFUNDEN!\n\n√ñffne dein Inventar mit I oder üéí.\nOben: MODUS w√§hlen (Ausr√ºsten/Wegwerfen).\nUnten: Rucksack mit freien Slots.\n\nKLICKE auf die Waffe zum Ausr√ºsten!\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 itemEquipped:'AUSGER√úSTET!\n\nDeine neue Waffe ist f√ºr deine Klasse optimiert (KLASSEN-BONUS)!\n\nTIPP: Auch R√ºstungen und Relikte haben Klassen-Boni. Achte auf gr√ºne "KLASSEN-BONUS" Markierungen im Tooltip!\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 forkWarning:'HALT! Du k√§mpfst noch mit der ALTEN GABEL!\n\nDu hast eine bessere Waffe eingesammelt. √ñffne das Inventar (I oder üéí) und r√ºste sie aus!\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 key:'SCHL√úSSEL GEFUNDEN!\n\nDein Hauptziel in jeder Ebene:\n1. Finde den Schl√ºssel\n2. Erreiche den Ausgang\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 exit:'DER AUSGANG!\n\nMit Schl√ºssel: Betreten f√ºhrt zur n√§chsten Ebene.\nOhne Schl√ºssel: Die T√ºr ist verschlossen.\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 glitch:'REALIT√ÑTSBRUCH (GLITCH):\n\nDer rote Z√§hler oben tickt mit jedem Zug herunter. Bei 0: W√§nde verschieben sich und neue Feinde spawnen!\n\nSei z√ºgig, aber nicht √ºberst√ºrzt.\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 speed:'GESCHWINDIGKEIT:\n\nJe schneller du bist, desto √∂fter bist du dran, bevor Feinde agieren k√∂nnen.\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 shop:'DER SCHATTENH√ÑNDLER:\n\nHier kaufst du PASSIVE UPGRADES f√ºr GOLD.\nGekaufte Upgrades landen in deinem UPGRADE-POOL.\nR√ºste sie in PASSIV-SLOTS aus (Inventar > rechte Seite)!\n\n‚Ä¢ TIPPEN auf Item = Kaufen\n‚Ä¢ üîÑ NEUES ANGEBOT = Neue Items\n‚Ä¢ ‚è∏ MERKMODUS = Items reservieren\n\n[Beliebige Taste / Tippen zum Fortfahren]',
 exhausted:'ERSCH√ñPFT!\n\nDeine Ausdauer ist aufgebraucht!\n\n‚Ä¢ Angreifen nicht m√∂glich\n‚Ä¢ Spezialf√§higkeit blockiert\n\nL√ñSUNG: Warten (‚è≥) oder Weglaufen regeneriert Ausdauer!\n\n[Beliebige Taste / Tippen zum Fortfahren]'
};
let tutRoom=0,tutMsg='',tutMsgTimer=0,tutStartItem=null,tutWaitForKey=false,tutShownShop=false,tutShownExhaust=false;

// --- STATE ---
let meta={uid:generateUID(),bits:0,hp:10,maxHp:10,mana:10,maxMana:10,stam:10,maxStam:10,dmg:1,mine:1,noise:5,speed:10,def:0,manaRegen:0,stamRegen:1,class:'WARRIOR',critChance:0.05,dodgeChance:0.05,lootMul:1.0,glitchMod:0,scrolls:0,torchCount:0,torchRadius:150,maxLvl:1,shopSlots:2,invSlots:3,shopLuck:0,discount:0,lockedItems:[],spellDmg:0,stealthCost:5,stealthDrain:3,passiveSlots:3,upgradePool:[],equippedPassives:[]};
if(localStorage.getItem('GD4_Dark_Save')){try{let s=JSON.parse(localStorage.getItem('GD4_Dark_Save'));meta.uid=s.uid||generateUID();meta.bits=s.bits;meta.maxLvl=s.maxLvl;meta.shopSlots=s.shopSlots||2;meta.shopLuck=s.shopLuck||0;meta.invSlots=s.invSlots||3;meta.torchCount=s.torchCount||0;meta.lockedItems=s.lockedItems||[];meta.passiveSlots=s.passiveSlots||3;meta.upgradePool=s.upgradePool||[];meta.equippedPassives=s.equippedPassives||[];}catch(e){localStorage.removeItem('GD4_Dark_Save');}}
let game={invMode:0,mode:'GAME',map:[],walls:new Uint8Array(GRID*GRID),level:1,biome:0,turnCount:0,p:{x:1,y:1,en:0,dir:{x:0,y:1},hidden:false,lavaCD:0,falling:false,slide:false,slideDir:null},enemies:[],items:[],particles:[],shopItems:[],torches:[],inventory:[],equipment:{WEAPON:null,ARMOR:null,RELIC:null},stats:{},key:{x:0,y:0},exit:{x:0,y:0},timers:{glitch:25,stun:0,shake:0,poison:0,burn:0},lockMode:false,rerollCost:10,lockInput:false,aiming:false,mouse:{x:0,y:0},confused:0,crystalVision:0,boss:null,bossAura:null,chargePreview:null,isBossLevel:false};

// --- LOGIC ---
const cb=$('class-btns');
Object.keys(CLASSES).forEach(k=>{
 let c=CLASSES[k],ci=CLASS_INFO[k];
 let rec=k==='WARRIOR'?'<span style="color:#0f0;font-size:0.7rem"> ‚òÖ EMPFOHLEN</span>':'';
 cb.innerHTML+=`<div class="btn-class" onclick="enterDungeon('${k}')"><span class="c-name">${esc(c.n)}${rec}</span><span class="c-desc">${esc(c.desc)}</span><span class="c-desc" style="font-size:0.65rem;color:#888;margin-top:4px">HP:${c.hp} SPD:${c.spd} ${c.mana>0?'MANA:'+c.mana:'STAM:'+c.stam}</span></div>`;
});

function enterDungeon(k){
 let n=prompt("Name des Helden:")||"Anonym";if(!n)return;
 localStorage.removeItem('GD4_Dark_Save');
 meta={uid:generateUID(),name:n,bits:0,hp:10,maxHp:10,mana:10,maxMana:10,stam:10,maxStam:10,dmg:1,mine:1,noise:5,speed:10,def:0,manaRegen:0,stamRegen:1,class:k,critChance:0.05,dodgeChance:0.05,lootMul:1.0,glitchMod:0,scrolls:0,torchCount:0,torchRadius:150,maxLvl:1,shopSlots:2,invSlots:3,shopLuck:0,discount:0,lockedItems:[],spellDmg:0,stealthCost:5,stealthDrain:3,passiveSlots:3,upgradePool:[],equippedPassives:[]};
 let c=CLASSES[k];Object.assign(meta,{class:k,hp:c.hp,maxHp:c.hp,mana:c.mana,maxMana:c.mana,stam:c.stam,maxStam:c.stam,mine:c.mine,noise:c.noise,speed:c.spd,dmg:1});
 let sItem={id:Math.random(),name:'Start '+c.item,target:k,slot:'WEAPON',col:'#aaa',mods:{dmg:2}};
 if(k==='MAGE')sItem.mods={dmg:1,maxMana:5};if(k==='ROGUE')sItem.mods={dmg:2,speed:2};tutStartItem=sItem;
 $('start-screen').style.opacity=0;
 setTimeout(()=>{$('start-screen').style.display='none';let gw=$('game-wrapper');gw.style.display='flex';void gw.offsetWidth;gw.style.opacity='1';initGame(TUT_DONE?sItem:null);},800);
}
function initGame(s){
 game.inventory=[];
 // Tutorial: Starte mit "Alte Gabel" statt echter Waffe
 if(!s){let fork={id:0.999,name:'Alte Gabel',target:'NONE',slot:'WEAPON',col:'#654',mods:{dmg:0.5}};game.equipment={WEAPON:fork,ARMOR:null,RELIC:null};}
 else game.equipment={WEAPON:s,ARMOR:null,RELIC:null};
 game.turnCount=0;tutRoom=0;calcStats();
 // Starte Tutorial (Level 0) wenn noch nicht abgeschlossen
 startLevel(TUT_DONE?1:0);requestAnimationFrame(loop);
}
function startLevel(lvl){
 // Tutorial-Level
 if(lvl===0){startTutorial();return;}
 // Boss-Level Check (alle 5 Levels)
 if(lvl%5===0&&lvl>0){startBossLevel(lvl);return;}
 game.isBossLevel=false;game.boss=null;game.bossAura=null;game.chargePreview=null;
 $('shop-ui').style.display='none';
 if(lvl>game.level){meta.mana=Math.min(game.stats.maxMana,meta.mana+(game.stats.maxMana/3)|0);addParticle(game.p.x,game.p.y,"MANA +",'#0af');}
 game.level=lvl;if(lvl>meta.maxLvl){meta.maxLvl=lvl;checkAch();save();}
 game.biome=(Math.floor((lvl-1)/5))%BIOMES.length;let B=BIOMES[game.biome];
 if(!(stats.biomesVisited&(1<<game.biome))){stats.biomesVisited|=(1<<game.biome);checkAch();saveStats();}
 document.documentElement.style.setProperty('--accent-color',B.c[3]);
 let el=$('level-announcement');el.innerHTML=`<div class="lvl-title">${B.n}</div><div class="lvl-hint">${B.hint||""}</div>`;el.style.opacity=1;setTimeout(()=>el.style.opacity=0,4000);
 C.WALL=B.c[0];C.FLOOR=B.c[1];C.MUD=B.c[2];C.PL=B.c[3];
 game.p.hasKey=false;game.p.hidden=false;game.p.lavaCD=0;game.p.falling=false;game.p.slide=false;game.p.slideDir=null;game.confused=0;game.crystalVision=0;game.nekroTimer=0;game.timers={glitch:15+(game.stats.glitchMod||0),stun:0,shake:0,poison:0,burn:0,curse:0};game.glitchCount=0;
 game.enemies=[];game.items=[];game.particles=[];game.torches=[];game.walls.fill(0);
 meta.hp=Math.min(meta.hp,game.stats.maxHp);if(meta.hp<=0)meta.hp=game.stats.maxHp;
 game.map=[];
 for(let y=0;y<GRID;y++){let r=[];for(let x=0;x<GRID;x++){if(x===0||x===GRID-1||y===0||y===GRID-1){r.push(1);game.walls[y*GRID+x]=99;}else{let t=B.f(x,y);if(x===1&&y===1)t=0;if(t===1)game.walls[y*GRID+x]=Math.min(20,B.hp+lvl);r.push(t);}}game.map.push(r);}
 
 let getRndPos=()=>{let x,y;do{x=rnd(1,GRID-2);y=rnd(1,GRID-2);}while(x===1&&y===1);return {x,y}};
 game.key=getRndPos();game.exit=getRndPos();
 
 function carvePath(x1,y1,x2,y2){
  let x=x1,y=y1,dx=Math.sign(x2-x1),dy=Math.sign(y2-y1);
  let steps=0;
  while((x!==x2||y!==y2)&&steps<100){
   if(x!==x2)x+=dx;else if(y!==y2)y+=dy;
   if(game.map[y][x]===1)game.walls[y*GRID+x]=5;
   else if(game.map[y][x]!==1)game.map[y][x]=0;
   steps++;
  }
 }
 game.map[game.key.y][game.key.x]=0;game.walls[game.key.y*GRID+game.key.x]=0;
 game.map[game.exit.y][game.exit.x]=0;game.walls[game.exit.y*GRID+game.exit.x]=0;
 carvePath(1,1,game.key.x,game.key.y);carvePath(game.key.x,game.key.y,game.exit.x,game.exit.y);
 spawnActors();updateUI();
}
function startBossLevel(lvl){
 game.isBossLevel=true;
 let bossIdx=Math.floor((lvl-1)/5)%BOSSES.length;
 let bossData=BOSSES[bossIdx];
 let B=BIOMES[bossIdx];
 
 $('shop-ui').style.display='none';
 if(lvl>game.level){meta.mana=Math.min(game.stats.maxMana,meta.mana+(game.stats.maxMana/2)|0);}
 game.level=lvl;if(lvl>meta.maxLvl){meta.maxLvl=lvl;save();}
 game.biome=bossIdx;
 
 document.documentElement.style.setProperty('--accent-color',B.c[3]);
 C.WALL=B.c[0];C.FLOOR=B.c[1];C.MUD=B.c[2];C.PL=B.c[3];
 
 let el=$('level-announcement');
 el.innerHTML=`<div class="lvl-title" style="color:#f00;text-shadow:0 0 20px #f00;">‚öîÔ∏è BOSS: ${bossData.n} ‚öîÔ∏è</div><div class="lvl-hint">${bossData.hint}</div><div class="lvl-hint" style="font-size:1rem;opacity:0.7">${bossData.desc}</div>`;
 el.style.opacity=1;setTimeout(()=>el.style.opacity=0,5000);
 
 game.p.hasKey=true;game.p.hidden=false;game.p.lavaCD=0;game.p.falling=false;game.p.slide=false;
 game.timers={glitch:999,stun:0,shake:0,poison:0,burn:0,curse:0};
 game.enemies=[];game.items=[];game.particles=[];game.torches=[];
 game.boss=null;game.bossAura=null;game.chargePreview=null;game.confused=0;game.crystalVision=0;
 meta.hp=Math.min(meta.hp,game.stats.maxHp);if(meta.hp<=0)meta.hp=game.stats.maxHp;
 
 // Arena generieren
 game.map=[];game.walls.fill(0);
 for(let y=0;y<GRID;y++){let r=[];for(let x=0;x<GRID;x++){
  if(x<3||x>GRID-4||y<3||y>GRID-4){r.push(1);game.walls[y*GRID+x]=99;}
  else{let t=0;
   if(bossIdx===1&&Math.random()<0.15)t=2;
   else if(bossIdx===2&&Math.random()<0.1)t=6;
   else if(bossIdx===3&&Math.random()<0.08)t=4;
   else if(bossIdx===4&&Math.random()<0.15)t=5;
   else if(bossIdx===6&&Math.random()<0.12)t=7;
   r.push(t);
  }
 }game.map.push(r);}
 
 // S√§ulen (au√üer bei VOID/CHARGE)
 if(!['VOID','CHARGE'].includes(bossData.type)){
  [[6,6],[6,13],[13,6],[13,13]].forEach(p=>{if(Math.random()<0.6){game.map[p[1]][p[0]]=1;game.walls[p[1]*GRID+p[0]]=40;}});
 }
 
 game.p.x=10;game.p.y=GRID-5;game.map[game.p.y][game.p.x]=0;
 game.exit={x:10,y:4};game.map[game.exit.y][game.exit.x]=0;
 game.key={x:-1,y:-1};
 
 // Boss spawnen
 let hpMul=1+bossIdx*0.25,dmgMul=1+bossIdx*0.15;
 let boss={x:10,y:6,hp:Math.floor(bossData.hp*hpMul),max:Math.floor(bossData.hp*hpMul),dmg:Math.floor(bossData.dmg*dmgMul),bits:100+lvl*25,name:bossData.n,col:bossData.col,hue:bossIdx*36,state:'HUNT',type:'BOSS',speed:bossData.spd,energy:50,stun:0,fx:'NONE',isBoss:true,bossType:bossData.type,bossData:bossData,auraTick:0,trailTiles:[],summonTimer:0,chargeTimer:0,mechTimer:0,phase:1,splitCount:0,voidTimer:0,voidRadius:7,charging:false,chargeDir:null,chargeSteps:0,currentMech:0};
 game.enemies.push(boss);game.boss=boss;
 
 game.torches=[];for(let i=0;i<(meta.torchCount||0);i++)game.torches.push({x:rnd(4,15),y:rnd(4,15)});
 game.p.energy=100;meta.stam=game.stats.maxStam;
 updateUI();sfx('glitch');sfx('glitch');
}
// === TUTORIAL SYSTEM ===
function startTutorial(){
 game.level=0;game.isBossLevel=false;game.boss=null;$('shop-ui').style.display='none';
 let ci=CLASS_INFO[meta.class];
 // Announcement mit Klasseninfo
 let el=$('level-announcement');
 el.innerHTML=`<div class="lvl-title" style="font-size:2rem">EINF√úHRUNG</div><div class="lvl-hint" style="max-width:500px;margin:auto">${ci.full}</div>`;
 el.style.opacity=1;setTimeout(()=>el.style.opacity=0,6000);
 document.documentElement.style.setProperty('--accent-color','#c5a059');
 C.WALL='#444';C.FLOOR='#1a1a1a';C.MUD='#111';C.PL='#c5a059';
 game.p.hasKey=false;game.p.hidden=false;game.p.x=2;game.p.y=10;
 game.timers={glitch:999,stun:0,shake:0,poison:0,burn:0,curse:0};
 game.enemies=[];game.items=[];game.particles=[];game.torches=[];game.confused=0;
 meta.hp=game.stats.maxHp;meta.stam=game.stats.maxStam;meta.mana=game.stats.maxMana;
 // Tutorial-Map generieren (linearer Dungeon)
 game.map=[];game.walls.fill(0);
 for(let y=0;y<GRID;y++){let r=[];for(let x=0;x<GRID;x++){
  // Rahmen
  if(x===0||x===GRID-1||y===0||y===GRID-1){r.push(1);game.walls[y*GRID+x]=99;}
  // Hauptkorridor (y=10)
  else if(y===10&&x>=1&&x<=18){r.push(0);}
  // Raum 1: Bewegung (x=1-4, y=8-12)
  else if(x>=1&&x<=4&&y>=8&&y<=12){r.push(0);}
  // Korridor zu Raum 2 (x=5, y=10)
  else if(x===5&&y===10){r.push(0);}
  // Raum 2: Warten+Kampf (x=6-10, y=7-13)
  else if(x>=6&&x<=10&&y>=7&&y<=13){r.push(0);}
  // Korridor zu Raum 3 (x=11, y=10)
  else if(x===11&&y===10){r.push(0);}
  // Raum 3: Skill (x=12-16, y=6-14)
  else if(x>=12&&x<=16&&y>=6&&y<=14){r.push(0);}
  // Korridor zum Ausgang (x=17-18, y=10)
  else if(x>=17&&x<=18&&y===10){r.push(0);}
  // Alles andere = Wand
  else{r.push(1);game.walls[y*GRID+x]=50;}
 }game.map.push(r);}
 // Startwaffe als Item platzieren
 if(tutStartItem)game.items.push({x:4,y:10,type:'EQUIP',val:tutStartItem,isTutItem:true});
 // Schl√ºssel und Ausgang
 game.key={x:15,y:10};game.exit={x:18,y:10};
 // Tutorial-Trigger-Zonen und Feinde
 tutRoom=0;tutWaitForKey=true;tutShownShop=false;
 // Schwacher Trainings-Feind im Kampfraum (schl√§ft bis Spieler nah)
 game.enemies.push({x:9,y:10,hp:6,max:6,dmg:1,bits:5,name:'√úbungs-Skelett',col:'#888',hue:0,state:'SLEEP',type:'SKEL',speed:5,energy:0,stun:0,fx:'NONE',sight:4,isTutEnemy:true});
 // Skill-Demo-Feinde je nach Klasse
 if(meta.class==='WARRIOR'){
  // Krieger: Ratten werden dynamisch gespawnt wenn Spieler Raum 3 betritt
 }else if(meta.class==='ROGUE'){
  // Patrouillierende Wache f√ºr Stealth
  game.enemies.push({x:14,y:10,hp:10,max:10,dmg:3,bits:5,name:'W√§chter-Golem',col:'#666',hue:0,state:'PATROL',type:'GOLEM',speed:4,energy:0,stun:0,fx:'NONE',sight:5,isTutEnemy:true,isSkillEnemy:true});
 }else{
  // Fernziel f√ºr Feuerball - etwas entfernt
  game.enemies.push({x:15,y:7,hp:8,max:8,dmg:1,bits:4,name:'Ziel-Schleim',col:'#4a4',hue:120,state:'SLEEP',type:'SLIME',speed:3,energy:0,stun:0,fx:'NONE',sight:4,isTutEnemy:true,isSkillEnemy:true});
 }
 game.p.energy=100;game.lockInput=false;
 showTutMsg(TUT_HINTS.move);
 updateUI();
}
function showTutMsg(msg){tutMsg=msg;tutMsgTimer=9999;tutWaitForKey=true;game.lockInput=true;}
function dismissTutMsg(){if(tutWaitForKey&&tutMsgTimer>0){tutMsg='';tutMsgTimer=0;tutWaitForKey=false;game.lockInput=false;}}
function checkTutTriggers(){
 if(game.level!==0||tutWaitForKey)return;
 let px=game.p.x,py=game.p.y,ci=CLASS_INFO[meta.class];
 // Waffe eingesammelt (liegt im Inventar)
 if(tutRoom===0&&game.inventory.find(i=>i.isTutItem||i===tutStartItem)){
  tutRoom=0.5;showTutMsg(TUT_HINTS.item);return;
 }
 // Waffe ausger√ºstet
 if(tutRoom===0.5&&game.equipment.WEAPON&&game.equipment.WEAPON.name!=='Alte Gabel'){
  tutRoom=1;showTutMsg(TUT_HINTS.itemEquipped);return;
 }
 // Raum 2 betreten: Kampf-Erkl√§rung
 if(tutRoom===1&&px>=6&&px<=7){
  tutRoom=1.5;showTutMsg(TUT_HINTS.combat);return;
 }
 // Warte-Tipp wenn Feind jagt
 if(tutRoom===1.5&&px>=6&&px<=10){
  let e=game.enemies.find(en=>en.name==='√úbungs-Skelett');
  if(e&&e.state==='HUNT'){tutRoom=1.7;showTutMsg(TUT_HINTS.wait);return;}
 }
 // Nach erstem Kill: Skill-Erkl√§rung
 if(tutRoom>=1&&tutRoom<2&&!game.enemies.find(e=>e.name==='√úbungs-Skelett')){
  tutRoom=2;showTutMsg('Gut gemacht!\n\nWeiter zum n√§chsten Raum f√ºr deine\nSPEZIALF√ÑHIGKEIT:\n\n'+ci.skill+'\n\n[Beliebige Taste / Tippen zum Fortfahren]');return;
 }
 // Raum 3: Skill-Raum betreten - Ratten SPAWNEN um Spieler herum!
 if(tutRoom===2&&px>=14&&py>=8&&py<=12){
  tutRoom=3;
  // Krieger: Ratten direkt um den Spieler spawnen f√ºr Wirbelwind-Demo
  if(meta.class==='WARRIOR'){
   game.enemies=game.enemies.filter(e=>!e.isSkillEnemy);
   let offs=[[-1,-1],[1,-1],[-1,1],[1,1]],cnt=0;
   offs.forEach(o=>{let rx=px+o[0],ry=py+o[1];if(game.map[ry][rx]!==1&&cnt<3){
    game.enemies.push({x:rx,y:ry,hp:4,max:4,dmg:1,bits:3,name:'Trainings-Ratte',col:'#654',hue:30,state:'HUNT',type:'RAT',speed:8,energy:0,stun:0,fx:'NONE',sight:6,isTutEnemy:true,isSkillEnemy:true});
    addParticle(rx,ry,"!",'#f00');cnt++;
   }});
  }else game.enemies.filter(e=>e.isSkillEnemy).forEach(e=>{e.state='HUNT';});
  let hint=meta.class==='WARRIOR'?'UMZINGELT!\n\nDu bist von Ratten umzingelt!\nNutze JETZT den WIRBELWIND (B oder ‚ö°) um\nALLE gleichzeitig zu treffen und zur√ºckzusto√üen!':
           meta.class==='ROGUE'?'EIN STARKER W√ÑCHTER!\n\nEr w√ºrde dich im Kampf verletzen.\nNutze UNSICHTBARKEIT (B oder ‚ö°) zum\nVorbeischleichen - oder f√ºr einen √úberraschungsangriff!':
           'EIN FERNZIEL!\n\nDr√ºcke B oder tippe ‚ö° zum ZIELEN,\ndann KLICKE/TIPPE auf den Feind f√ºr\neinen m√§chtigen Feuerball!';
  showTutMsg(hint+'\n\n[Beliebige Taste / Tippen zum Fortfahren]');return;
 }
 // Schl√ºssel aufgehoben
 if(tutRoom>=3&&game.p.hasKey&&tutRoom<5){
  tutRoom=5;showTutMsg(TUT_HINTS.key);return;
 }
 // Am Ausgang angekommen
 if(tutRoom===5&&px>=17){
  tutRoom=6;showTutMsg(TUT_HINTS.exit+'\n\nNach dem Tutorial beginnt das echte Abenteuer!\nDer GLITCH-Z√ÑHLER wird dann aktiv.\n\n[Beliebige Taste / Tippen zum Fortfahren]');return;
 }
}
// Gabel-Warnung wenn mit Gabel angegriffen wird
function checkForkWarning(){
 if(game.level!==0)return false;
 if(game.equipment.WEAPON&&game.equipment.WEAPON.name==='Alte Gabel'&&game.inventory.find(i=>i===tutStartItem||i.isTutItem)){
  showTutMsg(TUT_HINTS.forkWarning);return true;
 }
 return false;
}
function endTutorial(){
 localStorage.setItem('GD4_Tut','1');
 // Echte Startwaffe ausr√ºsten falls noch nicht geschehen
 if(tutStartItem&&game.equipment.WEAPON&&game.equipment.WEAPON.name==='Alte Gabel'){
  game.equipment.WEAPON=tutStartItem;calcStats();
 }
 // HP voll auff√ºllen nach Tutorial
 meta.hp=game.stats.maxHp;meta.stam=game.stats.maxStam;meta.mana=game.stats.maxMana;
 addParticle(game.p.x,game.p.y,"TUTORIAL ABGESCHLOSSEN!",'#ffd700');
 sfx('shop');sfx('shop');
 // Weiter zu Level 1
 setTimeout(()=>startLevel(1),500);
}
function spawnActors(){
 let getFree=()=>{let x,y,t=0;do{x=rnd(1,GRID-2);y=rnd(1,GRID-2);t++}while(((game.map[y][x]===1&&game.walls[y*GRID+x]>5)||(x==1&&y==1))&&t<200);return {x,y}};
 game.p.energy=100;game.p.actNoise=0;meta.mana=game.stats.maxMana;game.lockInput=false;
 let B=BIOMES[game.biome],cnt=2+(game.level/2|0);
 for(let i=0;i<cnt;i++){
  let pos=getFree(),pow=rnd(game.level*0.8,game.level*1.3),key=B.mobs[rnd(0,B.mobs.length-1)],type=BESTIARY[key];
  let hp=(Math.max(1,(2+pow*2.5+Math.sqrt(pow)*2)*type.st[0])|0),dmg=(Math.max(1,(1+pow*0.25)*type.st[1])|0),spd=(Math.max(1,10*type.st[2])|0);
  let hue=rnd(0,360),adj=ADJ[rnd(0,ADJ.length-1)],ad=ADJ_DATA[adj];
  if(B.n==="EISH√ñHLE")hue=200;if(B.n==="VULKAN")hue=0;if(B.n==="SUMPF")hue=100;if(B.n==="NEKRO")hue=120;
  let mob={x:pos.x,y:pos.y,hp:(hp*(ad.hp||1))|0,max:(hp*(ad.hp||1))|0,dmg:(dmg*(ad.dmg||1))|0,bits:((15+pow*10)*type.st[3]*game.stats.lootMul)|0,hue,type:key,col:ad.col,fx:ad.fx,sight:ad.sight||6,name:`${adj} ${type.n}`,energy:rnd(0,50),speed:(spd*(ad.spd||1))|0,state:type.ai};
  discoverMon(key,adj);
  // Spezial-Monster-Eigenschaften
  if(type.mech){
   mob.mech=type.mech;
   if(type.mech==='SPLIT')mob.hasSplit=false;
   if(type.mech==='TRAIL')mob.trailTiles=[];
   if(type.mech==='RANGED')mob.rangedCD=0;
   if(type.mech==='CHARGE'){mob.chargeCD=0;mob.charging=false;mob.chargeDir=null;mob.chargeSteps=0;}
  }
  game.enemies.push(mob);
 }
 for(let i=0;i<3;i++){let p=getFree(),it=Math.random()<0.3?{x:p.x,y:p.y,type:'EQUIP',val:genItem(game.level)}:{x:p.x,y:p.y,type:rnd(0,3)};if(it.type===2&&game.level>2&&Math.random()<0.1)it.mimic=true;game.items.push(it);}
 for(let i=0;i<(meta.torchCount||0);i++)game.torches.push(getFree());
}
function hurt(e,dmg,isP,txt,col,isSpell){
 if(isP)meta.hp-=dmg;else e.hp-=dmg;
 sfx('hit');addParticle(e.x,e.y,txt||`-${dmg}`,col||(isP?'#f00':'#fff'));
 addHitFX(e.x,e.y,isSpell?'burst':'slash',col||(isP?'#f00':'#fff'));
 if(isP){game.timers.shake=5;updateUI();if(meta.hp<=0)triggerGameOver();}
 else{e.state='HUNT';
  // Split-Mechanik f√ºr OOZE (normale Monster)
  if(e.mech==='SPLIT'&&!e.hasSplit&&e.hp>0&&e.hp<e.max*0.5){
   e.hasSplit=true;let pos=getFreeNear(e.x,e.y);
   if(pos){
    let baby={x:pos.x,y:pos.y,hp:Math.floor(e.max*0.3),max:Math.floor(e.max*0.3),dmg:Math.floor(e.dmg*0.6),bits:Math.floor(e.bits*0.3),name:"Klein-"+e.name.split(' ').pop(),col:e.col,hue:e.hue,state:'HUNT',type:e.type,speed:e.speed+2,energy:0,stun:0,fx:e.fx,isMinion:true};
    game.enemies.push(baby);addParticle(pos.x,pos.y,"TEILUNG!",'#4f4');sfx('glitch');
   }
  }
  // Boss onHit Mechaniken
  if(e.isBoss){
   let b=e,bd=b.bossData;
   if(b.bossType==='SPLIT'&&b.splitCount<(bd.splitMax||6)&&Math.random()<(bd.splitChance||0.5)){
    b.splitCount++;let pos=getFreeNear(b.x,b.y);
    if(pos){game.enemies.push({x:pos.x,y:pos.y,hp:15,max:15,dmg:3,bits:5,name:"Hydra-Spross",col:'#6a4',hue:100,state:'HUNT',type:'SLIME',speed:10,energy:0,stun:0,fx:'NONE',isMinion:true});addParticle(pos.x,pos.y,"SPROSS!",'#4a2');sfx('glitch');}
   }
   if(b.bossType==='PHASE'&&b.phase<3){
    let pos=getRandomArenaPos();if(pos){addParticle(b.x,b.y,"*SHIFT*",'#f0f');b.x=pos.x;b.y=pos.y;b.stun=1;addParticle(b.x,b.y,"!",'#f0f');sfx('glitch');}
    let hpPct=b.hp/b.max;if(hpPct<0.33)b.phase=3;else if(hpPct<0.66)b.phase=2;
   }
   if(b.bossType==='REFLECT'&&Math.random()<(bd.reflectChance||0.3)){
    let ref=Math.floor(dmg*(isSpell?0.6:0.3));hurt(game.p,ref,true,"REFLEKTIERT!",'#e0f');addParticle(b.x,b.y,"*PRISMA*",'#e0f');
   }
   if(b.bossType==='RANDOM'){
    let mech=['TITAN','AURA','SPLIT','TRAIL','PHASE','SUMMON','REFLECT','VOID','CHARGE'][b.currentMech];
    if(mech==='PHASE'){let pos=getRandomArenaPos();if(pos){b.x=pos.x;b.y=pos.y;sfx('glitch');}}
    else if(mech==='SPLIT'&&Math.random()<0.4){let pos=getFreeNear(b.x,b.y);if(pos)game.enemies.push({x:pos.x,y:pos.y,hp:8,max:8,dmg:2,bits:2,name:"Glitch-Splitter",col:'#f0f',hue:300,state:'HUNT',type:'SLIME',speed:12,energy:0,stun:0,fx:'NONE',isMinion:true});}
    else if(mech==='REFLECT'&&Math.random()<0.25)hurt(game.p,Math.floor(dmg*0.3),true,"REFLEKTIERT!",'#e0f');
   }
  }
  if(e.hp<=0){
   game.enemies=game.enemies.filter(x=>x!==e);meta.bits+=e.bits;stats.kills++;stats.totalGold+=e.bits;addParticle(e.x,e.y,`+${e.bits}`,C.BITS);sfx('kill');checkAch();saveStats();
   if(e.isBoss){game.boss=null;stats.bossKills++;addParticle(e.x,e.y,"BOSS BESIEGT!",'#ffd700');sfx('kill');sfx('shop');game.items.push({x:e.x,y:e.y,type:'EQUIP',val:genItem(game.level+5)});game.items.push({x:e.x+1,y:e.y,type:'EQUIP',val:genItem(game.level+3)});checkAch();saveStats();}
   if(e.fx==='RICH'){game.items.push({x:e.x,y:e.y,type:'EQUIP',val:genItem(game.level+2)});addParticle(e.x,e.y,"JACKPOT!",'#ffd700');}
  }}
}
function addHitFX(x,y,type,col){game.hitFX=game.hitFX||[];game.hitFX.push({x,y,type,col,t:8});}
function movePlayer(dx,dy){
 // Labyrinth-Verwirrung: Richtung kann sich drehen
 if(game.confused>0){let r=rnd(1,4);if(r===1)[dx,dy]=[-dx,-dy];else if(r===2)[dx,dy]=[dy,-dx];else if(r===3)[dx,dy]=[-dy,dx];game.confused--;if(game.confused===0)addParticle(game.p.x,game.p.y,'KLAR!','#fff');}
 game.p.actNoise=1;let nx=game.p.x+dx,ny=game.p.y+dy;game.p.dir={x:dx||game.p.dir.x,y:dy||game.p.dir.y};
 // Lava-Cooldown reduzieren
 if(game.p.lavaCD>0)game.p.lavaCD--;
 if(game.map[ny][nx]===1){
  let wid=ny*GRID+nx;
  if(game.walls[wid]>0){
   if(game.p.hidden){addParticle(game.p.x,game.p.y,"Psst...",'#555');return false;}
   let cost=Math.max(0,2+(game.stats.stamCost||0));if(meta.stam<cost){addParticle(game.p.x,game.p.y,"M√úDE!",'#555');return false;}
   meta.stam-=cost;game.exert=1;game.p.actNoise=3;
   let dmg=(game.stats.mine||meta.mine);
   if(game.walls[wid]<=dmg){game.walls[wid]=0;sfx('step');game.map[ny][nx]=0;addParticle(nx,ny,"ZERST√ñRT",'#fff');}
   else{game.walls[wid]-=dmg;game.timers.shake=2;sfx('hit');addParticle(nx,ny,"RISS",'#777');}
  }return true;
 }
 let t=game.enemies.find(e=>e.x===nx&&e.y===ny||(e.isBoss&&Math.abs(e.x-nx)<=1&&Math.abs(e.y-ny)<=1));
 if(t){
  // Tutorial: Warnung wenn mit Gabel angegriffen wird obwohl bessere Waffe vorhanden
  if(game.level===0&&checkForkWarning())return false;
  if(game.timers.curse>0&&Math.random()<0.25){sfx('hit');addParticle(nx,ny,"VERFEHLT",'#888');game.p.actNoise=3;return true;}
  if(game.p.hidden){addParticle(game.p.x,game.p.y,"Psst...",'#555');return false;}
  let cost=Math.max(1,3+(game.stats.stamCost||0));if(meta.stam<cost){addParticle(game.p.x,game.p.y,"M√úDE!",'#555');if(!tutShownExhaust){tutShownExhaust=true;showTutMsg(TUT_HINTS.exhausted);}return false;}
  meta.stam-=cost;game.exert=1;game.p.actNoise=3;sfx('attack');
  let isCrit=Math.random()<game.stats.critChance,dmg=game.stats.dmg*(isCrit?2:1);
  if(game.stats.lifesteal&&Math.random()<0.3)meta.hp=Math.min(meta.hp+(dmg*game.stats.lifesteal),game.stats.maxHp);
  hurt(t,dmg,false,isCrit?`KRIT ${dmg}!`:null,isCrit?'#ff0':null);
  game.timers.shake=2;return true;
 }
 // Sumpf/Morast wird jetzt √ºber TILE_FX behandelt (verlangsamt durch Energy-Abzug)
 game.p.x=nx;game.p.y=ny;sfx('step');
 // Tile-Effekte ausl√∂sen
 let tile=game.map[ny][nx];if(TILE_FX[tile])TILE_FX[tile](game.p,dx,dy);
 // Eis-Gleiten (Tile 2) - verbesserte Logik
 if(game.p.slide&&game.p.slideDir){
  let sd=game.p.slideDir,snx=nx+sd.x,sny=ny+sd.y;
  if(snx>0&&snx<GRID-1&&sny>0&&sny<GRID-1&&game.map[sny][snx]!==1&&!game.enemies.some(e=>e.x===snx&&e.y===sny)){
   setTimeout(()=>{if(game.mode==='GAME')movePlayer(sd.x,sd.y);},80);
  }
  game.p.slide=false;game.p.slideDir=null;
 }
 checkPickups();
 // Tutorial-Trigger pr√ºfen
 if(game.level===0)checkTutTriggers();
 return true;
}
function processTurns(){
 game.lockInput=true;let safe=0;
 function tick(){
  safe++;if(safe>1000){game.p.energy=100;game.lockInput=false;return;}
  if(game.p.energy>=100){
   game.lockInput=false;
   if(game.p.hidden){meta.stam-=(game.stats.stealthDrain||3);if(meta.stam<=0){meta.stam=0;game.p.hidden=false;addParticle(game.p.x,game.p.y,"AUFGEDECKT!",'#f00');sfx('hit');}}
   else{if(!game.exert)meta.stam=Math.min(game.stats.maxStam,meta.stam+(game.stats.stamRegen||1));game.exert=0;}
   if(game.stats.manaRegen>0)meta.mana=Math.min(game.stats.maxMana,meta.mana+game.stats.manaRegen);
   turnLogic();return;
  }
  game.p.energy+=meta.speed;game.enemies.forEach(e=>e.energy+=e.speed);
  game.enemies.forEach(e=>{if(e.energy>=100){e.energy-=100;enemyAct(e);}});
  if(game.p.energy<100)setTimeout(tick,0);else tick();
 }tick();
}
function checkAggro(e){
 if(game.p.hidden)return false;if(e.state==='HUNT')return true;
 // Mimics wachen nur bei Pickup auf
 if(e.type==='MIMIC'&&e.state==='SLEEP')return false;
 let d=Math.hypot(game.p.x-e.x,game.p.y-e.y),steps=Math.ceil(d),wd=0;
 // Z√§hle W√§nde zwischen Monster und Spieler - jede Wand d√§mpft den L√§rm
 for(let i=1;i<steps;i++){let tx=game.p.x+(e.x-game.p.x)*(i/steps)|0,ty=game.p.y+(e.y-game.p.y)*(i/steps)|0;if(game.walls[ty*GRID+tx]>0)wd+=3;}
 // Kristall-Vision: erh√∂hte Sichtweite f√ºr beide Seiten
 let sightMod=game.crystalVision>0?3:0;
 // Noise-Berechnung: Spieler-Noise * Aktivit√§tslevel, ged√§mpft durch W√§nde
 let playerNoise=game.stats.noise*(game.p.actNoise||0);
 let effectiveNoise=Math.max(0,playerNoise-wd*0.5);
 let effectiveDist=d+wd;
 let hearRange=e.sight+sightMod+effectiveNoise*0.5;
 // Nur wenn in Reichweite, dann Wahrscheinlichkeits-Check
 if(effectiveDist<hearRange){
  // Wahrscheinlichkeit basiert auf Distanz: nah=hoch, fern=niedrig
  let detectChance=Math.max(0.1,Math.min(0.95,1-(effectiveDist/hearRange)+effectiveNoise*0.05));
  if(Math.random()<detectChance){e.state='HUNT';addParticle(e.x,e.y,"!",'#f00');sfx('hit');return true;}
 }return false;
}
function enemyAct(e){
 if(e.stun>0){e.stun--;return;}
 
 // Boss-spezifische KI
 if(e.isBoss){bossAct(e);return;}
 
 // Trail-Monster: Gift-Pfade verwalten
 if(e.mech==='TRAIL'&&e.trailTiles){
  e.trailTiles=e.trailTiles.filter(t=>{t.life--;if(t.life<=0){game.map[t.y][t.x]=0;return false;}return true;});
 }
 
 // Charge-Monster: Charge-Logik (k√ºrzerer Charge als Boss)
 if(e.mech==='CHARGE'){
  if(e.charging&&e.chargeSteps>0){
   let nx=e.x+e.chargeDir.x,ny=e.y+e.chargeDir.y;
   if(nx>0&&nx<GRID-1&&ny>0&&ny<GRID-1&&game.map[ny][nx]!==1){
    if(nx===game.p.x&&ny===game.p.y){hurt(game.p,e.dmg*1.5,true,"RAMME!",'#a52');e.charging=false;e.chargeSteps=0;return;}
    e.x=nx;e.y=ny;e.chargeSteps--;addParticle(e.x,e.y,"üí®",'#888',0.3);
   }else{e.charging=false;e.chargeSteps=0;e.stun=1;addParticle(e.x,e.y,"*KRACH*",'#ff0');game.timers.shake=2;}
   return;
  }else if(e.charging){e.charging=false;}
  else{e.chargeCD++;if(e.chargeCD>=3&&e.state==='HUNT'){let d=Math.hypot(game.p.x-e.x,game.p.y-e.y);if(d<6&&d>1.5){e.chargeCD=0;e.chargeDir={x:Math.sign(game.p.x-e.x),y:Math.sign(game.p.y-e.y)};if(Math.abs(game.p.x-e.x)>Math.abs(game.p.y-e.y))e.chargeDir.y=0;else e.chargeDir.x=0;if(e.chargeDir.x===0&&e.chargeDir.y===0)e.chargeDir.x=1;e.chargeSteps=3;e.charging=true;addParticle(e.x,e.y,"!!",'#a52');return;}}}
 }
 
 // Ranged-Monster: Fernkampf
 if(e.mech==='RANGED'&&e.state==='HUNT'){
  e.rangedCD=(e.rangedCD||0)+1;
  let d=Math.hypot(game.p.x-e.x,game.p.y-e.y);
  if(e.rangedCD>=2&&d>1.5&&d<5&&hasLOS(e.x,e.y,game.p.x,game.p.y)){
   e.rangedCD=0;addParticle(e.x,e.y,"üëÅÔ∏è",'#f0f');hurt(game.p,Math.max(1,Math.floor(e.dmg*0.6)),true,"BLICK!",'#f0f');return;
  }
 }
 
 if(!checkAggro(e)){if(e.state!=='SLEEP'&&Math.random()<0.2){let dx=rnd(-1,1),dy=rnd(-1,1);if(!isBlocked(e.x+dx,e.y+dy,e)){e.x+=dx;e.y+=dy;}}return;}
 let dx=Math.sign(game.p.x-e.x),dy=Math.sign(game.p.y-e.y),nx=e.x+dx,ny=e.y+dy;
 if(isBlocked(nx,ny,e)){if(!isBlocked(e.x+dx,e.y,e)){nx=e.x+dx;ny=e.y;}else if(!isBlocked(e.x,e.y+dy,e)){nx=e.x;ny=e.y+dy;}else return;}
 if(nx===game.p.x&&ny===game.p.y){
  if(Math.random()<game.stats.dodgeChance)addParticle(game.p.x,game.p.y,"AUSGEWICHEN",'#aaa');
  else{
   let dmg=Math.max(1,e.dmg-(game.stats.def||0));hurt(game.p,dmg,true);
   if(e.fx==='POISON'){game.timers.poison=20;addParticle(game.p.x,game.p.y,"VERGIFTET!",'#0f0');}
   if(e.fx==='BURN'&&Math.random()<0.3){game.timers.burn=10;addParticle(game.p.x,game.p.y,"BRENNT!",'#f60');}
   if(e.fx==='CURSE'&&Math.random()<0.4){game.timers.curse=10;addParticle(game.p.x,game.p.y,"FLUCH",'#80f');}
   if(e.fx==='FREEZE'){meta.stam=Math.max(0,meta.stam-5);addParticle(game.p.x,game.p.y,"EISIG!",'#0ff');}
   if(e.fx==='LIFESTEAL'){e.hp=Math.min(e.max,e.hp+e.dmg);addParticle(e.x,e.y,"LEBENSDIEB",'#a00');}
  }
 }else{
  let ox=e.x,oy=e.y;
  e.x=nx;e.y=ny;
  // Trail-Monster: hinterl√§sst Gift-Pfad
  if(e.mech==='TRAIL'&&game.map[oy][ox]!==1&&game.map[oy][ox]!==6){
   game.map[oy][ox]=6;
   e.trailTiles.push({x:ox,y:oy,life:4});
   addParticle(ox,oy,"~",'#0f0',0.3);
  }
 }
}

function bossAct(b){
 let bd=b.bossData,ox=b.x,oy=b.y;
 
 // Typ-spezifische onTurn Logik
 if(b.bossType==='AURA'){
  b.auraTick++;let phase=b.auraTick%bd.auraCycle;
  if(phase>=bd.auraCycle-bd.auraWarn&&phase<bd.auraCycle-1){
   b.auraActive=false;addParticle(b.x,b.y,phase===bd.auraCycle-bd.auraWarn?"K√ÑLTE...":"AURA!!",'#8ff');
   game.bossAura={x:b.x,y:b.y,r:bd.auraRadius,warn:true};
  }else if(phase>=bd.auraCycle-1||phase<1){
   b.auraActive=true;game.bossAura={x:b.x,y:b.y,r:bd.auraRadius,warn:false};
   let d=Math.hypot(game.p.x-b.x,game.p.y-b.y);
   if(d<=bd.auraRadius){meta.stam=Math.max(0,meta.stam-bd.auraStamDrain);addParticle(game.p.x,game.p.y,"EISIGE K√ÑLTE!",'#0ff');if(meta.stam<=0)hurt(game.p,2,true,"ERFRIERUNG!",'#0ff');}
  }else{b.auraActive=false;game.bossAura=null;}
 }
 
 if(b.bossType==='TRAIL'){
  b.trailTiles=b.trailTiles.filter(t=>{t.life--;if(t.life<=0){game.map[t.y][t.x]=0;return false;}return true;});
 }
 
 if(b.bossType==='PHASE'){
  if(b.phase>=2){let d=Math.hypot(game.p.x-b.x,game.p.y-b.y);if(d<=bd.drainRadius){let drain=b.phase===3?bd.drainAmount*2:bd.drainAmount;meta.mana=Math.max(0,meta.mana-drain);addParticle(game.p.x,game.p.y,`-${drain} MANA`,'#f0f');}}
  let d=Math.hypot(game.p.x-b.x,game.p.y-b.y);if(d>1.5&&d<6&&Math.random()<0.35){addParticle(game.p.x,game.p.y,"AUGENSTRAHL!",'#f0f');hurt(game.p,bd.rangedDmg,true);}
 }
 
 if(b.bossType==='SUMMON'){
  b.summonTimer++;let d=Math.hypot(game.p.x-b.x,game.p.y-b.y);
  if(d<=bd.manaSteal&&meta.mana>0&&Math.random()<0.3){let steal=Math.min(meta.mana,5);meta.mana-=steal;b.hp=Math.min(b.max,b.hp+steal*2);addParticle(game.p.x,game.p.y,`-${steal} MANA`,'#0f0');addParticle(b.x,b.y,`+${steal*2} HP`,'#0f0');}
  if(b.summonTimer>=bd.summonCD){let minions=game.enemies.filter(e=>e.isMinion).length;if(minions<bd.maxSummons){b.summonTimer=0;let pos=getFreeNear(b.x,b.y);if(pos){game.enemies.push({x:pos.x,y:pos.y,hp:20,max:20,dmg:4,bits:8,name:"Lich-Diener",col:'#2f2',hue:120,state:'HUNT',type:'SKEL',speed:8,energy:0,stun:0,fx:'NONE',isMinion:true});addParticle(pos.x,pos.y,"ERWACHT!",'#0f0');sfx('glitch');}}}
 }
 
 if(b.bossType==='VOID'){
  b.voidTimer++;if(b.voidTimer>=bd.voidInterval){b.voidTimer=0;b.voidRadius=Math.max(3,b.voidRadius-0.4);
   for(let y=3;y<GRID-3;y++)for(let x=3;x<GRID-3;x++){let d=Math.hypot(x-10,y-10);if(d>b.voidRadius&&game.map[y][x]!==1&&game.map[y][x]!==8&&Math.random()<0.25){game.map[y][x]=8;addParticle(x,y,"...",'#333',0.2);}}
   addParticle(10,10,"LEERE W√ÑCHST",'#fff');}
 }
 
 if(b.bossType==='CHARGE'){
  if(b.charging&&b.chargeSteps>0){
   let nx=b.x+b.chargeDir.x,ny=b.y+b.chargeDir.y;
   if(nx>2&&nx<GRID-3&&ny>2&&ny<GRID-3&&game.map[ny][nx]!==1){
    if(nx===game.p.x&&ny===game.p.y){hurt(game.p,b.dmg*2,true,"√úBERRANNT!",'#a52');b.charging=false;b.chargeSteps=0;return;}
    b.x=nx;b.y=ny;b.chargeSteps--;addParticle(b.x,b.y,"üí®",'#a52',0.5);
   }else{b.charging=false;b.chargeSteps=0;b.stun=2;addParticle(b.x,b.y,"*WUMM*",'#ff0');game.timers.shake=5;}
   return;
  }else if(b.charging){b.charging=false;}
  else{b.chargeTimer++;if(b.chargeTimer>=bd.chargeCD){b.chargeTimer=0;b.chargeDir={x:Math.sign(game.p.x-b.x),y:Math.sign(game.p.y-b.y)};if(Math.abs(game.p.x-b.x)>Math.abs(game.p.y-b.y))b.chargeDir.y=0;else b.chargeDir.x=0;if(b.chargeDir.x===0&&b.chargeDir.y===0)b.chargeDir.x=1;b.chargeSteps=bd.chargeSteps;b.charging=true;addParticle(b.x,b.y,"SCHNAUBT!",'#a52');game.chargePreview={x:b.x,y:b.y,dx:b.chargeDir.x,dy:b.chargeDir.y,steps:b.chargeSteps};setTimeout(()=>game.chargePreview=null,1200);return;}}
 }
 
 if(b.bossType==='RANDOM'){
  b.mechTimer++;if(b.mechTimer>=bd.mechInterval){b.mechTimer=0;b.currentMech=(b.currentMech+1)%9;let mech=['TITAN','AURA','SPLIT','TRAIL','PHASE','SUMMON','REFLECT','VOID','CHARGE'][b.currentMech];addParticle(b.x,b.y,`MODUS: ${mech}`,'#ff0');sfx('glitch');if(['PHASE','SUMMON','VOID'].includes(mech)&&meta.mana>0){meta.mana=Math.max(0,meta.mana-5);addParticle(game.p.x,game.p.y,"-5 MANA",'#f0f');}}
  let mech=['TITAN','AURA','SPLIT','TRAIL','PHASE','SUMMON','REFLECT','VOID','CHARGE'][b.currentMech];
  if(mech==='AURA'){let d=Math.hypot(game.p.x-b.x,game.p.y-b.y);if(d<=2){meta.stam=Math.max(0,meta.stam-2);addParticle(game.p.x,game.p.y,"CHAOS-K√ÑLTE!",'#0ff');}}
  else if(mech==='SUMMON'&&Math.random()<0.15){let minions=game.enemies.filter(e=>e.isMinion).length;if(minions<3){let pos=getFreeNear(b.x,b.y);if(pos)game.enemies.push({x:pos.x,y:pos.y,hp:10,max:10,dmg:3,bits:3,name:"Glitch-Spawn",col:'#f0f',hue:300,state:'HUNT',type:'SLIME',speed:10,energy:0,stun:0,fx:'NONE',isMinion:true});}}
  else if(mech==='VOID'&&Math.random()<0.15){let rx=rnd(4,GRID-5),ry=rnd(4,GRID-5);if(game.map[ry][rx]!==1)game.map[ry][rx]=8;}
 }
 
 // Standard-Bewegung (au√üer bei CHARGE)
 if(b.bossType==='CHARGE'&&b.charging)return;
 
 // Boss Nahkampf-Check: Spieler neben Boss-Hitbox (3x3)?
 let pDist=Math.max(Math.abs(game.p.x-b.x),Math.abs(game.p.y-b.y));
 if(pDist<=2){
  // Spieler in Angriffsreichweite!
  if(Math.random()<game.stats.dodgeChance)addParticle(game.p.x,game.p.y,"AUSGEWICHEN",'#aaa');
  else{let dmg=Math.max(1,b.dmg-(game.stats.def||0));hurt(game.p,dmg,true);}
  return;
 }
 
 let dx=Math.sign(game.p.x-b.x),dy=Math.sign(game.p.y-b.y),nx=b.x+dx,ny=b.y+dy;
 if(isBlocked(nx,ny,b)){if(!isBlocked(b.x+dx,b.y,b)){nx=b.x+dx;ny=b.y;}else if(!isBlocked(b.x,b.y+dy,b)){nx=b.x;ny=b.y+dy;}else return;}
 
 // Arena-Grenzen f√ºr Boss (bleibt innerhalb)
 if(nx<4||nx>GRID-5||ny<4||ny>GRID-5)return;
 
 b.x=nx;b.y=ny;
 // Trail-Mechanik
 if(b.bossType==='TRAIL'&&game.map[oy][ox]!==1&&game.map[oy][ox]!==4){game.map[oy][ox]=4;b.trailTiles.push({x:ox,y:oy,life:bd.trailDuration});}
}
function turnLogic(){
 // Tutorial-Trigger bei Schl√ºssel-Aufheben
 if(!game.p.hasKey&&game.p.x===game.key.x&&game.p.y===game.key.y){
  game.p.hasKey=true;game.key={x:-1,y:-1};sfx('shop');addParticle(game.p.x,game.p.y,"SCHL√úSSEL",C.BITS);
  if(game.level===0)checkTutTriggers();
 }
 if(game.p.hasKey&&game.p.x===game.exit.x&&game.p.y===game.exit.y){
  // Tutorial-Ende
  if(game.level===0){endTutorial();return;}
  // Boss-Level: Exit nur wenn Boss tot
  if(game.isBossLevel&&game.boss){addParticle(game.p.x,game.p.y,"BOSS LEBT NOCH!",'#f00');updateUI();return;}
  if(game.isBossLevel&&!game.boss){addParticle(game.p.x,game.p.y,"WEITER!",'#ffd700');triggerBossVictory();return;}
  startLevel(game.level+1);return;
 }
 // Im Tutorial: Kein Glitch, keine Timer
 if(game.level===0){updateUI();return;}
 if(game.timers.curse>0)game.timers.curse--;
 if(game.timers.burn>0){game.timers.burn--;if(game.timers.burn%2===0){meta.hp-=1;addParticle(game.p.x,game.p.y,"FEUER",'#f40');}}
 if(game.timers.poison>0){game.timers.poison--;if(game.timers.poison%5===0){meta.hp-=1;addParticle(game.p.x,game.p.y,"GIFT",'#0f0');}}
 
 // Kein Nekro-Spawn oder Glitch in Boss-Levels
 if(game.isBossLevel){if(meta.hp<=0)triggerGameOver();updateUI();return;}
 
 // Nekro-Biom: Alle 20 Ticks spawnt ein Skelett
 let B=BIOMES[game.biome];
 if(B.fx==='NEKRO'){
  game.nekroTimer=(game.nekroTimer||0)+1;
  if(game.nekroTimer>=20){
   game.nekroTimer=0;
   let pos,tries=20;do{pos={x:rnd(1,GRID-2),y:rnd(1,GRID-2)};tries--;}while((game.map[pos.y][pos.x]===1||game.enemies.some(e=>e.x===pos.x&&e.y===pos.y)||(pos.x===game.p.x&&pos.y===game.p.y))&&tries>0);
   if(tries>0){
    let t=BESTIARY.SKEL,hp=((t.st[0]*10)+game.level*1.5)|0;
    game.enemies.push({x:pos.x,y:pos.y,hp,max:hp,dmg:(t.st[1]*1.5+game.level*0.3)|0,bits:(5+game.level*3)|0,name:"Erwecktes Skelett",col:'#0f0',hue:120,state:'HUNT',type:'SKEL',speed:8,energy:0,stun:0,fx:'NONE'});
    addParticle(pos.x,pos.y,'ERWACHT!','#0f0');sfx('glitch');
   }
  }
 }
 game.timers.glitch--;
 if(game.timers.glitch<=0){
  game.glitchCount++;game.timers.glitch=15+game.stats.glitchMod;game.timers.shake=5;sfx('glitch');addParticle(game.p.x,game.p.y,`REALIT√ÑTSBRUCH (${game.glitchCount})`,'#f0f');
  if(game.glitchCount>5){sfx('kill');setTimeout(()=>sfx('kill'),150);}
  // Nekro-Glitch: 50% Mana-Drain
  if(B.fx==='NEKRO'&&meta.mana>0){meta.mana=Math.floor(meta.mana*0.5);addParticle(game.p.x,game.p.y,'MANA ENTZOGEN!','#0f0');}
  // Chaos-Glitch: UI durcheinander
  if(B.fx==='CHAOS')shuffleUI();
  for(let i=0;i<5+game.glitchCount*2;i++){let rx=rnd(1,GRID-2),ry=rnd(1,GRID-2);if([game.p,game.key,game.exit].every(e=>e.x!==rx||e.y!==ry)){game.map[ry][rx]=(Math.random()<0.5)?B.f(rx,ry):(game.map[ry][rx]?0:1);if(game.map[ry][rx]===1)game.walls[ry*GRID+rx]=B.hp;}}
  if(game.glitchCount>3){
   let pool=(game.glitchCount>6)?Object.keys(BESTIARY):B.mobs,key=pool[rnd(0,pool.length-1)],t=BESTIARY[key],diff=game.level*((game.glitchCount>6)?(game.glitchCount/2):1);
   let hp=((t.st[0]*15)+diff*2)*(1+game.glitchCount*0.2);
   game.enemies.push({x:rnd(1,GRID-2),y:rnd(1,GRID-2),hp,max:hp,dmg:(t.st[1]*2+diff/2)|0,bits:0,name:"GLITCH "+t.n,col:'#f0f',hue:300,state:'HUNT',type:key,speed:10,energy:50,stun:0,fx:'NONE'});
  }
 }
 if(meta.hp<=0)triggerGameOver();updateUI();
}
function loop(){
 // Hit-FX verarbeiten
 game.hitFX=(game.hitFX||[]).filter(f=>{f.t--;return f.t>0;});
 if(game.timers.shake>0)game.timers.shake--;game.particles.forEach(p=>{p.y-=p.speed;p.life--;});game.particles=game.particles.filter(p=>p.life>0);
 CTX.save();CTX.fillStyle=C.BG;CTX.fillRect(0,0,CVS.width,CVS.height);
 if(game.timers.shake>0)CTX.translate((Math.random()-.5)*10,(Math.random()-.5)*10);
 if(game.mode==='SHOP')drawShop();else drawGame();
 let grd=CTX.createRadialGradient(320,320,200,320,320,450);grd.addColorStop(0,"rgba(0,0,0,0)");grd.addColorStop(1,"rgba(0,0,0,0.6)");CTX.fillStyle=grd;CTX.fillRect(0,0,640,640);
 CTX.restore();requestAnimationFrame(loop);
}
function drawGame(){
 // Kristall-Vision zur√ºcksetzen
 if(game.crystalVision>0)game.crystalVision--;
 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  let px=x*TILE,py=y*TILE,t=game.map[y][x];
  if(t===1)drawSprite(CTX,px,py,x+y*GRID,'WALL',C.WALL);
  else if(t===2){drawSprite(CTX,px,py,x*y+x,'FLOOR','#006');CTX.fillStyle='rgba(150,220,255,0.3)';CTX.fillRect(px,py,TILE,TILE);if(Math.random()<0.02){CTX.fillStyle='#fff';CTX.fillRect(px+rnd(0,28),py+rnd(0,28),2,2);}}
  else if(t===3)drawSprite(CTX,px,py,x*y+x,'FLOOR',C.MUD);
  else if(t===4){drawSprite(CTX,px,py,x*y+x,'FLOOR','#300');CTX.fillStyle=`rgba(255,${100+Math.sin(Date.now()/200+x)*50},0,${0.4+Math.sin(Date.now()/300+y)*0.2})`;CTX.fillRect(px,py,TILE,TILE);}
  else if(t===5){drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);if(Math.random()<0.05){CTX.fillStyle=`hsl(${Date.now()/10%360},100%,50%)`;CTX.fillRect(px+rnd(0,28),py+rnd(0,28),4,4);}}
  else if(t===6){drawSprite(CTX,px,py,x*y+x,'FLOOR','#130');CTX.fillStyle=`rgba(0,${80+Math.sin(Date.now()/400+x)*30},${40+Math.sin(Date.now()/300+y)*20},0.6)`;CTX.beginPath();CTX.arc(px+16,py+16+Math.sin(Date.now()/500+x+y)*2,12,0,Math.PI*2);CTX.fill();if(Math.random()<0.04){CTX.fillStyle='#4f4';CTX.beginPath();CTX.arc(px+rnd(8,24),py+rnd(8,24),rnd(2,4),0,Math.PI*2);CTX.fill();}}
  else if(t===7){drawSprite(CTX,px,py,x*y+x,'FLOOR','#203');CTX.fillStyle=`rgba(200,100,255,${0.2+Math.sin(Date.now()/500+x+y)*0.15})`;CTX.fillRect(px,py,TILE,TILE);CTX.strokeStyle='#e0f';CTX.lineWidth=1;CTX.strokeRect(px+4,py+4,24,24);}
  else if(t===8){CTX.fillStyle='#000';CTX.fillRect(px,py,TILE,TILE);if(Math.random()<0.02){CTX.fillStyle='#333';CTX.fillRect(px+rnd(0,28),py+rnd(0,28),3,3);}}
  else if(t===9){drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);CTX.strokeStyle='#555';CTX.lineWidth=1;CTX.beginPath();CTX.moveTo(px,py);CTX.lineTo(px+TILE,py+TILE);CTX.moveTo(px+TILE,py);CTX.lineTo(px,py+TILE);CTX.stroke();}
  else if(t===10){drawSprite(CTX,px,py,x*y+x,'FLOOR',`hsl(${(Date.now()/20+x*10+y*10)%360},60%,20%)`);if(Math.random()<0.1){CTX.fillStyle=`hsl(${rnd(0,360)},100%,50%)`;CTX.fillRect(px+rnd(0,28),py+rnd(0,28),rnd(2,6),rnd(2,6));}}
  else drawSprite(CTX,px,py,x*y+x,'FLOOR',C.FLOOR);
 }
 drawSprite(CTX,game.key.x*TILE,game.key.y*TILE,999,'KEY','#ffd700');drawSprite(CTX,game.exit.x*TILE,game.exit.y*TILE,888,'GATE',game.p.hasKey?'open':'closed');
 game.items.forEach((i,idx)=>{
  if(i.type==='EQUIP')drawSprite(CTX,i.x*TILE,i.y*TILE,i.val.id*100,i.val.slot,i.val.col);
  else drawSprite(CTX,i.x*TILE,i.y*TILE,i.x*i.y+idx,i.type===3?'RELIC':(i.type<2?'POTION':'CHEST'),['#f00','#00f','#ff0','#f60'][i.type]);
 });
 game.enemies.forEach((e,idx)=>{
  if(e.fx==='BURN'&&Math.random()<0.1)addParticle(e.x,e.y,'~','#f40',0.5);if(e.fx==='POISON'&&Math.random()<0.05)addParticle(e.x,e.y,'o','#0f0',0.3);
  if(e.isBoss){
   // Boss: 3x3 Tiles gro√ü, zentriert auf Position
   let bx=e.x*TILE-TILE,by=e.y*TILE-TILE,bs=TILE*3,col=e.col==='RAINBOW'?`hsl(${Date.now()/10%360},100%,50%)`:e.col;
   CTX.save();CTX.translate(bx+bs/2,by+bs/2);CTX.rotate(Math.sin(Date.now()/500)*0.05);CTX.translate(-bs/2,-bs/2);
   // Schatten/Aura
   CTX.fillStyle=`${col}33`;CTX.beginPath();CTX.arc(bs/2,bs/2,bs/2+8+Math.sin(Date.now()/200)*4,0,Math.PI*2);CTX.fill();
   // K√∂rper
   CTX.fillStyle=col;CTX.fillRect(8,8,bs-16,bs-16);
   // Gesicht/Details basierend auf Boss-Typ
   CTX.fillStyle='#000';
   if(e.bossType==='TITAN'){CTX.fillRect(bs*0.25,bs*0.3,bs*0.15,bs*0.15);CTX.fillRect(bs*0.6,bs*0.3,bs*0.15,bs*0.15);CTX.fillRect(bs*0.3,bs*0.6,bs*0.4,bs*0.1);}
   else if(e.bossType==='VOID'){CTX.beginPath();CTX.arc(bs/2,bs/2,bs*0.25,0,Math.PI*2);CTX.fill();}
   else{CTX.fillRect(bs*0.2,bs*0.35,bs*0.2,bs*0.1);CTX.fillRect(bs*0.6,bs*0.35,bs*0.2,bs*0.1);}
   // Gl√ºheffekt
   if(e.charging){CTX.strokeStyle='#f00';CTX.lineWidth=4;CTX.strokeRect(4,4,bs-8,bs-8);}
   CTX.restore();
  }else{
   drawSprite(CTX,e.x*TILE,e.y*TILE,(e.x+e.y+idx)*10,e.type,e.col||`hsl(${e.hue},60%,50%)`);
  }
  // HP-Balken (f√ºr Boss gr√∂√üer und √ºber dem Sprite)
  if(!e.isBoss){CTX.fillStyle='red';CTX.fillRect(e.x*TILE,e.y*TILE-8,32,2);CTX.fillStyle='#0f0';CTX.fillRect(e.x*TILE,e.y*TILE-8,32*(e.hp/e.max),2);}
  if(e.stun>0){CTX.fillStyle='#fff';CTX.fillText('üí´',e.x*TILE+8,e.y*TILE-10);}
 });
 if(game.p.hidden){CTX.save();CTX.globalAlpha=0.5;}drawSprite(CTX,game.p.x*TILE,game.p.y*TILE,1337,'HERO',C.PL);
 if(game.p.hidden){CTX.restore();if(Math.random()<0.3)addParticle(game.p.x,game.p.y,"...","#888");}
 // Spieler-Statusbalken unter dem Sprite
 let px=game.p.x*TILE,py=game.p.y*TILE+34,bw=30,bh=3;
 CTX.fillStyle='#300';CTX.fillRect(px+1,py,bw,bh);CTX.fillStyle='#f00';CTX.fillRect(px+1,py,bw*(meta.hp/game.stats.maxHp),bh);
 if(game.stats.maxMana>0){CTX.fillStyle='#003';CTX.fillRect(px+1,py+4,bw,bh);CTX.fillStyle='#00f';CTX.fillRect(px+1,py+4,bw*(meta.mana/game.stats.maxMana),bh);}
 CTX.fillStyle='#030';CTX.fillRect(px+1,py+8,bw,bh);CTX.fillStyle='#0f0';CTX.fillRect(px+1,py+8,bw*(meta.stam/game.stats.maxStam),bh);
 if(game.timers.poison>0){CTX.fillStyle='#0f0';CTX.fillText('‚ò†Ô∏è',game.p.x*TILE+20,game.p.y*TILE);}
 if(game.timers.burn>0){CTX.fillStyle='#f60';CTX.fillText('üî•',game.p.x*TILE-5,game.p.y*TILE);}
 if(game.confused>0){CTX.fillStyle='#ff0';CTX.font='12px serif';CTX.fillText('‚ùì',game.p.x*TILE+10,game.p.y*TILE-5);}
 if(game.p.falling){CTX.globalAlpha=0.5;CTX.fillStyle='#fff';CTX.fillText('~',game.p.x*TILE+16,game.p.y*TILE+40);CTX.globalAlpha=1;}
 if(game.aiming&&meta.class==='MAGE'){
  let v=hasLOS(game.p.x,game.p.y,game.mouse.x,game.mouse.y);CTX.strokeStyle=v?'#0f0':'#f00';CTX.lineWidth=2;CTX.strokeRect(game.mouse.x*TILE,game.mouse.y*TILE,TILE,TILE);CTX.beginPath();CTX.moveTo(game.p.x*TILE+16,game.p.y*TILE+16);CTX.lineTo(game.mouse.x*TILE+16,game.mouse.y*TILE+16);CTX.stroke();
 }
 // Boss Aura Preview
 if(game.bossAura){let a=game.bossAura;CTX.strokeStyle=a.warn?'rgba(100,200,255,0.4)':'rgba(100,200,255,0.8)';CTX.lineWidth=a.warn?2:4;CTX.beginPath();CTX.arc(a.x*TILE+16,a.y*TILE+16,a.r*TILE,0,Math.PI*2);CTX.stroke();if(!a.warn){CTX.fillStyle='rgba(100,200,255,0.15)';CTX.fill();}}
 // Charge Preview
 if(game.chargePreview){let c=game.chargePreview;CTX.strokeStyle='rgba(255,50,50,0.6)';CTX.lineWidth=6;CTX.setLineDash([8,8]);CTX.beginPath();CTX.moveTo(c.x*TILE+16,c.y*TILE+16);CTX.lineTo((c.x+c.dx*c.steps)*TILE+16,(c.y+c.dy*c.steps)*TILE+16);CTX.stroke();CTX.setLineDash([]);}
 // Boss HP Bar
 if(game.boss){let b=game.boss;CTX.fillStyle='#111';CTX.fillRect(80,8,480,24);CTX.fillStyle='#400';CTX.fillRect(82,10,476,20);CTX.fillStyle=b.col==='RAINBOW'?`hsl(${Date.now()/10%360},100%,50%)`:'#f00';CTX.fillRect(82,10,476*(b.hp/b.max),20);CTX.fillStyle='#fff';CTX.font='bold 14px serif';CTX.textAlign='center';CTX.fillText(`‚öî ${b.name} - ${b.hp}/${b.max} ‚öî`,320,25);if(b.phase&&b.phase>1){CTX.fillStyle='#f0f';CTX.fillText(`PHASE ${b.phase}`,560,25);}CTX.textAlign='left';}
 // Hit-FX zeichnen
 (game.hitFX||[]).forEach(f=>{let cx=f.x*TILE+16,cy=f.y*TILE+16,a=f.t/8;CTX.globalAlpha=a;CTX.strokeStyle=f.col;CTX.lineWidth=3;if(f.type==='slash'){let ang=(8-f.t)*0.4;CTX.beginPath();CTX.moveTo(cx-12,cy-12+ang*8);CTX.lineTo(cx+12,cy+12-ang*8);CTX.stroke();CTX.beginPath();CTX.moveTo(cx+12,cy-12+ang*8);CTX.lineTo(cx-12,cy+12-ang*8);CTX.stroke();}else{for(let i=0;i<6;i++){let r=(8-f.t)*4+i*3,ang=i*Math.PI/3;CTX.beginPath();CTX.arc(cx+Math.cos(ang)*r*0.5,cy+Math.sin(ang)*r*0.5,4-f.t/2,0,Math.PI*2);CTX.stroke();}}});CTX.globalAlpha=1;
 game.particles.forEach(p=>{CTX.globalAlpha=p.life/40;CTX.fillStyle=p.col;CTX.font="bold 12px serif";CTX.fillText(p.txt,p.x,p.y);});CTX.globalAlpha=1;
 L_CTX.globalCompositeOperation='source-over';L_CTX.fillStyle='rgba(0,0,0,0.95)';L_CTX.fillRect(0,0,640,640);L_CTX.globalCompositeOperation='destination-out';
 const drawLight=(x,y,r)=>{let g=L_CTX.createRadialGradient(x,y,r*0.2,x,y,r);g.addColorStop(0,'rgba(0,0,0,1)');g.addColorStop(1,'rgba(0,0,0,0)');L_CTX.fillStyle=g;L_CTX.beginPath();L_CTX.arc(x,y,r,0,Math.PI*2);L_CTX.fill();};
 drawLight(game.p.x*TILE+16,game.p.y*TILE+16,250);game.torches.forEach(t=>drawLight(t.x*TILE+16,t.y*TILE+16,(game.stats.torchRadius||150)+Math.random()*10-5));CTX.drawImage(L_CVS,0,0);
 // Tutorial-Nachricht anzeigen mit Textumbruch
 if(tutMsgTimer>0&&tutMsg){
  let boxW=520,boxH=220,boxX=60,boxY=380,pad=20,lineH=18,maxChars=48;
  CTX.fillStyle='rgba(0,0,0,0.92)';CTX.fillRect(boxX,boxY,boxW,boxH);
  CTX.strokeStyle='#c5a059';CTX.lineWidth=3;CTX.strokeRect(boxX,boxY,boxW,boxH);
  CTX.strokeStyle='#8a0b0b';CTX.lineWidth=1;CTX.strokeRect(boxX+4,boxY+4,boxW-8,boxH-8);
  CTX.fillStyle='#e8d4a8';CTX.font='bold 13px serif';CTX.textAlign='left';
  // Textumbruch-Funktion
  let y=boxY+pad+12,lines=tutMsg.split('\n');
  lines.forEach(line=>{
   if(line.length<=maxChars){CTX.fillText(line,boxX+pad,y);y+=lineH;}
   else{
    let words=line.split(' '),cur='';
    words.forEach(w=>{
     if((cur+' '+w).length>maxChars){CTX.fillText(cur,boxX+pad,y);y+=lineH;cur=w;}
     else cur=cur?cur+' '+w:w;
    });
    if(cur){CTX.fillText(cur,boxX+pad,y);y+=lineH;}
   }
  });
  CTX.textAlign='left';
 }
}
function drawSprite(ctx,x,y,seed,type,col){
 ctx.save();ctx.translate(x,y);let px=4,t=Date.now()/200;
 if(type==='HERO'){
  ctx.fillStyle='#dcb';ctx.fillRect(12,4,8,8);ctx.fillRect(8,12,16,12);ctx.fillRect(8,24,4,8);ctx.fillRect(20,24,4,8);
  if(game.equipment.ARMOR){ctx.fillStyle=game.equipment.ARMOR.col;ctx.fillRect(8,12,16,8);ctx.fillRect(4,12,4,4);ctx.fillRect(24,12,4,4);}
  if(game.equipment.WEAPON){ctx.fillStyle=game.equipment.WEAPON.col;ctx.fillRect(28,12,4,16);ctx.fillStyle='#543';ctx.fillRect(28,28,4,4);}
 }else{
  ctx.fillStyle=col;
  if(type==='SKEL'){ctx.fillStyle='#eee';ctx.fillRect(12,4,8,8);ctx.fillRect(12,16,8,4);ctx.fillRect(12,24,8,4);ctx.fillRect(4,12,4,16);ctx.fillRect(24,12,4,16);}
  else if(type==='SLIME'){let s=1+Math.sin(t*2)*0.1;ctx.globalAlpha=0.8;ctx.beginPath();ctx.arc(16,16+Math.sin(t)*2,10*s,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.fillRect(12,14,2,2);ctx.fillRect(18,14,2,2);}
  else if(type==='BAT'){let w=Math.abs(Math.sin(t*10))*8;ctx.fillRect(14,14,4,4);ctx.beginPath();ctx.moveTo(14,16);ctx.lineTo(14-w,10);ctx.lineTo(14-w,20);ctx.fill();ctx.beginPath();ctx.moveTo(18,16);ctx.lineTo(18+w,10);ctx.lineTo(18+w,20);ctx.fill();}
  else if(type==='GOLEM'){ctx.fillRect(8,8+Math.sin(t)*2,16,16);ctx.fillStyle='#000';ctx.fillRect(12,12,2,2);ctx.fillRect(18,12,2,2);}
  else if(type==='GHOST'){ctx.globalAlpha=0.6;ctx.beginPath();ctx.arc(16,12+Math.sin(t)*3,8,Math.PI,0);ctx.lineTo(24,28);ctx.lineTo(16,24);ctx.lineTo(8,28);ctx.fill();ctx.fillStyle='#fff';ctx.fillRect(12,12,2,2);ctx.fillRect(18,12,2,2);}
  else if(type==='SPIDER'){ctx.fillRect(12,12,8,8);let l=Math.sin(t*5)*3;for(let i=0;i<4;i++){ctx.fillRect(8-Math.abs(l),10+i*3,4,1);ctx.fillRect(20+Math.abs(l),10+i*3,4,1);}}
  else if(type==='RAT'){ctx.fillRect(8+Math.sin(t*8)*2,20,16,6);ctx.fillStyle='#pink';ctx.fillRect(24,22,6,2);}
  else if(type==='SNAKE'){for(let i=0;i<6;i++)ctx.fillRect(16+Math.sin(t*4+i)*6,8+i*4,6,4);}
  else if(type==='EYE'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,16+Math.sin(t)*2,10,0,Math.PI*2);ctx.fill();ctx.fillStyle=col;ctx.beginPath();ctx.arc(16+Math.sin(t*0.5)*4,16+Math.cos(t*0.5)*4,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(16+Math.sin(t*0.5)*4,16+Math.cos(t*0.5)*4,2,0,Math.PI*2);ctx.fill();}
  else if(type==='MIMIC'){ctx.fillStyle='#853';ctx.fillRect(8,12,16,12);ctx.fillStyle='#ffd700';ctx.fillRect(14,12,4,4);if(Math.sin(t*2)>0){ctx.fillStyle='#000';ctx.fillRect(8,16,16,4);ctx.fillStyle='#fff';ctx.fillRect(10,16,2,2);ctx.fillRect(14,16,2,2);ctx.fillRect(18,16,2,2);}}
  else if(type==='WRAITH'){ctx.beginPath();ctx.moveTo(16,4);ctx.lineTo(8,28);ctx.lineTo(24,28);ctx.fill();ctx.strokeStyle='#aaa';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(20,16);ctx.lineTo(28,6);ctx.arc(24,10,6,0,Math.PI);ctx.stroke();}
  else if(type==='ELEMENTAL'){for(let i=0;i<8;i++){let ang=t*2+i*(Math.PI/4),r=8+Math.sin(t*3)*4;ctx.fillRect(16+Math.cos(ang)*r,16+Math.sin(ang)*r,4,4);}ctx.fillRect(14,14,4,4);}
  else if(type==='OOZE'){let s=1+Math.sin(t*1.5)*0.15;ctx.globalAlpha=0.7;ctx.beginPath();ctx.arc(16,18+Math.sin(t)*2,12*s,0,Math.PI*2);ctx.fill();ctx.fillStyle='#0f0';ctx.globalAlpha=0.5;ctx.beginPath();ctx.arc(16,18,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.globalAlpha=1;ctx.fillRect(11,14,3,3);ctx.fillRect(18,14,3,3);}
  else if(type==='BASILISK'){ctx.fillRect(8+Math.sin(t*3)*2,20,6,4);for(let i=0;i<5;i++)ctx.fillRect(12+i*2+Math.sin(t*2+i)*2,18-i%2,4,4);ctx.fillStyle='#f00';ctx.fillRect(10,18,2,2);ctx.fillRect(16,18,2,2);ctx.fillStyle='#0f0';for(let i=0;i<3;i++)ctx.fillRect(6+i*2,24+Math.sin(t*4+i)*1,2,2);}
  else if(type==='GAZER'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,16,12,0,Math.PI*2);ctx.fill();ctx.fillStyle=col;ctx.beginPath();ctx.arc(16+Math.sin(t*0.8)*3,16+Math.cos(t*0.8)*3,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#000';ctx.beginPath();ctx.arc(16+Math.sin(t*0.8)*3,16+Math.cos(t*0.8)*3,3,0,Math.PI*2);ctx.fill();ctx.strokeStyle=col;ctx.lineWidth=2;for(let i=0;i<6;i++){let a=i*Math.PI/3+t*0.5;ctx.beginPath();ctx.moveTo(16+Math.cos(a)*12,16+Math.sin(a)*12);ctx.lineTo(16+Math.cos(a)*16,16+Math.sin(a)*16);ctx.stroke();}}
  else if(type==='GARGOYLE'){ctx.fillStyle='#555';ctx.fillRect(10,8,12,14);ctx.fillRect(6,10,4,8);ctx.fillRect(22,10,4,8);ctx.fillStyle=col;ctx.fillRect(8,4,6,6);ctx.fillRect(18,4,6,6);ctx.fillStyle='#f00';ctx.fillRect(13,12+Math.sin(t*3),2,2);ctx.fillRect(17,12+Math.sin(t*3),2,2);ctx.fillStyle='#444';ctx.fillRect(10,22,4,6);ctx.fillRect(18,22,4,6);}
  else if(type==='BOSS'){
   // Gr√∂√üerer Boss-Sprite (1.8x)
   ctx.save();ctx.scale(1.8,1.8);ctx.translate(-7,-7);
   let c=col==='RAINBOW'?`hsl(${Date.now()/10%360},100%,50%)`:col;ctx.fillStyle=c;
   // Krone/Kopf
   ctx.fillRect(10,2,12,12);ctx.fillStyle='#ffd700';ctx.fillRect(12,0,2,4);ctx.fillRect(16,0,2,4);ctx.fillRect(20,0,2,4);
   // K√∂rper
   ctx.fillStyle=c;ctx.fillRect(8,14,16,12);
   // Augen (gl√ºhend)
   ctx.fillStyle=col==='RAINBOW'?'#fff':(col==='#fff'?'#f0f':'#f00');ctx.fillRect(12,6,3,3);ctx.fillRect(17,6,3,3);
   // Arme
   ctx.fillRect(4,14+Math.sin(t*2)*2,4,8);ctx.fillRect(24,14+Math.cos(t*2)*2,4,8);
   ctx.restore();
  }
  else if(type==='CHEST'){ctx.fillStyle='#853';ctx.fillRect(8,12,16,12);ctx.fillStyle='#ffd700';ctx.fillRect(14,12,4,4);ctx.fillStyle='#543';ctx.fillRect(8,24,16,2);}
  else if(type==='GATE'){
   // Torrahmen
   ctx.fillStyle='#444';ctx.fillRect(4,4,4,24);ctx.fillRect(24,4,4,24);ctx.fillRect(4,4,24,4);
   // Tor-Inneres
   if(col==='open'){ctx.fillStyle='#000';ctx.fillRect(8,8,16,20);ctx.fillStyle='#111';ctx.fillRect(10,10,12,16);ctx.fillStyle='#0a0';ctx.fillRect(14,20,4,6);}
   else{ctx.fillStyle='#532';ctx.fillRect(8,8,16,20);ctx.fillStyle='#421';ctx.fillRect(8,8,8,20);ctx.fillStyle='#ffd700';ctx.fillRect(20,16,3,3);ctx.fillStyle='#333';for(let i=0;i<3;i++){ctx.fillRect(10,10+i*6,12,2);}}
  }
  else{
   let r=(n)=>Math.sin(seed*12.9898+n*78.233)*43758.5453;
   for(let j=0;j<8;j++)for(let i=0;i<8;i++){
    let n=Math.abs(r(i+j*8+seed)),c=col,d=false;
    if(type==='WALL'||type==='FLOOR'){
     ctx.fillStyle=col;ctx.fillRect(i*px,j*px,px,px);
     if(n>0.5){ctx.fillStyle=(n>0.75)?'#fff':'#000';ctx.globalAlpha=0.1;ctx.fillRect(i*px,j*px,px,px);ctx.globalAlpha=1.0;}
     if(type==='WALL'){
      if(game.walls[seed]<10){
        ctx.strokeStyle='#000';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(i*px,j*px);ctx.lineTo((i+1)*px,(j+1)*px);ctx.stroke();
      }
      if(n>0.8){ctx.fillStyle='#000';ctx.globalAlpha=0.2;ctx.fillRect(i*px,j*px,px,px);ctx.globalAlpha=1.0;}
     }
    }else{
     if(type==='WEAPON'){if(i===3&&j<7){d=true;c='#ddd';}if(j===5&&i>1)d=true;if(j===6&&i===3){d=true;c='#853';}if(j<5&&i===2&&n>0.4){d=true;c='#ddd';}}
     else if(type==='ARMOR'){if(j>1&&j<7&&i<4)d=true;if(j===2&&i===2)d=false;if(j>3&&i===3)c='#888';}
     else if(type==='RELIC'){let dist=Math.sqrt((i-3.5)**2+(j-3.5)**2);if(dist<3.5&&dist>1.5)d=true;if(j===1&&i===3){d=true;c='#fff';}}
     else if(type==='POTION'){if(i<3&&j>2&&j<7)d=true;if(i===1&&j<3){d=true;c='#eee';}if(j===3)c='#eee';}
     else if(type==='KEY'){if(i===3&&j>1)d=true;if(j===1&&i>1)d=true;if(j===6&&i>1)d=true;}
     if(d){ctx.fillStyle=c;ctx.fillRect(i*px,j*px,px,px);ctx.fillRect((7-i)*px,j*px,px,px);}
    }
   }
  }
 }
 ctx.restore();
}
function drawShop(){
 CTX.fillStyle='#050505';CTX.fillRect(0,0,640,640);CTX.textAlign="center";CTX.fillStyle='#8a0b0b';CTX.font="bold 30px serif";CTX.fillText("/// SCHATTENH√ÑNDLER ///",320,50);CTX.fillStyle='#c5a059';CTX.font="18px serif";CTX.fillText(`GOLD: ${meta.bits} | TIEFE: ${meta.maxLvl}`,320,80);CTX.fillStyle='#888';CTX.font="14px serif";CTX.fillText(`HP:${meta.hp}/${meta.maxHp} DMG:${meta.dmg} KRIT:${Math.round(meta.critChance*100)}% SLOTS:${meta.shopSlots}/6 RUCK:${meta.invSlots}/10 FACK:${meta.torchCount}/3`,320,100);CTX.textAlign="left";let y=130;
 game.shopItems.forEach((o,idx)=>{
  if(y>420)return;
  let col=o.tier.col==='RAINBOW'?`hsl(${Date.now()/5%360},100%,50%)`:o.tier.col;
  if(o.purchased){CTX.fillStyle='#333';CTX.fillText(`[${o.idx}] -- VERKAUFT --`,80,y);}else{
   // Locked-Items: Deutlicher Rahmen
   if(o.locked){CTX.strokeStyle='#0ff';CTX.lineWidth=2;CTX.strokeRect(25,y-28,560,38);CTX.fillStyle='rgba(0,255,255,0.1)';CTX.fillRect(25,y-28,560,38);}
   drawSprite(CTX,30,y-25,o.idx*123,o.item.vis||'POTION',col);CTX.fillStyle=col;
   let pre=o.locked?'[‚è∏]':(meta.bits>=o.cost?`[${o.idx}]`:` X `),v=o.item.calc(o.tier),vTxt=o.item.unit==='%'?`+${Math.round(v*100)}%`:`+${v} ${o.item.unit}`;
   CTX.font="bold 18px serif";CTX.fillText(`${pre} ${o.item.name} [${vTxt}]`,80,y);CTX.font="italic 14px serif";CTX.fillText(o.tier.name,440,y);
   CTX.fillStyle=(meta.bits>=o.cost)?'#ffd700':'#555';CTX.textAlign="right";CTX.fillText(`${o.cost}`,580,y);CTX.textAlign="left";
  }y+=42;
 });
 // Buttons unterhalb der Items
 let btnY=440,btnW=260,btnH=36;
 // TAUSCHEN Button
 CTX.fillStyle=(meta.bits>=game.rerollCost)?'#1a1a0a':'#0a0a0a';CTX.fillRect(60,btnY,btnW,btnH);CTX.strokeStyle=(meta.bits>=game.rerollCost)?'#c5a059':'#333';CTX.lineWidth=2;CTX.strokeRect(60,btnY,btnW,btnH);CTX.fillStyle=(meta.bits>=game.rerollCost)?'#c5a059':'#555';CTX.font="bold 16px serif";CTX.textAlign="center";CTX.fillText(`üîÑ TAUSCHEN (${game.rerollCost})`,60+btnW/2,btnY+24);
 // MERKEN/KAUFEN Toggle
 let lockCol=game.lockMode?'#0ff':'#888';CTX.fillStyle=game.lockMode?'#0a1a1a':'#0a0a0a';CTX.fillRect(340,btnY,btnW,btnH);CTX.strokeStyle=lockCol;CTX.strokeRect(340,btnY,btnW,btnH);CTX.fillStyle=lockCol;CTX.fillText(game.lockMode?'‚è∏ MERKMODUS AKTIV':'üí∞ KAUFMODUS',340+btnW/2,btnY+24);
 CTX.textAlign="left";CTX.fillStyle='#666';CTX.font="12px serif";CTX.fillText('[SPACE]',60,btnY+btnH+14);CTX.fillText('[L]',340,btnY+btnH+14);
}
function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function addParticle(x,y,txt,col,spd=1){game.particles.push({x:x*TILE+16,y:y*TILE,txt,col,life:60,speed:0.5*spd});}
function genItem(lvl){
 let mat=I_MATS[Math.min(I_MATS.length-1,Math.floor(Math.random()*(lvl/2+1)))],rMax=2+lvl*0.7+(meta.maxLvl*0.2),rIdx=Math.min(RARITIES.length-1,Math.max(0,Math.floor(Math.random()*rMax+(game.stats.shopLuck||0)/20))),rar=RARITIES[rIdx],type=I_TYPES[rnd(0,I_TYPES.length-1)];
 let item={id:Math.random(),name:rar.name+" "+type.n[rnd(0,type.n.length-1)],target:type.target,slot:type.s,col:mat.c,rarityCol:rar.col,mods:{},val:(type.baseCost*mat.m*rar.mul*0.5)|0};
 Object.keys(type.mods).forEach(k=>{let v=type.mods[k]*mat.m*rar.mul;item.mods[k]=['critChance','dodgeChance','lootMul','manaRegen'].includes(k)?parseFloat(v.toFixed(2)):Math.round(v);});
 if(mat.b)Object.assign(item.mods,mat.b);
 if(Math.random()<0.3+(lvl*0.05)){let s=I_SUFFIX[rnd(0,I_SUFFIX.length-1)];item.name+=" "+s.n;item.mods[s.stat]=(item.mods[s.stat]||0)+s.v;if(s.stat.includes('Chance')||s.stat==='lootMul')item.mods[s.stat]=parseFloat(item.mods[s.stat].toFixed(2));}
 return item;
}
function calcStats(){
 // 1. Basis-Stats aus Klasse
 let C=CLASSES[meta.class];
 game.stats={
  maxHp:C.hp,maxMana:C.mana,maxStam:C.stam,
  dmg:meta.dmg||1,mine:C.mine,noise:C.noise,speed:C.spd,
  def:0,manaRegen:0,stamRegen:1,
  critChance:0.05,dodgeChance:0.05,lootMul:1.0,
  glitchMod:0,spellDmg:0,stealthDrain:3,stealthCost:5,
  shopLuck:meta.shopLuck||0,torchCount:meta.torchCount||0,torchRadius:meta.torchRadius||150
 };
 
 // 2. Level-Bonus
 game.stats.maxStam+=(meta.maxLvl-1);
 
 // 3. Equipment-Boni
 Object.values(game.equipment).forEach(it=>{
  if(it)Object.keys(it.mods).forEach(k=>game.stats[k]=(game.stats[k]||0)+it.mods[k]);
 });
 
 // 4. PASSIV-SLOTS: Iteriere √ºber ausger√ºstete Passives
 (meta.equippedPassives||[]).forEach(p=>{
  if(!p)return;
  let item=ITEM_POOL.find(i=>i.name===p.name);
  if(item&&item.eff){
   let tier=R_MAP[p.tierName]||{id:0,mul:1};
   tier.id=RARITIES.findIndex(r=>r.name===p.tierName);
   let val=item.calc(tier);
   item.eff(game.stats,val);
  }
 });
 
 // 5. Klassen-Boni f√ºr Waffe
 let w=game.equipment.WEAPON;
 game.stats.spellDmg=(game.stats.spellDmg||0)+(w&&meta.class===w.target?2:0);
 if(w&&meta.class===w.target){
  if(meta.class==='WARRIOR'){game.stats.def+=1;game.stats.dmg+=1;}
  else if(meta.class==='ROGUE'){game.stats.critChance+=0.05;game.stats.speed+=2;}
  else if(meta.class==='MAGE')game.stats.manaRegen+=0.5;
 }
 
 // 6. Caps & Floors
 game.stats.critChance=Math.min(1.0,game.stats.critChance);
 game.stats.dodgeChance=Math.min(0.75,game.stats.dodgeChance);
 game.stats.speed=Math.max(2,game.stats.speed);
 game.stats.noise=Math.max(0.5,game.stats.noise);
 game.stats.maxHp=Math.max(1,game.stats.maxHp);
 game.stats.maxMana=Math.max(0,game.stats.maxMana);
 game.stats.maxStam=Math.max(1,game.stats.maxStam);
}

function save(){localStorage.setItem('GD4_Dark_Save',JSON.stringify({uid:meta.uid,bits:meta.bits,maxLvl:meta.maxLvl,shopSlots:meta.shopSlots,shopLuck:meta.shopLuck,invSlots:meta.invSlots,torchCount:meta.torchCount,lockedItems:meta.lockedItems||[],passiveSlots:meta.passiveSlots||3,upgradePool:meta.upgradePool||[],equippedPassives:meta.equippedPassives||[]}));}
function showHelp(){let c=meta.class,skill=c==='WARRIOR'?'Wirbelwind (Rundumschaden)':c==='ROGUE'?'Unsichtbarkeit (Tarnung)':'Feuerball (Fernkampf)';alert(`STEUERUNG:\nWASD/Pfeile: Bewegen\nLeertaste: Warten\nB: ${skill}\nF: Bannkreis benutzen\nI: Inventar\n\nKLASSE: ${CLASSES[c].n}\n${c==='WARRIOR'?'Stark im Nahkampf, kann W√§nde schnell zerst√∂ren.':c==='ROGUE'?'Schnell und leise, kann sich verstecken.':'M√§chtige Zauber, aber wenig Lebensenergie.'}\n\nTIPPS:\n- Sammle den Schl√ºssel, dann zum Ausgang\n- Vermeide den Realit√§tsbruch (Glitch)\n- Im Shop: L = Sperren, Leertaste = Neues Angebot`);}
function delSave(){if(confirm('Alles l√∂schen (inkl. Grimoire, Erfolge & Tutorial)?')){localStorage.removeItem('GD4_Dark_Save');localStorage.removeItem('GD4_Stats');localStorage.removeItem('GD4_Tut');location.reload();}}
// Leaderboard-Funktionen
function packGear(){return Object.values(game.equipment).map(e=>e?RARITIES.findIndex(r=>r.col===e.col):0);}
async function submitScore(){
 if(!meta.name)return;
 let payload=[meta.name,['WARRIOR','ROGUE','MAGE'].indexOf(meta.class),meta.maxLvl,Math.round((game.turnCount/game.level)*10)/10||0,stats.kills,stats.deaths,packGear(),Date.now(),meta.uid];
 try{await fetch('/.netlify/functions/leaderboard',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'submit',data:payload})});}catch(e){console.log('Leaderboard offline');}
}
async function fetchLeaderboard(){
 try{let r=await fetch('/.netlify/functions/leaderboard?class='+['WARRIOR','ROGUE','MAGE'].indexOf(meta.class));let d=await r.json();renderLeaderboard(d.top||[]);}catch(e){let c3=$('inv-content-3');if(c3)c3.innerHTML='<div style="padding:20px;text-align:center">Offline</div>';}
}
function renderLeaderboard(data){
 let h='<style>.lb-t{width:100%;border-collapse:collapse;font-size:14px}.lb-t th{padding:8px 4px;border-bottom:2px solid #555;text-align:left;font-family:var(--font-display);color:var(--accent-color);white-space:nowrap}.lb-t td{padding:6px 4px;border-bottom:1px solid #222}.lb-g{display:inline-block;width:10px;height:10px;margin:0 2px;border:1px solid #000;box-shadow:0 0 3px rgba(0,0,0,0.5)}@media(max-width:480px){.lb-t{font-size:11px}.lb-t th,.lb-t td{padding:4px 2px}.lb-g{width:8px;height:8px}}</style><table class="lb-t"><tr><th title="Platzierung">Rang<th title="Name des Helden">Name<th title="Maximal erreichte Tiefe">Tiefe<th title="Durchschnittliche Z√ºge pro Ebene">Z√ºge/Lvl<th title="Durchschnittlich get√∂tete Gegner bis zum Tod">K/D<th title="Ausr√ºstung (Waffe/R√ºstung/Relikt)">Gear</tr>';
 data.forEach((e,i)=>{let g=e[6],gear=['Waffe','R√ºstung','Relikt'].map((n,j)=>{let r=RARITIES[g[j]]||{col:'#333',name:'Keine'};return`<span class="lb-g" style="background:${r.col}" title="${r.name} ${n}"></span>`}).join('');h+=`<tr><td>${i+1}<td title="${esc(e[0])}">${esc(e[0].length>12?e[0].slice(0,11)+'‚Ä¶':e[0])}<td>${e[2]}<td>${e[3]}<td>${e[4]}/${e[5]}<td>${gear}</tr>`;});
 $('inv-content-3').innerHTML=h+'</table>';
}
function triggerBossVictory(){game.mode='SHOP';game.rerollCost=10;generateShop();$('shop-ui').style.display='flex';$('lvl-select').style.display='block';if(game.level+1>meta.maxLvl){meta.maxLvl=game.level+1;checkAch();} $('lvl-slider').max=meta.maxLvl;$('lvl-slider').value=game.level+1;$('lvl-val').innerText=game.level+1;$('btn-reincarnate').innerText="Weiterreise";save();}
function triggerGameOver(){$('btn-reincarnate').innerText="Reinkarnation";stats.deaths++;saveStats();submitScore();game.mode='SHOP';game.rerollCost=10;generateShop();$('shop-ui').style.display='flex';
 // Tutorial abgeschlossen? Dann Level 0 verf√ºgbar aber Level 1 vorausgew√§hlt
 let tutDone=localStorage.getItem('GD4_Tut')==='1';
 if(meta.maxLvl>1||tutDone){
  $('lvl-select').style.display='block';
  $('lvl-slider').min=tutDone?0:1;
  $('lvl-slider').max=meta.maxLvl;
  let biomeStart=Math.min(meta.maxLvl,Math.max(1,Math.floor((game.level-1)/5)*5+1));
  $('lvl-slider').value=biomeStart;$('lvl-val').innerText=biomeStart;
 }save();}
function generateShop(){
 game.shopItems=[];
 let slots=meta.shopSlots||2;
 
 // Gemerkte Items wiederherstellen
 let restoredLocks=[];
 if(meta.lockedItems&&meta.lockedItems.length>0){
  meta.lockedItems.forEach(li=>{
   if(game.shopItems.length<slots){
    let base=ITEM_POOL.find(i=>i.name===li.itemName),tier=R_MAP[li.tierName];
    if(base&&tier&&(!base.max||base.max())){
     game.shopItems.push({idx:game.shopItems.length+1,item:base,tier,cost:li.cost,purchased:false,locked:true});
     restoredLocks.push(li);
    }
   }
  });
  meta.lockedItems=meta.lockedItems.filter(li=>!restoredLocks.includes(li));
 }
 
 // Tier-Auswahl mit Gau√ü-Verteilung + shopLuck
 function pickTier(){
  let targetTier=Math.min(10,Math.max(0,Math.floor(game.level/5)));
  
  // 3% Chaos: komplett zuf√§llig
  if(Math.random()<0.03)return RARITIES[rnd(0,Math.min(10,RARITIES.length-1))];
  
  // 97% Normal: Gau√ü-Verteilung um targetTier
  let dist=[
   {offset:-2,pct:15},{offset:-1,pct:25},{offset:0,pct:45},
   {offset:1,pct:10},{offset:2,pct:4},{offset:3,pct:1}
  ];
  
  // shopLuck: Verschiebt X% jeder Kategorie um +1 Seltenheit
  let luck=Math.min(90,Math.max(0,game.stats.shopLuck||0))/100;
  if(luck>0){
   let shifted=[];
   dist.forEach(d=>{
    let keep=d.pct*(1-luck);
    let up=d.pct*luck;
    shifted.push({offset:d.offset,pct:keep});
    shifted.push({offset:d.offset+1,pct:up});
   });
   // Zusammenfassen gleicher Offsets
   let merged={};
   shifted.forEach(s=>{merged[s.offset]=(merged[s.offset]||0)+s.pct;});
   dist=Object.keys(merged).map(o=>({offset:parseInt(o),pct:merged[o]})).filter(d=>d.pct>0.01);
  }
  
  // Auf konkrete Tiers mappen (mit Clamping)
  let adjusted=dist.map(d=>{
   let t=targetTier+d.offset;
   return {tier:Math.max(0,Math.min(RARITIES.length-1,t)),pct:d.pct};
  });
  
  // Zusammenfassen gleicher Tiers
  let merged={};
  adjusted.forEach(a=>{merged[a.tier]=(merged[a.tier]||0)+a.pct;});
  
  let roll=Math.random()*100,cumulative=0;
  for(let tier in merged){
   cumulative+=merged[tier];
   if(roll<cumulative)return RARITIES[parseInt(tier)];
  }
  return RARITIES[targetTier];
 }
 
 // Slots f√ºllen
 while(game.shopItems.length<slots){
  let pool=ITEM_POOL.filter(i=>!i.max||i.max());
  let base=pool[rnd(0,pool.length-1)];
  if(!base)base=ITEM_POOL[0];
  
  let tier=pickTier();
  tier.id=RARITIES.indexOf(tier); // ID f√ºr Preisberechnung
  
  let cost=getItemPrice(base,tier);
  
  game.shopItems.push({
   idx:game.shopItems.length+1,
   item:base,
   tier:tier,
   cost:cost,
   purchased:false,
   locked:false
  });
 }
}

function respawn(){
 meta.hp=meta.maxHp;meta.stam=meta.maxStam;meta.mana=meta.maxMana;
 meta.lockedItems=game.shopItems.filter(i=>i.locked&&!i.purchased).map(i=>({itemName:i.item.name,tierName:i.tier.name,cost:i.cost}));
 game.mode='GAME';
 let sl=parseInt($('lvl-slider').value)||1;
 // Bei Tutorial (Level 0): Reset auf Alte Gabel
 if(sl===0){
  let c=CLASSES[meta.class];
  tutStartItem={id:Math.random(),name:'Start '+c.item,target:meta.class,slot:'WEAPON',col:'#aaa',mods:{dmg:2}};
  if(meta.class==='MAGE')tutStartItem.mods={dmg:1,maxMana:5};if(meta.class==='ROGUE')tutStartItem.mods={dmg:2,speed:2};
  let fork={id:0.999,name:'Alte Gabel',target:'NONE',slot:'WEAPON',col:'#654',mods:{dmg:0.5}};
  game.equipment.WEAPON=fork;calcStats();
 }
 $('lvl-select').style.display='none';startLevel(sl);
}
function isBlocked(x,y,self){if(game.map[y][x]===1)return true;return game.enemies.some(e=>e!==self&&(e.x===x&&e.y===y||(e.isBoss&&Math.abs(e.x-x)<=1&&Math.abs(e.y-y)<=1)));}
function checkPickups(){let idx=game.items.findIndex(i=>i.x===game.p.x&&i.y===game.p.y);if(idx>=0){let item=game.items[idx];if(item.mimic){game.items.splice(idx,1);let t=BESTIARY.MIMIC,hp=((t.st[0]*10)+game.level*1.5)|0,dmg=((t.st[1]*3)+game.level*0.5)|0;let e={x:item.x,y:item.y,hp,max:hp,dmg,bits:15+game.level*3,name:"Hungriger Mimic",col:'#853',hue:30,state:'HUNT',type:'MIMIC',speed:8+Math.min(game.level,10),energy:50,sight:6,stun:0,fx:'NONE'};game.enemies.push(e);discoverMon('MIMIC','Hungrig');sfx('glitch');addParticle(item.x,item.y,"MIMIC!",'#f00');addHitFX(item.x,item.y,'slash','#f00');game.timers.shake=5;return;}sfx('shop');game.items.splice(idx,1);if(item.type==='EQUIP'){if(game.inventory.length<(meta.invSlots||10)){game.inventory.push(item.val);addParticle(game.p.x,game.p.y,item.val.name,item.val.rarityCol||item.val.col);}else{addParticle(game.p.x,game.p.y,"VOLL!",'#f00');game.items.push(item);return;}}else{if(item.type===0){if(game.timers.poison>0)addParticle(game.p.x,game.p.y,"GIFT BLOCKT!",'#0f0');else{meta.hp=Math.min(meta.hp+5,game.stats.maxHp);addParticle(game.p.x,game.p.y,"HEILUNG",'#0f0');}}if(item.type===1){meta.mana=Math.min(meta.mana+10,game.stats.maxMana);addParticle(game.p.x,game.p.y,"MANA",'#0af');}if(item.type===2){let b=Math.floor((10+game.level*8+Math.pow(game.level,2)*0.5)*game.stats.lootMul);meta.bits+=b;addParticle(game.p.x,game.p.y,`+${b}`,C.BITS);}if(item.type===3&&meta.scrolls<5){meta.scrolls++;addParticle(game.p.x,game.p.y,"RITUAL",'#f60');}}}}
// Chaos-Biom: UI-Elemente durcheinander w√ºrfeln
function shuffleUI(){
 let bar=$('ui-bar'),hud=$('hud'),actions=$('actions');
 // Stat-Reihenfolge mischen
 let stats=bar.querySelectorAll('div > div');
 stats.forEach(s=>{s.style.order=rnd(0,10);s.style.transform=`rotate(${rnd(-5,5)}deg)`;});
 // Button-Reihenfolge mischen
 let btns=actions.querySelectorAll('button');
 btns.forEach(b=>{b.style.order=rnd(0,10);});
 // D-Pad drehen
 let dpad=$('dpad');
 dpad.style.transform=`rotate(${[0,90,180,270][rnd(0,3)]}deg)`;
 // Farben chaotisch
 document.documentElement.style.setProperty('--accent-color',`hsl(${rnd(0,360)},100%,50%)`);
 document.documentElement.style.setProperty('--text-color',`hsl(${rnd(30,60)},${rnd(50,100)}%,${rnd(40,70)}%)`);
 // Nach kurzer Zeit zur√ºcksetzen
 setTimeout(()=>{
  stats.forEach(s=>{s.style.order='';s.style.transform='';});
  btns.forEach(b=>{b.style.order='';});
  dpad.style.transform='';
  let B=BIOMES[game.biome];
  document.documentElement.style.setProperty('--accent-color',B.c[3]);
  document.documentElement.style.setProperty('--text-color','#c5a059');
 },3000);
 addParticle(game.p.x,game.p.y,'UI CHAOS!','#ff0');
}
function updateUI(){
 UI.lvl.innerText=game.level;
 let hpTxt=Math.round(meta.hp)+"/"+game.stats.maxHp;if(game.timers.poison>0)hpTxt+=" [GIFT]";if(game.timers.burn>0)hpTxt+=" [FEUER]";if(game.timers.curse>0)hpTxt+=" [FLUCH]";UI.hp.innerText=hpTxt;
 UI.glitch.innerText=game.timers.glitch;UI.bits.innerText=meta.bits;UI.scrolls.innerText=meta.scrolls||0;UI.key.innerText=game.p.hasKey?"[KEY]":"";
 UI.mana.innerText=Math.floor(meta.mana)+"/"+game.stats.maxMana;UI.stam.innerText=Math.floor(meta.stam)+"/"+game.stats.maxStam;
 if(meta.stam<3||(game.p.hidden&&meta.stam<5))UI.stam.classList.add('stam-low');else UI.stam.classList.remove('stam-low');
 UI.cls.innerText=CLASSES[meta.class].n;
 let t=null,dist=999;game.enemies.forEach(e=>{let d=Math.abs(e.x-game.p.x)+Math.abs(e.y-game.p.y);if(d<=1.5&&d<dist){dist=d;t=e;}});
 if(t){UI.target.innerText=`ZIEL: ${t.name} (${t.hp}/${t.max} HP)`;UI.target.style.color=`hsl(${t.hue}, 60%, 50%)`;}else{UI.target.innerText="ZIEL: [Keines]";UI.target.style.color="#666";}
 let sBtn=$('btn-skill'),c=meta.class,cost=5,res=(c==='MAGE')?meta.mana:meta.stam;
 sBtn.setAttribute('data-t',`${(c==='WARRIOR')?"Wirbelwind":(c==='ROGUE')?"Unsichtbarkeit":"Feuerball"} (B)`);
 if(c==='ROGUE'){sBtn.style.borderColor=game.p.hidden?"#0f0":"#555";if(!game.p.hidden&&res<5)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 else if(c==='MAGE'){sBtn.style.borderColor=game.aiming?"#f0f":"#555";if(!game.aiming&&res<5)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 else{sBtn.style.borderColor="#555";if(res<cost)sBtn.classList.add('disabled');else sBtn.classList.remove('disabled');}
 let iBtn=$('btn-item');if(meta.scrolls>0)iBtn.classList.remove('disabled');else iBtn.classList.add('disabled');
}
function useConsumable(){
 if((meta.scrolls||0)<=0){sfx('hit');addParticle(game.p.x,game.p.y,"KEINE ROLLEN!",'#f00');return;}
 meta.scrolls--;sfx('glitch');addParticle(game.p.x,game.p.y,"BANNKREIS!",'#f60');let cnt=0;
 game.enemies.forEach(e=>{let d=Math.hypot(e.x-game.p.x,e.y-game.p.y);if(d<6){hurt(e,5,false,"GEBANNT",'#fff');e.stun=3;cnt++;}});
 if(cnt===0)addParticle(game.p.x,game.p.y,"NIEMAND DA...",'#777');game.p.energy-=100;updateUI();processTurns();
}
function useSkill(){
 let c=meta.class,cost=5,res=(c==='MAGE')?'mana':'stam';
 if(c==='ROGUE'){if(game.p.hidden){game.p.hidden=false;addParticle(game.p.x,game.p.y,"SICHTBAR",'#fff');}else{let cost=(game.stats.stealthCost||5);if(meta.stam<cost){addParticle(game.p.x,game.p.y,"ZU ERSCH√ñPFT!",'#555');return;}meta.stam-=cost;game.p.hidden=true;addParticle(game.p.x,game.p.y,"VERBORGEN",'#333');game.enemies.forEach(e=>{if(e.state==='HUNT')e.state='PATROL';});sfx('step');}updateUI();return;}
 if(meta[res]<cost){addParticle(game.p.x,game.p.y,"ZU ERSCH√ñPFT!",'#555');return;}
 let acted=false;
 if(c==='WARRIOR'){
  meta[res]-=cost;if(res==='stam')game.exert=1;sfx('attack');addParticle(game.p.x,game.p.y,"WIRBELWIND!",'#fff');
  for(let iy=-1;iy<=1;iy++)for(let ix=-1;ix<=1;ix++){if(ix===0&&iy===0)continue;let tx=game.p.x+ix,ty=game.p.y+iy,t=game.enemies.find(e=>e.x===tx&&e.y===ty||(e.isBoss&&Math.abs(e.x-tx)<=1&&Math.abs(e.y-ty)<=1));if(t){hurt(t,game.stats.dmg,false);let kx=t.x+ix,ky=t.y+iy;if(!isBlocked(kx,ky,t)&&!game.walls[ky*GRID+kx]){t.x=kx;t.y=ky;}}}acted=true;
 }else if(c==='MAGE'){game.aiming=!game.aiming;addParticle(game.p.x,game.p.y,game.aiming?"ZIELEN...":"ABBRUCH",'#f0f');updateUI();return;}
 if(acted){game.p.energy-=100;updateUI();processTurns();}
}
function inv_toggle(){let el=$('inv-screen');if(el.style.display==='block'){el.style.display='none';game.invMode=0;}else{game.invMode=0;invTab(invTabIdx);updateInvModeUI();renderInv();el.style.display='block';}}
function cycleInvMode(){game.invMode=(game.mode==='SHOP')?((game.invMode===0)?2:0):((game.invMode===0)?1:0);updateInvModeUI();}
function updateInvModeUI(){let btn=$('inv-mode-btn'),grid=$('inv-display');grid.className='inv-grid';if(game.invMode===0){btn.innerHTML="‚öîÔ∏è AUSR√úSTEN <span style='font-size:0.7em;opacity:0.6'>(Klick zum Wechseln)</span>";btn.style.color="#0f0";btn.style.borderColor="#0f0";btn.style.background="#0a1a0a";}else if(game.invMode===1){btn.innerHTML="üóëÔ∏è WEGWERFEN <span style='font-size:0.7em;opacity:0.6'>(Klick zum Wechseln)</span>";btn.style.color="#f00";btn.style.borderColor="#f00";btn.style.background="#1a0a0a";grid.classList.add('mode-trash');}else if(game.invMode===2){btn.innerHTML="üí∞ VERKAUFEN <span style='font-size:0.7em;opacity:0.6'>(Klick zum Wechseln)</span>";btn.style.color="#ffd700";btn.style.borderColor="#ffd700";btn.style.background="#1a1a0a";grid.classList.add('mode-sell');}}
let invTabIdx=0;
function invTab(i){invTabIdx=i;document.querySelectorAll('.inv-tab').forEach((t,j)=>t.classList.toggle('active',i===j));for(let j=0;j<4;j++){let el=$('inv-content-'+j);if(el)el.style.display=i===j?'block':'none';}if(i===1)renderGrim();if(i===2)renderAch();if(i===3){let d=$('inv-content-3');if(!d){d=document.createElement('div');d.id='inv-content-3';d.style.display='block';$('inv-screen').appendChild(d);}fetchLeaderboard();}}
function renderGrim(){let cnt=stats.grimoire.length,bk=stats.bossKills||0,h=`<div class="grim-count">MONSTER: ${cnt}/${GRIM_TOTAL} | BOSSE: ${bk}/${BOSSES.length}</div><div class="grim-grid">`;MONS.forEach(m=>{ADJ.forEach(a=>{let id=grimId(m,a),f=stats.grimoire.includes(id),ad=ADJ_DATA[a],bd=BESTIARY[m],st=bd.st,hp=((st[0]*10)|0),dmg=((st[1]*3)|0);h+=`<div class="grim-entry ${f?'found':'unseen'}" title="${f?`${a} ${bd.n}\nHP:~${hp} DMG:~${dmg}\nAI:${bd.ai}`:'???'}"><canvas width="32" height="32" class="grim-spr" style="width:16px;height:16px" data-m="${f?m:''}" data-c="${f?ad.col:'#222'}"></canvas><div style="color:${f?ad.col:'#333'};font-size:9px">${f?a:'?'}</div><div style="font-size:10px">${f?bd.n:'?'}</div></div>`;});});BOSSES.forEach((b,i)=>{let lvl=(i+1)*5,f=bk>i,c=b.col==='RAINBOW'?'#f0f':b.col;h+=`<div class="grim-entry ${f?'found':'unseen'}" title="${f?`${b.n} (Lvl ${lvl})\nHP:${b.hp} DMG:${b.dmg}\nTyp:${b.type}\n${b.desc}`:'??? (Lvl '+lvl+')'}"><canvas width="32" height="32" class="grim-spr" style="width:16px;height:16px" data-m="${f?'BOSS':''}" data-c="${f?c:'#222'}"></canvas><div style="color:${f?'#ffd700':'#333'};font-size:9px">${f?'BOSS':'?'}</div><div style="color:${f?c:'#333'};font-size:10px">${f?b.n:'???'}</div></div>`;});h+='</div>';$('inv-content-1').innerHTML=h;document.querySelectorAll('.grim-spr').forEach(c=>{let m=c.dataset.m,col=c.dataset.c;if(m)drawSprite(c.getContext('2d'),0,0,Math.random()*999|0,m,col);});}
function renderAch(){let done=ACHIEVEMENTS.filter(a=>stats.ach&(1<<a.id)).length,h=`<div class="ach-count">ERFOLGE: ${done}/${ACHIEVEMENTS.length}</div><div class="ach-list">`;ACHIEVEMENTS.forEach(a=>{let unlocked=stats.ach&(1<<a.id),v;if(a.k==='grimCount')v=stats.grimoire.length;else if(a.k==='biomesVisited'){let c=0;for(let i=0;i<10;i++)if(stats.biomesVisited&(1<<i))c++;v=c;}else v=stats[a.k];let prog=unlocked?'':`<div class="ach-prog">${Math.min(v,a.t)}/${a.t}</div>`;h+=`<div class="ach-item ${unlocked?'':'locked'}"><div class="ach-icon">${unlocked?a.i:'üîí'}</div><div class="ach-info"><div class="ach-name">${esc(a.n)}</div><div class="ach-desc">${esc(a.d)}</div>${prog}</div></div>`;});$('inv-content-2').innerHTML=h+'</div>';}
function renderInv(){
 let h='';['WEAPON','ARMOR','RELIC'].forEach(s=>{let it=game.equipment[s],st=it?`border-color:${it.rarityCol||'#333'};box-shadow:0 0 8px ${it.rarityCol||'#000'};`:'';h+=`<div class="inv-slot ${it?'equipped':''}" style="${st}" onclick="inv_unequip('${s}')"><div class="equip-slot-label">${s}</div>${it?`<div style="color:${it.col}">${esc(it.name)}</div>${renderMods(it)}`:'<span style="color:#333">LEER</span>'}</div>`;});$('equip-display').innerHTML=h;
 // Rucksack: Items + leere Slots als Grid
 let maxS=meta.invSlots||3,used=game.inventory.length;
 $('inv-slots-info').innerText=`RUCKSACK [${used}/${maxS}]`;
 h='';
 // Erst alle Items
 game.inventory.forEach((it,i)=>{
  let st=`border-color:${it.rarityCol||'#333'};box-shadow:0 0 5px ${it.rarityCol||'#000'};`;
  let cnt=it.count>1?`<div style="position:absolute;top:0;right:0;background:rgba(0,0,0,0.8);color:#fff;font-size:10px;padding:1px 3px;">x${it.count}</div>`:'';
  h+=`<div class="inv-slot" style="${st}" onclick="inv_action(${i})">${cnt}<div style="color:${it.col}">${esc(it.name)}</div>${renderMods(it)}</div>`;
 });
 // Dann leere Slots bis maxS
 for(let i=used;i<maxS;i++)h+=`<div class="inv-slot inv-empty" style="border-color:#2a2a2a;background:#080808"><span style="color:#222;font-size:1.5rem">¬∑</span></div>`;
 $('inv-display').innerHTML=h;
 document.querySelectorAll('.inv-slot').forEach(s=>{let tt=s.querySelector('.inv-tooltip');if(!tt)return;s.ontouchstart=e=>{s.th=setTimeout(()=>{tt.style.display='block'},500)};s.ontouchend=e=>{clearTimeout(s.th);tt.style.display=''};});
  // === PASSIV-SLOTS RENDERN ===
 renderPassiveSlots();
 renderUpgradePool();
}
function renderMods(it){
 let bonus='',m=meta.class;if(m===it.target)bonus=`<br><span style="color:#0f0">KLASSEN-BONUS!</span>`;
 let useMsg=(it.vis==='POTION')?`<br><span style="color:#0af">[Klick zum Trinken]</span>`:'';
 let modsHtml=Object.entries(it.mods).map(([k,v])=>`<span style="color:${(v>=0^(k==='noise'||k==='stamCost'))?'#0f0':'#f00'}">${k}: ${v}</span>`).join('<br>');
 return `<div class="inv-tooltip">WERT: ${it.val||0}<br>${modsHtml}${bonus}${useMsg}</div>`;
}
function inv_action(i){let it=game.inventory[i];if(!it)return;if(game.invMode===0){
 if(it.vis==='POTION'){
  let poolIt=ITEM_POOL.find(x=>x.name===it.name);
  if(poolIt){
   poolIt.run(meta,poolIt.calc(it.tier||{mul:1}));
   sfx('gulp');addParticle(game.p.x,game.p.y,"BENUTZT",'#0f0');
   if(it.count>1)it.count--; else game.inventory.splice(i,1);
   calcStats();updateUI();renderInv();return;
  }
 }
 let old=game.equipment[it.slot];if(old)game.inventory[i]=old;else game.inventory.splice(i,1);game.equipment[it.slot]=it;sfx('shop');calcStats();renderInv();}else if(game.invMode===1){game.inventory.splice(i,1);sfx('hit');addParticle(game.p.x,game.p.y,"M√úLL",'#888');renderInv();}else if(game.invMode===2){game.inventory.splice(i,1);meta.bits+=(it.val||0);sfx('shop');addParticle(game.p.x,game.p.y,`+${it.val||0} GOLD`,'#ffd700');updateUI();renderInv();}}
function inv_unequip(s){let it=game.equipment[s];if(!it)return;if(game.inventory.length<(meta.invSlots||10)){game.equipment[s]=null;game.inventory.push(it);sfx('shop');calcStats();renderInv();}else sfx('hit');}

function renderPassiveSlots(){
 let h='',maxSlots=meta.passiveSlots||3,equipped=meta.equippedPassives||[];
 for(let i=0;i<8;i++){
  let p=equipped[i];
  if(i<maxSlots){
   if(p){
    let tier=R_MAP[p.tierName]||{col:'#888'};
    let col=tier.col==='RAINBOW'?'#f0f':tier.col;
    h+=`<div class="passive-slot" style="border-color:${col}" onclick="unequipPassive(${i})" title="Klick zum Ablegen"><div style="color:${col};font-size:8px">${esc(p.tierName)}</div><div>${esc(p.name)}</div><div style="color:#0f0;font-size:8px">+${p.value} ${p.unit}</div></div>`;
   }else{
    h+=`<div class="passive-slot p-empty" title="Leerer Slot">[FREI]</div>`;
   }
  }else{
   h+=`<div class="passive-slot p-locked" title="Kaufe 'Passiv-Slot' im Shop">üîí</div>`;
  }
 }
 $('passive-display').innerHTML=h;
}

function renderUpgradePool(){
 let pool=meta.upgradePool||[],h='';
 if(pool.length===0){
  h='<div style="color:#444;font-size:9px;text-align:center">Keine Upgrades</div>';
 }else{
  pool.forEach((p,i)=>{
   let tier=R_MAP[p.tierName]||{col:'#888'};
   let col=tier.col==='RAINBOW'?'#f0f':tier.col;
   h+=`<div class="upgrade-item" onclick="equipPassive(${i})" style="border-color:${col}" title="Klick zum Ausr√ºsten"><span style="color:${col}">${esc(p.name)}</span><span style="color:#0f0">+${p.value}</span></div>`;
  });
 }
 $('upgrade-pool-display').innerHTML=h;
}

function equipPassive(poolIdx){
 let pool=meta.upgradePool||[];
 if(poolIdx<0||poolIdx>=pool.length)return;
 let equipped=meta.equippedPassives||[];
 let maxSlots=meta.passiveSlots||3;
 let freeSlot=-1;
 for(let i=0;i<maxSlots;i++){if(!equipped[i]){freeSlot=i;break;}}
 if(freeSlot===-1){addParticle(game.p.x,game.p.y,"SLOTS VOLL!",'#f00');sfx('hit');return;}
 let item=pool.splice(poolIdx,1)[0];
 equipped[freeSlot]=item;
 meta.equippedPassives=equipped;
 meta.upgradePool=pool;
 sfx('shop');addParticle(game.p.x,game.p.y,"AUSGER√úSTET!",'#0f0');
 calcStats();save();renderInv();
}

function unequipPassive(slotIdx){
 let equipped=meta.equippedPassives||[];
 if(slotIdx<0||!equipped[slotIdx])return;
 let item=equipped[slotIdx];
 equipped[slotIdx]=null;
 meta.upgradePool=meta.upgradePool||[];
 meta.upgradePool.push(item);
 while(equipped.length>0&&!equipped[equipped.length-1])equipped.pop();
 meta.equippedPassives=equipped;
 sfx('step');addParticle(game.p.x,game.p.y,"ABGELEGT",'#ff0');
 calcStats();save();renderInv();
}

function sfx(id){if(!actx)return;const t=actx.currentTime,o=actx.createOscillator(),g=actx.createGain();o.connect(g);g.connect(actx.destination);if(id==='step'){o.type='triangle';o.frequency.setValueAtTime(50,t);o.frequency.exponentialRampToValueAtTime(10,t+0.1);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}else if(id==='attack'){o.type='sawtooth';o.frequency.setValueAtTime(100,t);o.frequency.linearRampToValueAtTime(50,t+0.1);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1);}else if(id==='hit'){o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(10,t+0.3);g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.3);o.start(t);o.stop(t+0.3);}else if(id==='kill'){o.type='sine';o.frequency.setValueAtTime(440,t);o.frequency.exponentialRampToValueAtTime(880,t+0.2);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.4);o.start(t);o.stop(t+0.4);}else if(id==='shop'){o.type='triangle';o.frequency.setValueAtTime(600,t);g.gain.setValueAtTime(0.05,t);g.gain.exponentialRampToValueAtTime(0.001,t+1.0);o.start(t);o.stop(t+1.0);}else if(id==='glitch'){o.type='sawtooth';o.frequency.setValueAtTime(Math.random()*200+50,t);o.frequency.linearRampToValueAtTime(Math.random()*200+50,t+0.2);g.gain.setValueAtTime(0.1,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.2);o.start(t);o.stop(t+0.2);}else if(id==='gulp'){o.type='triangle';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(150,t+0.15);g.gain.setValueAtTime(0.2,t);g.gain.linearRampToValueAtTime(0,t+0.15);o.start(t);o.stop(t+0.15);}}
window.addEventListener('keydown',e=>{au();
 // Tutorial-Nachricht mit beliebiger Taste schlie√üen
 if(tutWaitForKey&&tutMsgTimer>0){dismissTutMsg();return;}
 if(game.timers.shake>0)return;if(game.mode==='GAME')inputGame(e);else if(game.mode==='SHOP')inputShop(e);});
function inputShop(e){
 // Shop-Tutorial beim ersten √ñffnen
 if(game.level===0&&!tutShownShop){tutShownShop=true;showTutMsg(TUT_HINTS.shop);return;}
 if(e.key==='i'){inv_toggle();return;}if(e.key==='r'){respawn();return;}if(e.key==='l'){game.lockMode=!game.lockMode;return;}if(e.key===' ')shopReroll();let k=parseInt(e.key);if(k>0&&k<=game.shopItems.length)shopAction(k-1);}
function shopReroll(){if(meta.bits>=game.rerollCost){sfx('shop');meta.bits-=game.rerollCost;game.rerollCost*=3;meta.lockedItems=game.shopItems.filter(i=>i.locked&&!i.purchased).map(i=>({itemName:i.item.name,tierName:i.tier.name,cost:i.cost}));generateShop();save();updateUI();}else game.timers.shake=5;}
function shopAction(i){
 let o=game.shopItems[i];
 if(!o||o.purchased)return;
 
 if(game.lockMode){
  if(o.locked){o.locked=false;sfx('step');addParticle(320,320,"ENTSPERRT",'#0ff');}
  else{
   let c=Math.max(1,(o.cost*0.1)|0);
   if(meta.bits>=c){sfx('step');meta.bits-=c;o.locked=true;addParticle(320,320,"GEMERKT",'#0ff');}
   else game.timers.shake=5;
  }
 }else if(!o.locked){
  if(meta.bits>=o.cost){
   sfx('shop');meta.bits-=o.cost;o.purchased=true;
   let v=o.item.calc(o.tier);
   
   // Struktur-Items (instant) sofort anwenden
   if(o.item.instant&&o.item.run){
    o.item.run(meta,v);
    addParticle(320,320,`+${v} ${o.item.unit}`,o.tier.col==='RAINBOW'?'#fff':o.tier.col);
   }else{
    // Passiv-Item: In upgradePool speichern
    meta.upgradePool=meta.upgradePool||[];
    meta.upgradePool.push({
     name:o.item.name,
     tierName:o.tier.name,
     tierId:o.tier.id||RARITIES.indexOf(o.tier),
     value:v,
     unit:o.item.unit,
     vis:o.item.vis
    });
    addParticle(320,320,"‚Üí UPGRADE-POOL",o.tier.col==='RAINBOW'?'#fff':o.tier.col);
   }
   
   game.timers.shake=3;
   calcStats();save();
  }else game.timers.shake=5;
 }else{
  addParticle(320,320,"GEMERKT! L dr√ºcken",'#0ff');
 }
 updateUI();
}
function inputGame(e){if(game.mode!=='GAME'||meta.hp<=0||game.lockInput)return;let dx=0,dy=0,acted=false;if(e.key==='i'){inv_toggle();return;}if(e.key.match(/w|ArrowUp/i))dy=-1;else if(e.key.match(/s|ArrowDown/i))dy=1;else if(e.key.match(/a|ArrowLeft/i))dx=-1;else if(e.key.match(/d|ArrowRight/i))dx=1;else if(e.key===' '){game.p.actNoise=0;acted=true;}else if(e.key.toLowerCase()==='b'){useSkill();return;}else if(e.key.toLowerCase()==='f'){useConsumable();return;}else return;if(dx!==0||dy!==0)acted=movePlayer(dx,dy);if(acted)endTurn();}
function act(c){au();if(game.timers.shake>0)return;if(game.mode==='SHOP'){if(c==='INV')inv_toggle();return;}if(game.aiming&&c!=='SKILL'){game.aiming=false;updateUI();}if(c==='U')movePlayer(0,-1)&&endTurn();if(c==='D')movePlayer(0,1)&&endTurn();if(c==='L')movePlayer(-1,0)&&endTurn();if(c==='R')movePlayer(1,0)&&endTurn();if(c==='WAIT'){game.p.actNoise=0;endTurn();}if(c==='SKILL')useSkill();if(c==='ITEM')useConsumable();if(c==='INV')inv_toggle();if(c==='HELP')showHelp();if(c==='ATK'){let d=game.p.dir;movePlayer(d.x,d.y)&&endTurn();}}
function endTurn(){game.p.energy-=100;game.turnCount++;if(game.turnCount>stats.maxTurns){stats.maxTurns=game.turnCount;checkAch();saveStats();}processTurns();return true;}
CVS.onclick=e=>{au();
 // Tutorial-Nachricht mit Klick/Tap schlie√üen
 if(tutWaitForKey&&tutMsgTimer>0){dismissTutMsg();return;}
 let rect=CVS.getBoundingClientRect();if(game.mode==='SHOP'){
 // Shop-Tutorial beim ersten √ñffnen
 if(game.level===0&&!tutShownShop){tutShownShop=true;showTutMsg(TUT_HINTS.shop);return;}
 let s=640/rect.height,x=(e.clientX-rect.left)*s,y=(e.clientY-rect.top)*s;if(y>=440&&y<476){if(x>=60&&x<320)shopReroll();else if(x>=340&&x<600)game.lockMode=!game.lockMode;}else{let i=Math.floor((y-108)/42);if(i>=0&&i<game.shopItems.length)shopAction(i);}return;}let tx=((e.clientX-rect.left)/(rect.width/GRID))|0,ty=((e.clientY-rect.top)/(rect.height/GRID))|0;if(game.aiming&&meta.class==='MAGE'){castFireball(tx,ty);return;}let t=game.enemies.find(en=>en.x===tx&&en.y===ty);if(t){let dx=tx-game.p.x,dy=ty-game.p.y;if(Math.abs(dx)+Math.abs(dy)===1){movePlayer(dx,dy)&&endTurn();}else stepTowards(tx,ty);}else stepTowards(tx,ty);};
function castFireball(tx,ty){if(meta.mana<5){addParticle(game.p.x,game.p.y,"KEIN MANA",'#0af');game.aiming=false;updateUI();return;}let dist=Math.hypot(tx-game.p.x,ty-game.p.y);if(dist>6){addParticle(game.p.x,game.p.y,"ZU WEIT!",'#f00');return;}if(!hasLOS(game.p.x,game.p.y,tx,ty)){addParticle(tx,ty,"BLOCKIERT",'#f00');return;}meta.mana-=5;sfx('glitch');game.aiming=false;updateUI();addHitFX(tx,ty,'burst','#f60');let t=game.enemies.find(e=>e.x===tx&&e.y===ty);if(t){hurt(t,game.stats.dmg*1.5+(game.stats.spellDmg||0)*3,false,null,null,true);if(t.hp>0)t.state='HUNT';}else addParticle(tx,ty,"BOOM!",'#f60');for(let sy=-1;sy<=1;sy++)for(let sx=-1;sx<=1;sx++){if(sx===0&&sy===0)continue;let st=game.enemies.find(e=>e.x===tx+sx&&e.y===ty+sy);if(st){hurt(st,Math.floor(game.stats.dmg),false,`SPLASH -${Math.floor(game.stats.dmg)}`,'#f60',true);}}game.p.energy-=100;processTurns();}
function hasLOS(x0,y0,x1,y1){let dx=Math.abs(x1-x0),dy=Math.abs(y1-y0),sx=(x0<x1)?1:-1,sy=(y0<y1)?1:-1,err=dx-dy;while(true){if(x0===x1&&y0===y1)return true;if(game.map[y0][x0]===1)return false;let e2=2*err;if(e2>-dy){err-=dy;x0+=sx;}if(e2<dx){err+=dx;y0+=sy;}}}
function stepTowards(tx,ty){let dx=Math.sign(tx-game.p.x),dy=Math.sign(ty-game.p.y);if(dx!==0&&dy!==0){if(Math.abs(tx-game.p.x)>Math.abs(ty-game.p.y))dy=0;else dx=0;}movePlayer(dx,dy)&&endTurn();}
document.onmousemove=e=>{let txt=e.target.dataset.t||'';if(e.target.id==='cvs'){let r=CVS.getBoundingClientRect(),s=640/r.height,mx=(e.clientX-r.left)*s,my=(e.clientY-r.top)*s;if(game.mode==='SHOP'){if(my>=440&&my<476){if(mx>=60&&mx<320)txt='Neues Angebot anfordern';else if(mx>=340&&mx<600)txt=game.lockMode?'AKTIV: Items gegen Geb√ºhr reservieren\n(auch bei Tausch oder Tod)':'Wechselt in Merkmodus\n(Items f√ºr 10% reservieren)';}else{let i=Math.floor((my-108)/42),o=game.shopItems[i];if(o){if(o.purchased)txt="Bereits gekauft";else{let v=o.item.calc(o.tier),eff=o.item.unit==='%'?`+${Math.round(v*100)}%`:`+${v} ${o.item.unit}`,desc=o.item.desc||'';txt=`${o.item.name} (${o.tier.name})\n${desc}\nEffekt: ${eff}\nPreis: ${o.cost} Gold`;if(o.locked)txt+='\n\n‚è∏ GEMERKT - Bleibt nach Tod!';}}}}else{let x=(mx/TILE)|0,y=(my/TILE)|0;game.mouse={x,y};let t=game.enemies.find(e=>e.x===x&&e.y===y),i=game.items.find(e=>e.x===x&&e.y===y),w=(x>=0&&x<GRID&&y>=0&&y<GRID)?game.walls[y*GRID+x]:0;if(t)txt=`${t.name}\nLeben: ${t.hp}/${t.max}\nSchaden: ${t.dmg}`;else if(i)txt=i.val?`${i.val.name}\n${Object.keys(i.val.mods).join(', ')}`:['Heiltrank','Manatrank','Goldtruhe','Bannkreis-Rolle'][i.type];else if(w>0)txt=`Mauer (H√§rte: ${(w|0)})`;else if(x===game.key.x&&y===game.key.y)txt='Schl√ºssel\nSammle ihn f√ºr den Ausgang!';else if(x===game.exit.x&&y===game.exit.y)txt=game.p.hasKey?'Ausgang (Offen)\nBetrete f√ºr n√§chste Ebene!':'Ausgang (Verschlossen)\nFinde zuerst den Schl√ºssel!';}}let el=$('tt');if(txt){el.style.display='block';el.style.left=(e.clientX+15)+'px';el.style.top=(e.clientY+15)+'px';el.innerText=txt;}else el.style.display='none';};
let ts;CVS.ontouchstart=e=>{ts={x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.cancelable)e.preventDefault();};
CVS.ontouchend=e=>{
 // Tutorial-Nachricht mit Tap schlie√üen
 if(tutWaitForKey&&tutMsgTimer>0){dismissTutMsg();return;}
 if(game.mode==='SHOP'){CVS.onclick({clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY});return;}let d=40,dx=e.changedTouches[0].clientX-ts.x,dy=e.changedTouches[0].clientY-ts.y;if(Math.abs(dx)>d||Math.abs(dy)>d)act(Math.abs(dx)>Math.abs(dy)?(dx>0?'R':'L'):(dy>0?'D':'U'));else CVS.onclick({clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY})};
</script>
</body>
</html>
